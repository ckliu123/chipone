#include "cts_core.h"
#include "cts_hal.h"

#ifndef PROJECT_ID
#error "PROJECT_ID UNDEFINED!"
#endif

#include "thp_ioctl.h"
#include "cts_log.h"
#include "cts_utils.h"
#include "cts_prog.h"
#include "cts_tcs.h"
#include "cts_spi.h"
#include "cts_tool.h"
#include "cts_tcs.h"
#include "thp_afe_hal.h"

//static int cnt = 0;
//#define DEBUG_NOISE

#define TCS_RET_CODE_OK                 0
#define TCS_CMD_VALUE                   0x4122

#define STYLUS_COL_AFTER_TIED           8
#define STYLUS_ROW_AFTER_TIED           12

#define STYLUS_PR_ITEM_SIZE             (COLS * STYLUS_ROW_AFTER_TIED)
#define STYLUS_PC_ITEM_SIZE             (ROWS * STYLUS_COL_AFTER_TIED)

#define STYLUS_PC1_ITEM_OFFSET          000
#define STYLUS_PC2_ITEM_OFFSET          200
#define STYLUS_PR1_ITEM_OFFSET          400
#define STYLUS_PR2_ITEM_OFFSET          600
#define STYLUS_PCR_TATAL_SIZE           800
#define RAW_DEST_DATA                   2500
#define STYLUS_FRAME_TV_ADJUST          3000//4167
#define MAGIC_NUMBER                    0xFEFCF8F0
#define DOUBLE_RATA                     0

static bool first_cali_done = false;

static THP_AFE_FRAME_DATA_STRUCT g_thp_frame;
static THP_AFE_STYLUS_FRAME_DATA_STRUCT g_stylus_frame;
static CTS_IOCTL_FRAME_STRUCT g_ioctl_frame;
uint16_t  g_version=0;
extern uint16_t s_scan_freq[MAX_NUM_SCAN_FREQ];
extern uint16_t s_scan_rate[MAX_NUM_SCAN_RATE];
extern uint16_t s_Fs_raw_dest_value;
uint16_t  last_afe_status=2;
uint16_t  last_stylus_status=0;
uint16_t  last_finger_freq=97;
uint16_t  last_Frame_index=0;
uint16_t  current_afe_data_type = FRAME_TYPE_FINGER_0;
uint16_t baserawdata[ROWS*COLS] = {0};

int nonblock = SCREEN_ON_FLAG;            //for screenon/screenoff
uint8_t  g_tcs_cmd[MAX_TCS_CMD_NUM] = {0};
static volatile bool g_esd_flag = false;
extern void cts_get_fwfile_version(uint16_t *getfileFwversion);
extern int cts_update_firmware(void);
static THP_AFE_INFO_STRUCT g_thp_info =
{
    VENDOR_NAME,
    PRODUCT_NAME,
    AFE_VERSION,
};

THP_AFE_INFO_STRUCT *cts_get_info(void)
{
    char buf[32];
    snprintf(buf, 32, "HAL%s_FW%04x", AFE_VERSION, g_version);
    MEMCPY(g_thp_info.version, buf, 32);
    CTS_THP_LOGI("%s[VENDOR_NAME], %s[PRODUCT_NAME], %s, build at %s %s",VENDOR_NAME, PRODUCT_NAME, g_thp_info.version, __TIME__, __DATE__);
    return &g_thp_info;
}

void cts_reset_device_hardware(void)
{
    CTS_THP_LOGD("Reset the device");
    thp_ioctl_reset(1);
    mdelay(1);
    thp_ioctl_reset(0);
    mdelay(5);   // min 20ms   safe 60ms
    thp_ioctl_reset(1);
    mdelay(90);      //2024/11/29 modified by mbteng// min 120ms   safe 150ms
}

void cts_reset_hal_buffer(void)
{
    //hal buffer clear
    thp_ioctl_clear_frame_buffer(1);
}

void cts_reset_device(void)
{
    // ic reset
    cts_reset_device_hardware();
    // hal buffer clear
    cts_reset_hal_buffer();
}

int wait_to_norm(uint16_t retryMax, uint16_t  time1msDelay)
{
    uint16_t i = 0;
    int ret;
    uint8_t work_mode;

    do
    {
        ret = cts_tcs_get_work_mode(&work_mode);

        CTS_THP_LOGI("Wait firmware to normal work mode=%d, retry times:%d",work_mode, i*10);

        if (ret == 0 && work_mode == CTS_FIRMWARE_WORK_MODE_NORM)
        {
            return 0;
        }
        else
        {
            CTS_THP_LOGD("Get firmware work mode failed, work_mode: %d", work_mode );
            ret = -1;
            mdelay(time1msDelay);
            continue;
        }
    }
    while ((++i) < retryMax);

    return ret;
}

int wait_to_curr_mode(uint16_t retryMax, uint16_t  time1msDelay)
{
    int i = 0;
    int ret;
    uint8_t curr_mode;

    do
    {
        CTS_THP_LOGI("Wait firmware to WORK_MODE_OPEN_SHORT work, times:%d", i*10);
        ret = cts_tcs_get_curr_mode(&curr_mode);
        if (ret == 0 && curr_mode == CTS_FIRMWARE_WORK_MODE_OPEN_SHORT)
        {
            return 0;
        }
        else
        {
            CTS_THP_LOGI("Get firmware work mode failed, curr_mode: %d", curr_mode);

            ret = -1;
            mdelay(time1msDelay);
            continue;
        }
    }
    while (++i < retryMax);

    return ret;
}

int wait_to_cfg_mode(void)
{
    int i = 0;
    int ret;
    uint8_t work_mode;

    do
    {
        CTS_THP_LOGI("Wait firmware to CTS_FIRMWARE_WORK_MODE_CFG work, times:%d", i);
        ret = cts_tcs_get_work_mode(&work_mode);
        if (ret == 0 && work_mode == CTS_FIRMWARE_WORK_MODE_CFG)
        {
            return 0;
        }
        else
        {
            CTS_THP_LOGE("Get firmware work mode failed, curr_mode: %d", work_mode);
            ret = -1;
            mdelay(10);
            continue;
        }
    }
    while (++i < 150);

    return ret;
}

int cts_NeedUpgradeCheck(void)
{
    int ret = -1;
    int needUpgradeFw = 0;
    uint16_t fw_ver = 0xFFFF;
    uint16_t getfileFwversion=0x00;

    cts_get_fwfile_version( &getfileFwversion );

    CTS_THP_LOGI("get_fw_ver before upgrade ");
    ret = cts_tcs_get_fw_ver(&fw_ver);
    if (ret < 0)
    {
        needUpgradeFw = 1;
        CTS_THP_LOGE("get_fw_ver failed.Do upgrade.needUpgradeFw=%d",needUpgradeFw);
        return needUpgradeFw;
    }
    else
    {
        g_version = fw_ver;
        CTS_THP_LOGI("get_current_fw_ver = 0x%x.", fw_ver);
        if (getfileFwversion == fw_ver)
        {
            CTS_THP_LOGI("0x%x[getFileFwVer] == 0x%x[current_fw_ver]. Do not upgrade.needUpgradeFw=%d", getfileFwversion,fw_ver,needUpgradeFw);
            return needUpgradeFw;
        }
        else
        {
            needUpgradeFw = 1;
            CTS_THP_LOGI("0x%x[getFileFwVer] != 0x%x[current_fw_ver]. Do upgrade.needUpgradeFw=%d", getfileFwversion,fw_ver,needUpgradeFw);
            return needUpgradeFw;
        }
    }
    return needUpgradeFw;
}

int cts_DoUpgrade(void)
{
    int ret = -1;
    uint16_t fw_ver = 0xFFFF;
    CTS_THP_LOGD("Set spi speed 12M--start");
    ret = cts_set_spi_speed(12000000);
    if (ret < 0)
    {
        CTS_THP_LOGI("Set spi speed failed");
    }

    ret = cts_update_firmware();
    if (ret < 0)
    {
        CTS_THP_LOGE("Update firmware failed");
        return -1;
    }

    CTS_THP_LOGE("Update firmware pass");

    CTS_THP_LOGD("Set spi speed 25M--start");
    ret = cts_set_spi_speed(25000000);
    mdelay(5);

    ret = cts_tcs_get_fw_ver(&fw_ver);
    if (ret < 0)
    {
        CTS_THP_LOGE("get_fw_ver failed");
    }
    else
    {
        CTS_THP_LOGI("get current fw ver = %x", fw_ver);
    }

    return 0;
}


static int cts_prework(void)
{
    int ret = -1;
#if  0
    int i;
    uint8_t value[16] = {0};
    CTS_THP_LOGE("0x791F0: read");
    ret = cts_tcs_read_hw_reg(0x791F0, value, sizeof(value));
    if (ret < 0)
    {
        CTS_THP_LOGE("0x791F0: readfailed");
    }

    for (i = 0; i < 16; i++)
    {
        CTS_THP_LOGE("[%2d]:%02x", i, value[i]);
    }

#endif

    cts_reset_device();

    if (cts_NeedUpgradeCheck())
    {
        ret = cts_DoUpgrade();
        if (ret < 0)
        {
            CTS_THP_LOGE("Update firmware failed");
            return -1;
        }

        ret = cts_force_get_hw_cap();
        if (ret < 0)
        {
            CTS_THP_LOGE("Get hw_cap failed");

            return -1;
        }
    }
    else
    {
        ret = cts_force_get_hw_cap();
        if (ret < 0)
        {
            CTS_THP_LOGE("Get hw_cap failed");
            return -1;
        }
    }

    // mdelay(5000);
    // cts_reset_device();
    return 0;
}

static int cts_postwork(void)
{
    CTS_THP_LOGE("WARN: Do post work??");

    cts_tcs_set_pwr_mode(2);

    return 0;
}

void cts_normal_mode_init(void)
{
    last_afe_status = THP_AFE_STATUS_ACTIVE_MODE ;
    last_stylus_status = 0;
    inspect_flag = INSPECT_NORMAL_FLAG;
    MEMSET(g_tcs_cmd,0,sizeof(g_tcs_cmd));
}

bool cts_switch_mode(uint8_t i)
{
    //CTS_THP_LOGI("clear level:0x%d", i);
    switch (i)
    {
        case TCS_ENTER_IDLE_LEVEL:
            cts_enter_idle();
            g_tcs_cmd[TCS_ENTER_IDLE_LEVEL] = 0;
            return true;//false;

        case  TCS_CLEAR_STATUS_CALIBRATE_DONE_LEVEL:
            cts_clear_status(THP_AFE_STATUS_CALIBRATION_DONE);
			first_cali_done = false;
            g_tcs_cmd[TCS_CLEAR_STATUS_CALIBRATE_DONE_LEVEL] = 0;
            return true;

        case TCS_CLEAR_STATUS_FREQ_SHIFT_LEVEL:
            cts_clear_status(THP_AFE_STATUS_FREQ_SHIFT_DONE);
            g_tcs_cmd[TCS_CLEAR_STATUS_FREQ_SHIFT_LEVEL] = 0;
            return true;

        default:
            CTS_THP_LOGI("INVALID VALUE: %{public}d", i);
            return true;
    }

}

void  tcs_cmd_delay_start(void)
{
    uint8_t i;
    for (i = 0; i <  MAX_TCS_CMD_NUM; i++)
    {
        if (g_tcs_cmd[i])
        {
            if ( cts_switch_mode(i) )
            {
                // CTS_THP_LOGI("cmd num : %d",i);
                break;
            }
        }
    }
}

static int cts_ioctl_get_frame(CTS_IOCTL_FRAME_STRUCT *ioctl_frame)
{
    int ret = -1;
    uint8_t *frame = ioctl_frame->frame;
    size_t framelen = sizeof(ioctl_frame->frame);
    struct timeval *tv = &ioctl_frame->tv;

    memset(ioctl_frame, 0, sizeof(*ioctl_frame));
    ret = thp_ioctl_get_frame(frame, framelen, tv);
    if (ret < 0)
    {
        CTS_THP_LOGE("Ioctl cts_get_frame failed: %s", strerror(errno));
        return -1;
    }
    ioctl_frame->framelen = framelen;

    return 0;
}

static int cts_check_ioctl_frame(CTS_IOCTL_FRAME_STRUCT *ioctl_frame)
{
    CTS_FRAME_STRUCT *cts_frame = (CTS_FRAME_STRUCT *)ioctl_frame->frame;
    tcs_rx_tail *cts_tcs_ret = (tcs_rx_tail *)
                               (ioctl_frame->frame + FRAME_SIZE);
    uint16_t crc16_calc;

    if (cts_frame->magic_number != MAGIC_NUMBER)
    {
        CTS_THP_LOGE("cts_get_frame Invalid magic number: recv %#010x calc %#010x",
                 cts_frame->magic_number, MAGIC_NUMBER);
        return -1;
    }

    if (cts_frame->curr_frame_size > FRAME_SIZE_HAS_TAIL  )
    {
        CTS_THP_LOGE("cts_get_frame Invalid current frame size: %d > %d",
                 cts_frame->curr_frame_size, FRAME_SIZE_HAS_TAIL);
        return -1;
    }

    if (cts_frame->curr_frame_size < CURRENT_FRAME_MIN_SIZ)
    {
        CTS_THP_LOGE("cts_get_frame Invalid current frame size: %d < ",
                 cts_frame->curr_frame_size, CURRENT_FRAME_MIN_SIZ);
        return -1;
    }

    //  if (cts_frame->next_frame_size > FRAME_SIZE_HAS_TAIL)
    // {
    //    CTS_THP_LOGE("cts_get_frame Invalid next frame size: %d", cts_frame->next_frame_size);
    //      return -1;
    //  }

    crc16_calc = cts_crc16((const uint8_t *)cts_frame,FRAME_SIZE_HAS_TAIL - sizeof(uint16_t));
    if (cts_tcs_ret->crc16 != crc16_calc)
    {
        CTS_THP_LOGE("cts_get_frame Invalid crc16: recv %#06x calc %#06x",
                 cts_tcs_ret->crc16, crc16_calc);
        return -1;
    }

    if (cts_tcs_ret->cmd != TCS_CMD_VALUE)
    {
        CTS_THP_LOGE("cts_get_frame Invalid cmd value: recv %#06x expect %#06x",
                 cts_tcs_ret->cmd, TCS_CMD_VALUE);
        return -1;
    }

    if (cts_tcs_ret->ecode != TCS_RET_CODE_OK)
    {
        CTS_THP_LOGE("cts_get_frame Invalid ret code: recv %d expect %d",
                 cts_tcs_ret->ecode, TCS_RET_CODE_OK);
        return -1;
    }
    return 0;
}

uint16_t FsCoffBuFreq2[ROWS*COLS] =
{
    304,305,306,307,308,309,311,312,313,314,315,316,318,319,320,321,323,324,325,326,328,329,330,332,333,334,336,337,338,340,341,342,
    306,307,308,309,311,312,313,314,315,316,318,319,320,321,323,324,325,326,328,329,330,332,333,334,336,337,338,340,341,342,344,345,
    308,309,311,312,313,314,315,316,318,319,320,321,323,324,325,326,328,329,330,332,333,334,336,337,338,340,341,342,344,345,347,348,
    311,312,313,314,315,316,318,319,320,321,323,324,325,326,328,329,330,332,333,334,336,337,338,340,341,342,344,345,347,348,350,351,
    313,314,315,316,318,319,320,321,323,324,325,326,328,329,330,332,333,334,336,337,338,340,341,342,344,345,347,348,350,351,352,354,
    315,316,318,319,320,321,323,324,325,326,328,329,330,332,333,334,336,337,338,340,341,342,344,345,347,348,350,351,352,354,355,357,
    318,319,320,321,323,324,325,326,328,329,330,332,333,334,336,337,338,340,341,342,344,345,347,348,350,351,352,354,355,357,358,360,
    320,321,323,324,325,326,328,329,330,332,333,334,336,337,338,340,341,342,344,345,347,348,350,351,352,354,355,357,358,360,362,363,
    323,324,325,326,328,329,330,332,333,334,336,337,338,340,341,342,344,345,347,348,350,351,352,354,355,357,358,360,362,363,365,366,
    325,326,328,329,330,332,333,334,336,337,338,340,341,342,344,345,347,348,350,351,352,354,355,357,358,360,362,363,365,366,368,370,
    328,329,330,332,333,334,336,337,338,340,341,342,344,345,347,348,350,351,352,354,355,357,358,360,362,363,365,366,368,370,371,373,
    330,332,333,334,336,337,338,340,341,342,344,345,347,348,350,351,352,354,355,357,358,360,362,363,365,366,368,370,371,373,375,376,
    333,334,336,337,338,340,341,342,344,345,347,348,350,351,352,354,355,357,358,360,362,363,365,366,368,370,371,373,375,376,378,380,
    336,337,338,340,341,342,344,345,347,348,350,351,352,354,355,357,358,360,362,363,365,366,368,370,371,373,375,376,378,380,381,383,
    338,340,341,342,344,345,347,348,350,351,352,354,355,357,358,360,362,363,365,366,368,370,371,373,375,376,378,380,381,383,385,387,
    341,342,344,345,347,348,350,351,352,354,355,357,358,360,362,363,365,366,368,370,371,373,375,376,378,380,381,383,385,387,388,390,
    344,345,347,348,350,351,352,354,355,357,358,360,362,363,365,366,368,370,371,373,375,376,378,380,381,383,385,387,388,390,392,394,
    347,348,350,351,352,354,355,357,358,360,362,363,365,366,368,370,371,373,375,376,378,380,381,383,385,387,388,390,392,394,396,398,
    350,351,352,354,355,357,358,360,362,363,365,366,368,370,371,373,375,376,378,380,381,383,385,387,388,390,392,394,396,398,400,401,
    352,354,355,357,358,360,362,363,365,366,368,370,371,373,375,376,378,380,381,383,385,387,388,390,392,394,396,398,400,401,403,405,
    355,357,358,360,362,363,365,366,368,370,371,373,375,376,378,380,381,383,385,387,388,390,392,394,396,398,400,401,403,405,407,409,
    358,360,362,363,365,366,368,370,371,373,375,376,378,380,381,383,385,387,388,390,392,394,396,398,400,401,403,405,407,409,411,413,
    362,363,365,366,368,370,371,373,375,376,378,380,381,383,385,387,388,390,392,394,396,398,400,401,403,405,407,409,411,413,415,417,
    365,366,368,370,371,373,375,376,378,380,381,383,385,387,388,390,392,394,396,398,400,401,403,405,407,409,411,413,415,417,420,422,
    368,370,371,373,375,376,378,380,381,383,385,387,388,390,392,394,396,398,400,401,403,405,407,409,411,413,415,417,420,422,424,426,
    371,373,375,376,378,380,381,383,385,387,388,390,392,394,396,398,400,401,403,405,407,409,411,413,415,417,420,422,424,426,428,430,
    375,376,378,380,381,383,385,387,388,390,392,394,396,398,400,401,403,405,407,409,411,413,415,417,420,422,424,426,428,430,432,435,
    378,380,381,383,385,387,388,390,392,394,396,398,400,401,403,405,407,409,411,413,415,417,420,422,424,426,428,430,432,435,437,439,
    381,383,385,387,388,390,392,394,396,398,400,401,403,405,407,409,411,413,415,417,420,422,424,426,428,430,432,435,437,439,442,444,
    385,387,388,390,392,394,396,398,400,401,403,405,407,409,411,413,415,417,420,422,424,426,428,430,432,435,437,439,442,444,446,449,
    388,390,392,394,396,398,400,401,403,405,407,409,411,413,415,417,420,422,424,426,428,430,432,435,437,439,442,444,446,449,451,454,
    392,394,396,398,400,401,403,405,407,409,411,413,415,417,420,422,424,426,428,430,432,435,437,439,442,444,446,449,451,454,456,459,
    396,398,400,401,403,405,407,409,411,413,415,417,420,422,424,426,428,430,432,435,437,439,442,444,446,449,451,454,456,459,461,464,
    400,401,403,405,407,409,411,413,415,417,420,422,424,426,428,430,432,435,437,439,442,444,446,449,451,454,456,459,461,464,466,469,
    403,405,407,409,411,413,415,417,420,422,424,426,428,430,432,435,437,439,442,444,446,449,451,454,456,459,461,464,466,469,471,474,
    407,409,411,413,415,417,420,422,424,426,428,430,432,435,437,439,442,444,446,449,451,454,456,459,461,464,466,469,471,474,477,480,
    411,413,415,417,420,422,424,426,428,430,432,435,437,439,442,444,446,449,451,454,456,459,461,464,466,469,471,474,477,480,482,485,
    415,417,420,422,424,426,428,430,432,435,437,439,442,444,446,449,451,454,456,459,461,464,466,469,471,474,477,480,482,485,488,491,
    420,422,424,426,428,430,432,435,437,439,442,444,446,449,451,454,456,459,461,464,466,469,471,474,477,480,482,485,488,491,494,497,
    424,426,428,430,432,435,437,439,442,444,446,449,451,454,456,459,461,464,466,469,471,474,477,480,482,485,488,491,494,497,500,502,
    428,430,432,435,437,439,442,444,446,449,451,454,456,459,461,464,466,469,471,474,477,480,482,485,488,491,494,497,500,502,506,509,
    432,435,437,439,442,444,446,449,451,454,456,459,461,464,466,469,471,474,477,480,482,485,488,491,494,497,500,502,506,509,512,515,
    437,439,442,444,446,449,451,454,456,459,461,464,466,469,471,474,477,480,482,485,488,491,494,497,500,502,506,509,512,515,518,521,
    442,444,446,449,451,454,456,459,461,464,466,469,471,474,477,480,482,485,488,491,494,497,500,502,506,509,512,515,518,521,525,528,
    446,449,451,454,456,459,461,464,466,469,471,474,477,480,482,485,488,491,494,497,500,502,506,509,512,515,518,521,525,528,531,535,
    451,454,456,459,461,464,466,469,471,474,477,480,482,485,488,491,494,497,500,502,506,509,512,515,518,521,525,528,531,535,538,541,
    456,459,461,464,466,469,471,474,477,480,482,485,488,491,494,497,500,502,506,509,512,515,518,521,525,528,531,535,538,541,545,549,
    461,464,466,469,471,474,477,480,482,485,488,491,494,497,500,502,506,509,512,515,518,521,525,528,531,535,538,541,545,549,552,556,
};

uint16_t FsCoffBuFreq1[ROWS*COLS] =
{
    240,241,242,243,243,244,245,245,246,247,248,248,249,250,251,251,252,253,254,255,255,256,257,258,259,259,260,261,262,263,264,264,
    242,243,243,244,245,245,246,247,248,248,249,250,251,251,252,253,254,255,255,256,257,258,259,259,260,261,262,263,264,264,265,266,
    243,244,245,245,246,247,248,248,249,250,251,251,252,253,254,255,255,256,257,258,259,259,260,261,262,263,264,264,265,266,267,268,
    245,245,246,247,248,248,249,250,251,251,252,253,254,255,255,256,257,258,259,259,260,261,262,263,264,264,265,266,267,268,269,270,
    246,247,248,248,249,250,251,251,252,253,254,255,255,256,257,258,259,259,260,261,262,263,264,264,265,266,267,268,269,270,270,271,
    248,248,249,250,251,251,252,253,254,255,255,256,257,258,259,259,260,261,262,263,264,264,265,266,267,268,269,270,270,271,272,273,
    249,250,251,251,252,253,254,255,255,256,257,258,259,259,260,261,262,263,264,264,265,266,267,268,269,270,270,271,272,273,274,275,
    251,251,252,253,254,255,255,256,257,258,259,259,260,261,262,263,264,264,265,266,267,268,269,270,270,271,272,273,274,275,276,277,
    252,253,254,255,255,256,257,258,259,259,260,261,262,263,264,264,265,266,267,268,269,270,270,271,272,273,274,275,276,277,278,279,
    254,255,255,256,257,258,259,259,260,261,262,263,264,264,265,266,267,268,269,270,270,271,272,273,274,275,276,277,278,279,280,281,
    255,256,257,258,259,259,260,261,262,263,264,264,265,266,267,268,269,270,270,271,272,273,274,275,276,277,278,279,280,281,282,283,
    257,258,259,259,260,261,262,263,264,264,265,266,267,268,269,270,270,271,272,273,274,275,276,277,278,279,280,281,282,283,283,284,
    259,259,260,261,262,263,264,264,265,266,267,268,269,270,270,271,272,273,274,275,276,277,278,279,280,281,282,283,283,284,285,286,
    260,261,262,263,264,264,265,266,267,268,269,270,270,271,272,273,274,275,276,277,278,279,280,281,282,283,283,284,285,286,287,288,
    262,263,264,264,265,266,267,268,269,270,270,271,272,273,274,275,276,277,278,279,280,281,282,283,283,284,285,286,287,288,289,291,
    264,264,265,266,267,268,269,270,270,271,272,273,274,275,276,277,278,279,280,281,282,283,283,284,285,286,287,288,289,291,292,293,
    265,266,267,268,269,270,270,271,272,273,274,275,276,277,278,279,280,281,282,283,283,284,285,286,287,288,289,291,292,293,294,295,
    267,268,269,270,270,271,272,273,274,275,276,277,278,279,280,281,282,283,283,284,285,286,287,288,289,291,292,293,294,295,296,297,
    269,270,270,271,272,273,274,275,276,277,278,279,280,281,282,283,283,284,285,286,287,288,289,291,292,293,294,295,296,297,298,299,
    270,271,272,273,274,275,276,277,278,279,280,281,282,283,283,284,285,286,287,288,289,291,292,293,294,295,296,297,298,299,300,301,
    272,273,274,275,276,277,278,279,280,281,282,283,283,284,285,286,287,288,289,291,292,293,294,295,296,297,298,299,300,301,302,303,
    274,275,276,277,278,279,280,281,282,283,283,284,285,286,287,288,289,291,292,293,294,295,296,297,298,299,300,301,302,303,304,306,
    276,277,278,279,280,281,282,283,283,284,285,286,287,288,289,291,292,293,294,295,296,297,298,299,300,301,302,303,304,306,307,308,
    278,279,280,281,282,283,283,284,285,286,287,288,289,291,292,293,294,295,296,297,298,299,300,301,302,303,304,306,307,308,309,310,
    280,281,282,283,283,284,285,286,287,288,289,291,292,293,294,295,296,297,298,299,300,301,302,303,304,306,307,308,309,310,311,313,
    282,283,283,284,285,286,287,288,289,291,292,293,294,295,296,297,298,299,300,301,302,303,304,306,307,308,309,310,311,313,314,315,
    283,284,285,286,287,288,289,291,292,293,294,295,296,297,298,299,300,301,302,303,304,306,307,308,309,310,311,313,314,315,316,317,
    285,286,287,288,289,291,292,293,294,295,296,297,298,299,300,301,302,303,304,306,307,308,309,310,311,313,314,315,316,317,319,320,
    287,288,289,291,292,293,294,295,296,297,298,299,300,301,302,303,304,306,307,308,309,310,311,313,314,315,316,317,319,320,321,322,
    289,291,292,293,294,295,296,297,298,299,300,301,302,303,304,306,307,308,309,310,311,313,314,315,316,317,319,320,321,322,324,325,
    292,293,294,295,296,297,298,299,300,301,302,303,304,306,307,308,309,310,311,313,314,315,316,317,319,320,321,322,324,325,326,328,
    294,295,296,297,298,299,300,301,302,303,304,306,307,308,309,310,311,313,314,315,316,317,319,320,321,322,324,325,326,328,329,330,
    296,297,298,299,300,301,302,303,304,306,307,308,309,310,311,313,314,315,316,317,319,320,321,322,324,325,326,328,329,330,331,333,
    298,299,300,301,302,303,304,306,307,308,309,310,311,313,314,315,316,317,319,320,321,322,324,325,326,328,329,330,331,333,334,336,
    300,301,302,303,304,306,307,308,309,310,311,313,314,315,316,317,319,320,321,322,324,325,326,328,329,330,331,333,334,336,337,338,
    302,303,304,306,307,308,309,310,311,313,314,315,316,317,319,320,321,322,324,325,326,328,329,330,331,333,334,336,337,338,340,341,
    304,306,307,308,309,310,311,313,314,315,316,317,319,320,321,322,324,325,326,328,329,330,331,333,334,336,337,338,340,341,343,344,
    307,308,309,310,311,313,314,315,316,317,319,320,321,322,324,325,326,328,329,330,331,333,334,336,337,338,340,341,343,344,345,347,
    309,310,311,313,314,315,316,317,319,320,321,322,324,325,326,328,329,330,331,333,334,336,337,338,340,341,343,344,345,347,348,350,
    311,313,314,315,316,317,319,320,321,322,324,325,326,328,329,330,331,333,334,336,337,338,340,341,343,344,345,347,348,350,351,353,
    314,315,316,317,319,320,321,322,324,325,326,328,329,330,331,333,334,336,337,338,340,341,343,344,345,347,348,350,351,353,354,356,
    316,317,319,320,321,322,324,325,326,328,329,330,331,333,334,336,337,338,340,341,343,344,345,347,348,350,351,353,354,356,357,359,
    319,320,321,322,324,325,326,328,329,330,331,333,334,336,337,338,340,341,343,344,345,347,348,350,351,353,354,356,357,359,361,362,
    321,322,324,325,326,328,329,330,331,333,334,336,337,338,340,341,343,344,345,347,348,350,351,353,354,356,357,359,361,362,364,365,
    324,325,326,328,329,330,331,333,334,336,337,338,340,341,343,344,345,347,348,350,351,353,354,356,357,359,361,362,364,365,367,369,
    326,328,329,330,331,333,334,336,337,338,340,341,343,344,345,347,348,350,351,353,354,356,357,359,361,362,364,365,367,369,370,372,
    329,330,331,333,334,336,337,338,340,341,343,344,345,347,348,350,351,353,354,356,357,359,361,362,364,365,367,369,370,372,374,375,
    331,333,334,336,337,338,340,341,343,344,345,347,348,350,351,353,354,356,357,359,361,362,364,365,367,369,370,372,374,375,377,379,
};

#if 0
uint16_t FsCoffBuFreq0[ROWS*COLS] =
{
	254,255,243,246,246,257,251,251,253,246,258,265,267,267,270,269,275,291,294,301,293,288,288,279,270,265,264,252,250,251,248,251,251,249,255,249,252,259,273,282,
	244,257,254,248,244,244,242,242,241,238,235,238,238,242,246,254,262,272,276,286,267,265,261,253,252,251,248,242,238,238,229,233,234,233,243,249,260,262,267,272,
	238,249,248,240,233,247,242,238,238,234,255,260,263,269,273,256,265,266,269,280,280,267,269,266,256,234,226,225,213,222,227,230,233,234,243,239,245,250,258,262,
	243,253,250,245,241,245,242,242,240,237,243,249,249,257,260,266,274,275,279,292,269,264,261,252,252,248,245,238,232,235,228,231,230,232,245,254,258,265,271,275,
	233,252,238,238,232,232,224,225,225,226,258,266,268,275,279,262,268,270,272,281,266,267,261,252,254,232,233,228,223,225,234,236,238,238,249,254,258,264,272,278,
	243,254,250,245,242,239,236,236,235,231,223,229,233,240,243,263,266,274,275,284,274,268,263,255,254,247,242,237,231,233,223,230,238,231,238,245,252,259,270,276,
	252,256,251,244,242,229,227,231,225,227,248,255,259,263,267,278,284,289,290,299,292,281,271,273,268,240,240,239,230,228,236,240,243,245,252,262,267,274,283,289,
	247,256,252,249,243,253,251,249,248,245,242,249,253,258,266,281,286,288,294,303,287,280,275,268,266,257,253,247,242,242,241,244,247,250,256,262,269,275,283,295,
	241,256,243,238,237,230,228,232,226,223,242,248,253,258,262,282,287,291,296,301,277,271,270,263,261,256,251,247,241,240,232,235,238,240,245,260,267,273,284,293,
	256,269,266,262,257,243,242,242,241,238,231,242,242,249,251,277,281,282,285,291,280,273,267,261,258,246,244,239,234,233,237,243,248,248,251,256,258,270,278,287,
	258,269,266,262,260,234,233,234,235,233,232,239,242,249,251,280,287,288,291,299,276,271,271,258,256,252,248,248,237,236,240,243,247,248,253,251,257,265,274,280,
	254,266,263,260,255,241,240,239,238,238,254,261,265,270,273,268,279,279,283,293,289,284,278,271,269,262,259,253,247,248,247,251,258,258,261,259,265,273,281,292,
	253,261,262,257,253,248,241,240,248,240,238,243,247,252,257,272,281,281,284,294,271,267,263,253,249,264,252,246,247,245,240,245,247,248,251,261,268,275,284,297,
	249,260,256,254,248,241,240,241,239,236,256,260,265,273,278,266,280,281,284,291,280,273,269,261,258,257,255,251,243,244,237,246,247,248,250,252,258,267,275,288,
	249,258,253,256,244,233,234,232,236,228,250,256,261,266,269,287,295,295,300,308,311,309,295,282,290,261,261,249,241,246,242,251,254,253,257,255,261,268,276,287,
	265,279,273,271,267,250,248,247,245,243,253,261,263,268,272,292,297,300,307,315,301,296,290,283,280,267,262,258,252,249,248,260,262,264,265,277,280,291,298,315,
	259,268,262,260,257,254,253,253,251,249,246,253,256,263,270,299,299,299,302,316,296,293,283,278,272,256,251,247,242,241,236,244,242,244,247,263,269,274,286,293,
	239,252,245,247,242,263,254,249,248,249,252,258,263,271,273,285,289,288,294,303,284,279,269,268,259,262,253,246,243,246,249,256,260,261,263,260,266,272,280,292,
	261,273,267,265,261,257,253,254,252,248,250,252,258,266,270,287,292,293,296,303,306,299,291,288,283,270,265,261,255,255,254,263,268,267,269,266,275,282,290,299,
	257,264,263,262,250,245,235,238,237,233,261,266,270,277,280,277,284,285,289,300,284,281,275,273,263,254,245,247,238,237,253,257,261,262,263,276,283,291,299,309,
	265,277,270,269,263,265,260,263,260,258,248,254,255,263,267,292,296,298,303,314,289,285,277,271,265,279,276,272,267,266,244,252,253,256,253,267,275,283,289,303,
	267,281,272,269,267,240,236,240,237,238,262,267,273,281,283,317,323,323,326,338,289,281,277,274,266,254,256,247,241,245,249,256,259,259,261,283,290,297,308,315,
	267,278,272,268,264,255,255,255,252,250,244,249,253,264,264,282,290,295,295,306,296,289,281,277,271,274,276,266,260,261,254,257,261,263,265,258,266,275,282,291,
	262,275,268,267,259,245,241,240,236,237,262,267,270,279,283,297,304,305,308,317,282,270,263,262,253,263,264,250,244,244,272,278,280,281,282,276,282,292,299,308,
	271,281,275,272,267,255,252,251,250,245,252,260,262,271,275,301,310,310,310,329,307,301,293,286,282,265,264,256,249,247,260,267,270,268,270,270,277,287,294,302,
	259,270,264,258,254,248,246,245,244,241,261,269,272,280,282,309,316,315,316,332,285,282,273,265,258,264,263,253,246,242,257,264,268,266,268,271,275,285,293,303,
	266,279,271,270,265,249,247,246,242,241,250,257,264,272,271,285,295,295,300,310,295,289,280,272,269,262,260,253,247,245,251,254,257,257,261,267,269,278,286,293,
	264,283,271,270,265,238,237,241,236,239,256,262,267,275,276,297,303,303,305,316,306,297,283,279,272,269,265,259,252,248,264,269,270,272,273,279,286,294,304,311,
	273,283,277,275,269,259,257,255,252,247,264,270,275,282,286,300,307,304,316,320,302,296,289,278,275,278,276,268,263,257,247,254,257,259,256,280,287,295,300,306,
	266,278,276,269,265,246,244,246,243,237,276,281,286,294,297,294,301,301,306,316,305,288,287,282,278,270,268,257,252,245,255,264,265,267,268,275,281,290,295,305,
	273,282,277,276,269,265,260,260,257,253,266,273,276,282,289,298,308,306,315,329,297,289,281,276,272,272,269,264,259,254,251,256,258,262,265,273,275,284,294,299,
	272,273,277,275,269,262,257,258,255,252,261,266,274,282,283,313,332,325,335,342,311,298,293,286,278,272,269,262,255,248,263,269,271,272,275,288,293,302,312,320,
	262,268,273,267,264,258,260,253,254,250,270,275,280,288,290,299,310,311,313,324,290,287,279,269,267,264,262,255,248,246,270,276,279,280,282,275,280,287,296,304,
	273,267,273,273,268,273,270,270,266,262,272,278,285,290,293,308,321,321,323,335,304,295,284,280,274,283,281,275,271,262,250,258,259,267,266,274,281,290,296,307,
	268,265,274,266,261,266,263,262,258,260,275,280,285,292,294,298,311,310,315,321,318,304,304,294,287,275,272,268,260,255,274,281,282,282,285,283,289,299,306,316,
	284,280,287,284,277,267,262,263,260,255,267,275,284,286,288,300,314,313,313,325,299,289,283,279,273,283,278,272,266,259,258,267,270,271,273,278,289,298,305,314,
	274,270,277,273,265,264,261,259,256,252,270,276,280,287,289,326,340,338,344,354,300,291,283,278,268,274,267,264,251,247,259,266,269,270,272,278,284,294,301,311,
	299,294,301,298,292,260,256,255,252,250,261,269,274,279,280,320,332,331,336,340,319,309,301,295,287,277,273,266,263,257,260,269,272,271,271,284,288,297,300,317,
	269,266,270,269,259,261,258,258,253,256,296,300,304,311,310,310,323,323,328,333,300,299,290,281,277,272,269,265,257,252,262,266,270,271,273,284,289,296,308,316,
	272,269,275,273,267,261,256,255,251,248,280,285,288,290,291,296,313,308,314,322,326,317,305,298,292,288,283,278,271,265,254,258,260,260,262,265,269,279,289,297,
	281,280,284,285,274,264,257,258,248,247,275,278,282,288,291,312,324,325,329,335,310,303,295,291,281,279,278,269,252,254,265,270,273,275,274,283,289,296,309,320,
	275,273,279,274,267,283,280,278,273,270,270,274,278,283,288,314,324,330,331,333,312,305,295,286,279,276,271,265,259,257,265,270,270,273,273,291,298,303,317,328,
	266,265,272,266,259,264,258,261,256,246,278,283,285,288,293,313,323,324,328,334,311,297,292,286,277,267,256,249,248,245,264,270,273,273,275,294,299,303,316,328,
	296,294,299,298,290,275,269,268,264,258,300,305,309,312,314,304,315,312,319,328,329,318,311,303,297,294,287,284,277,269,266,273,276,275,279,283,285,289,304,311,
	288,291,294,288,279,269,257,263,255,258,292,298,301,305,309,311,323,321,326,332,293,296,282,278,270,279,278,271,265,252,277,284,286,286,288,289,296,301,313,323,
	292,290,296,291,286,285,278,276,272,271,285,291,299,294,303,305,317,320,321,331,318,311,301,294,285,289,282,278,273,269,272,277,281,282,282,296,302,307,317,330,
	290,285,290,286,280,275,270,270,266,262,299,303,311,315,322,312,321,323,330,331,314,308,299,291,284,290,283,279,273,267,264,274,273,275,282,293,300,311,323,331,
	277,275,277,278,265,266,258,264,256,254,286,292,296,299,298,305,317,316,313,323,308,295,289,284,275,258,249,252,246,242,269,275,279,279,280,296,299,306,320,328,
	280,281,283,280,273,276,270,271,265,264,285,292,299,296,300,318,332,329,329,336,326,321,311,303,295,287,280,276,273,266,278,285,289,291,289,318,326,331,341,347,
	284,280,282,284,276,265,258,254,251,246,296,303,308,308,312,320,332,331,335,340,307,300,288,281,276,280,272,271,270,260,280,285,288,287,292,289,295,299,312,317,
	289,290,294,291,282,272,264,267,264,261,290,298,299,299,309,306,314,320,323,321,300,297,289,280,271,297,290,287,282,273,269,271,276,276,277,296,299,303,313,321,
	289,280,286,287,277,268,266,267,261,258,289,295,300,300,302,315,326,323,327,331,317,311,299,294,284,264,257,252,250,241,279,285,286,286,289,313,318,321,335,342,
	290,287,294,289,280,285,280,278,275,272,286,295,298,299,303,298,306,305,306,315,306,301,292,284,276,272,267,260,256,251,273,278,283,281,284,296,302,310,321,324,
	274,272,279,276,268,265,258,262,255,252,285,291,294,292,298,325,335,336,337,345,313,299,296,284,275,287,276,272,264,266,273,277,280,280,285,292,300,305,312,316,
	291,290,298,291,280,273,266,267,262,260,292,300,304,301,307,312,321,328,325,331,317,310,305,295,286,280,272,268,265,258,275,281,282,282,284,289,297,303,309,316,
	283,276,285,277,266,279,274,273,264,262,285,292,293,293,299,335,342,344,344,350,314,310,304,297,286,264,263,261,249,244,276,281,285,284,289,304,310,318,324,323,
	290,285,291,286,280,273,264,265,260,259,287,290,297,295,301,332,338,341,337,347,325,320,308,303,290,284,275,271,266,264,275,276,281,280,280,313,318,325,329,331,
	271,268,277,269,263,267,262,263,257,262,301,308,311,311,315,334,340,346,342,350,321,316,304,299,286,278,273,272,268,267,285,287,292,291,295,301,309,316,320,321,
	294,291,298,291,284,296,289,292,286,285,298,306,306,305,308,339,343,350,349,354,328,322,310,306,294,285,279,276,269,266,282,287,288,289,292,302,309,318,322,322,
	277,276,284,278,272,272,259,265,266,265,297,302,307,304,306,323,330,335,328,332,323,317,307,301,288,287,277,275,264,264,275,281,286,286,289,315,321,330,332,332,
	311,305,306,300,295,283,276,276,275,269,293,303,306,307,312,311,316,324,326,330,339,328,323,316,308,287,282,280,275,275,280,286,290,286,293,314,317,321,328,337,
};
#endif

#if 1
uint16_t FsCoffBuFreq0[ROWS*COLS] = 
{
/* double ok
	261,254,241,243,238,214,213,212,210,206,209,214,217,217,223,241,250,258,266,276,241,242,232,229,222,215,211,211,210,201,215,218,219,219,223,225,232,240,259,272,
	266,264,263,255,254,254,247,246,243,235,224,229,229,234,241,233,241,249,258,269,250,246,242,236,231,218,212,212,208,206,213,220,221,232,234,244,245,254,263,273,
	250,241,240,230,237,218,219,216,213,209,218,221,224,227,232,230,239,247,256,261,230,220,215,215,208,203,197,200,196,196,197,206,206,210,212,223,229,270,245,258,
	256,245,239,235,235,238,232,230,225,215,204,209,210,213,219,231,237,252,254,258,236,221,220,217,213,207,203,207,204,201,204,208,213,215,220,227,242,239,271,256,
	247,234,227,223,214,222,228,225,219,214,213,214,227,221,233,222,238,234,237,247,229,222,222,223,214,208,205,206,203,205,207,215,212,216,221,287,230,214,250,268,
	273,259,250,246,239,227,229,227,221,218,200,201,209,209,213,226,246,235,246,253,243,223,221,220,215,210,206,209,213,206,209,213,222,222,215,246,211,241,236,255,
	257,249,242,230,222,220,217,223,217,215,209,209,218,217,222,238,245,253,266,262,241,225,225,230,215,214,210,209,206,215,207,221,219,218,251,227,213,243,239,259,
	263,250,246,238,230,224,221,223,224,219,204,211,211,214,220,232,236,241,246,256,237,225,226,231,213,214,207,213,213,206,214,225,221,250,235,202,233,246,247,270,
	249,236,231,231,218,218,213,214,215,216,240,240,246,251,253,247,252,258,261,268,231,226,229,230,222,217,211,227,222,213,215,226,215,274,218,196,242,251,248,271,
	268,253,247,248,236,224,222,222,227,222,223,230,233,236,245,243,251,255,259,267,244,227,225,231,225,221,225,237,234,237,229,220,278,217,219,231,246,251,245,269,
	271,259,252,260,251,222,218,221,219,221,225,221,229,232,239,243,253,256,261,265,232,230,236,233,234,229,232,230,236,240,218,214,215,186,220,238,251,247,244,265,
	282,262,258,260,254,227,217,219,218,215,221,220,227,230,233,251,263,271,271,274,260,230,231,243,234,232,229,245,240,242,209,246,215,192,226,245,253,251,244,265,
	262,248,240,250,231,227,217,217,215,216,221,229,237,232,242,248,256,256,261,266,245,232,241,237,246,232,255,247,252,223,207,216,210,220,234,254,256,258,252,275,
	284,263,260,267,254,245,239,229,227,224,221,230,247,244,246,248,260,260,263,267,258,234,243,248,255,235,256,247,224,207,226,205,217,232,234,261,262,257,250,269,
	266,257,252,265,254,235,236,228,224,224,215,223,237,245,248,275,268,283,274,274,250,232,245,254,236,235,240,246,212,208,209,218,227,236,247,266,259,255,255,275,
	272,255,252,259,250,252,252,255,235,231,225,233,246,256,269,268,282,283,276,278,273,235,266,270,237,250,263,236,209,209,200,220,240,243,238,272,269,255,251,260,
	295,275,271,293,282,265,257,266,252,236,222,228,233,253,264,300,290,303,285,286,267,239,258,270,258,265,272,214,219,210,211,231,238,252,247,256,263,262,259,267,
	271,256,255,267,261,264,245,257,260,228,234,241,248,256,272,270,300,307,279,281,259,239,259,268,292,255,216,215,211,211,216,251,275,253,264,270,257,260,265,276,
	274,258,251,272,261,275,261,278,269,250,235,240,247,251,273,293,303,296,292,290,268,237,254,260,263,233,213,216,204,212,231,250,263,269,255,280,262,264,256,263,
	272,265,258,280,305,284,265,266,282,237,235,228,236,240,247,281,303,294,287,283,250,239,248,262,257,220,214,217,213,220,230,252,233,246,247,257,285,257,269,290,
	295,278,278,282,312,284,305,273,300,262,255,248,246,251,257,268,284,296,284,286,263,242,252,267,233,221,215,218,219,231,237,255,272,251,265,278,280,266,257,278,
	276,264,260,282,294,278,304,306,307,300,268,257,237,241,248,254,275,289,275,276,251,240,251,244,227,201,197,219,234,235,254,250,263,240,261,280,280,264,264,284,
	282,267,263,295,307,300,276,283,288,281,293,265,248,248,254,259,264,284,278,280,270,241,250,240,228,223,217,227,237,252,247,272,250,261,273,293,311,263,261,280,
	272,260,260,266,292,292,294,270,268,260,265,260,264,247,250,263,268,279,286,288,262,246,239,236,229,224,220,240,234,235,247,252,254,269,280,273,287,270,260,280,
	291,274,276,290,300,272,256,268,240,252,263,252,267,251,250,268,274,275,295,296,282,245,237,237,230,225,233,243,260,245,242,247,256,277,280,276,264,266,269,288,
	296,280,273,306,294,305,270,288,277,244,259,258,274,279,267,271,277,281,293,296,264,245,238,238,231,229,234,242,255,237,250,245,264,257,280,290,271,271,280,301,
	311,297,295,313,326,296,275,252,256,253,240,244,252,252,259,264,266,271,281,284,273,244,239,239,232,243,226,243,241,246,246,245,251,255,264,281,291,265,267,281,
	271,265,262,279,273,256,229,248,233,225,236,245,247,258,256,278,273,274,288,289,266,252,217,240,235,234,234,240,231,226,248,253,246,251,253,286,270,270,269,288,
	287,274,269,282,273,265,252,245,240,233,227,239,242,248,256,270,271,266,278,285,286,246,241,247,238,236,229,231,229,223,231,243,246,243,246,258,266,272,265,275,
	285,283,367,346,326,321,303,299,297,285,288,289,288,292,302,322,330,338,282,291,277,263,305,299,294,273,275,273,273,278,301,317,323,317,311,335,342,369,284,303,
	292,278,266,265,257,246,235,232,226,222,235,240,245,248,255,263,269,275,282,290,278,265,260,251,249,238,234,228,227,220,229,228,237,238,242,248,249,254,265,284,
	289,275,218,216,214,220,220,218,217,211,203,206,208,210,215,217,222,226,280,279,283,273,221,216,214,220,220,218,217,211,203,206,208,210,215,217,222,232,265,273,
	297,278,267,273,268,254,244,244,232,227,233,244,245,252,252,275,283,285,297,301,268,258,253,250,247,238,243,226,223,212,239,250,256,247,267,258,277,273,276,291,
	294,282,275,284,275,265,256,256,243,235,239,247,255,255,260,278,282,291,302,312,277,265,260,248,260,253,249,244,243,236,234,230,241,242,252,286,287,275,281,295,
	309,296,289,297,291,265,259,260,242,232,255,270,266,275,277,276,276,286,296,303,267,260,260,243,250,248,244,228,237,227,259,261,257,278,280,276,270,271,271,286,
	314,299,293,302,286,273,256,261,247,243,237,251,250,246,249,262,267,278,289,293,291,277,277,258,260,252,249,242,248,233,263,264,268,254,285,309,288,284,283,303,
	294,275,265,276,280,263,255,259,252,240,241,251,255,263,258,279,284,296,302,311,279,261,266,245,251,243,255,249,240,228,272,260,274,285,300,300,303,287,291,308,
	312,298,293,290,287,295,283,284,272,268,245,254,253,255,251,261,262,276,282,288,297,289,287,268,270,242,247,250,252,234,262,251,266,264,282,300,306,286,287,296,
	300,287,284,288,284,273,267,255,248,240,247,270,258,260,256,273,276,296,295,303,275,267,279,249,252,238,242,231,256,228,274,256,284,272,293,283,296,276,281,297,
	310,294,288,302,280,289,275,277,260,254,255,270,251,261,257,274,288,309,292,307,300,295,302,281,277,247,252,241,251,248,280,281,296,292,280,291,292,287,291,302,
	299,284,274,295,275,260,247,261,241,232,262,271,262,272,268,279,281,302,291,306,276,270,276,270,260,242,245,223,234,227,274,265,293,272,295,310,308,281,283,302,
	309,294,293,305,284,292,263,256,255,250,245,247,242,253,252,272,270,286,279,291,291,288,296,288,282,265,267,253,259,257,268,264,260,275,290,273,292,279,278,298,
	285,269,262,276,269,289,270,262,246,246,249,256,251,263,264,302,301,323,307,323,274,267,272,269,269,250,247,232,236,227,294,291,311,315,318,317,311,281,288,306,
	310,298,291,292,280,287,281,282,261,253,248,260,255,270,278,304,296,326,312,323,284,282,283,276,288,270,251,237,240,225,267,275,295,286,283,317,313,282,296,315,
	306,292,291,292,283,271,278,262,254,239,268,279,272,297,289,306,303,320,314,329,283,280,283,277,277,267,262,227,238,216,256,270,300,295,300,294,328,293,287,307,
	314,299,297,300,297,281,264,264,241,240,257,268,269,282,275,296,291,309,305,320,295,298,291,296,294,266,270,240,238,224,254,257,275,300,295,294,332,304,299,320,
	300,287,281,282,266,286,270,266,246,245,247,259,264,277,265,306,303,323,311,328,296,293,295,303,296,300,300,278,257,238,257,252,276,290,295,300,315,283,284,307,
	305,295,282,295,280,270,254,249,234,230,254,275,270,288,271,309,298,333,307,323,281,287,293,291,303,288,288,286,263,230,257,254,266,284,313,315,347,300,297,316,
	307,290,280,287,280,275,254,252,240,243,267,282,282,284,283,322,329,347,330,340,289,293,293,295,281,321,300,294,277,250,256,252,260,262,292,321,337,304,300,325,
	305,287,279,275,268,277,260,260,251,254,264,277,277,286,283,305,296,311,303,319,283,288,288,294,282,293,313,275,290,238,269,263,276,272,297,292,300,291,295,312,
	313,298,292,295,276,265,254,252,245,245,266,277,271,291,281,300,305,327,300,327,290,293,286,313,292,300,278,338,278,256,294,269,275,272,282,300,330,302,311,329,
	305,297,276,280,263,269,257,263,260,262,278,281,280,297,275,310,313,333,312,329,287,289,284,295,300,317,313,342,276,273,329,283,284,278,285,309,342,318,319,339,
	312,297,287,287,263,258,251,249,254,260,301,310,313,323,313,322,316,335,324,334,296,304,297,311,280,300,300,300,308,333,294,272,267,261,266,271,300,289,294,312,
	325,297,287,273,263,247,242,243,243,249,278,288,281,296,294,320,318,332,326,337,283,291,290,296,276,294,308,292,287,278,321,310,295,274,284,292,304,318,316,337,
	318,300,288,274,263,270,262,270,268,254,273,271,278,286,289,297,297,322,304,321,292,300,302,306,278,290,295,300,293,293,321,319,315,283,289,290,302,309,318,332,
	337,311,294,281,277,263,264,263,256,253,278,288,285,290,292,308,318,322,314,330,285,283,286,293,274,277,283,260,288,290,305,314,296,289,283,309,317,321,331,357,
	321,300,286,276,263,283,272,278,270,260,263,276,275,282,289,305,301,315,314,318,303,307,292,300,283,287,270,274,278,275,286,285,293,283,280,293,304,310,323,339,
	331,317,297,281,274,259,253,256,249,245,283,289,286,292,303,301,313,322,314,324,272,275,270,264,263,278,278,276,272,275,284,281,292,281,296,304,305,313,321,342,
	325,303,290,279,277,277,268,266,263,258,266,265,271,276,280,291,296,302,309,304,306,304,290,282,272,259,252,254,253,243,266,272,266,275,276,296,307,309,318,339,
	340,319,297,291,279,262,259,251,254,240,281,283,292,291,303,297,308,310,316,319,294,285,272,265,259,256,252,253,249,243,270,274,280,287,290,313,315,328,328,355,
	332,315,302,291,280,296,286,284,280,275,279,288,292,290,297,308,321,320,332,333,313,300,289,280,272,273,265,263,258,255,264,265,271,277,291,319,321,334,343,366,
*/
	259,255,250,245,239,230,225,222,219,217,216,218,221,224,230,238,246,255,261,260,251,241,235,229,223,217,212,210,208,208,212,216,219,222,226,231,237,246,258,266,
	258,265,250,245,240,234,230,227,224,220,219,221,223,227,231,236,243,251,257,257,248,238,232,227,221,215,210,208,206,206,209,214,217,221,226,231,237,246,264,263,
	253,241,244,240,235,231,228,225,221,218,217,218,221,224,228,233,239,246,252,251,242,232,226,221,217,212,208,206,204,204,206,210,213,217,221,225,232,240,236,257,
	250,245,238,233,229,227,224,221,218,214,211,212,215,219,223,228,235,242,247,247,238,229,223,219,216,212,209,208,206,206,207,209,212,214,217,221,226,235,239,254,
	251,245,238,232,228,225,223,220,216,212,208,209,212,215,220,226,233,239,244,244,238,231,225,221,218,215,212,210,209,208,208,210,212,214,217,220,226,235,245,254,
	256,250,242,235,229,224,221,219,215,211,207,207,209,213,218,226,234,240,246,247,242,235,229,226,223,217,212,209,208,208,208,209,212,214,216,219,225,234,244,253,
	257,250,242,235,228,223,220,218,215,211,208,208,210,214,219,227,235,243,249,250,244,238,232,229,225,217,211,209,207,207,208,210,212,215,225,221,227,235,245,254,
	254,248,240,233,227,222,219,217,216,213,212,214,217,220,225,230,236,244,251,251,244,238,233,230,225,218,213,210,208,208,209,212,214,217,220,225,231,239,249,258,
	254,247,239,232,227,222,219,218,217,216,218,222,225,228,232,236,240,247,253,253,245,238,234,230,226,221,217,214,211,211,211,213,216,218,214,227,233,241,251,261,
	259,252,243,237,231,224,220,219,218,218,220,223,226,230,233,238,243,249,255,255,247,239,234,231,228,226,223,220,217,214,213,214,216,219,223,227,233,241,251,260,
	265,258,249,242,234,226,221,219,218,217,217,220,223,227,231,237,244,251,257,257,249,241,236,232,230,228,226,223,220,217,215,216,219,222,226,228,232,240,250,259,
	267,259,250,243,234,225,220,219,218,217,217,219,222,226,231,238,246,253,259,260,253,246,239,235,232,229,225,222,220,217,216,223,220,225,229,231,234,241,251,260,
	266,258,249,242,234,226,222,221,220,218,218,220,224,227,232,238,245,252,259,260,255,247,240,235,231,226,222,219,217,216,217,220,223,228,232,234,237,244,253,263,
	267,259,250,243,236,230,226,225,223,222,221,223,226,230,234,240,247,254,260,262,256,248,241,235,229,224,219,216,215,215,218,216,227,231,234,235,238,245,255,264,
	267,260,251,245,239,233,230,229,227,225,223,225,229,233,238,244,251,258,265,266,260,251,243,237,231,224,219,217,215,215,218,222,226,230,232,233,236,244,254,263,
	270,262,254,248,243,238,235,234,232,229,227,229,233,238,243,250,257,264,270,271,265,257,249,243,236,228,222,220,218,216,216,219,222,226,228,230,234,243,254,262,
	274,266,257,251,246,241,237,236,234,231,230,233,238,243,248,254,261,268,274,274,267,258,251,245,237,228,222,219,217,215,216,220,223,227,229,231,235,244,256,263,
	271,263,255,249,244,240,237,236,234,232,232,237,242,247,252,257,263,269,276,275,267,257,249,243,236,227,221,218,215,214,217,221,225,228,231,234,239,248,259,266,
	269,262,254,248,244,240,237,235,234,232,233,237,243,248,253,259,264,271,277,275,265,254,246,240,234,227,223,220,217,216,217,221,224,228,232,236,242,251,261,269,
	273,267,259,253,247,242,238,236,234,231,232,235,241,246,252,259,265,271,276,274,263,251,242,235,232,228,225,222,220,218,219,221,225,229,233,240,246,255,264,273,
	277,270,262,256,249,243,239,236,233,231,231,235,241,246,252,258,263,269,274,272,262,250,242,235,232,240,226,224,221,219,219,222,226,230,235,242,248,256,265,274,
	276,269,260,254,247,242,238,235,232,229,231,235,240,246,251,257,262,268,273,272,262,252,244,237,233,229,225,222,219,218,220,224,228,232,237,243,249,256,265,274,
	274,267,258,251,245,241,237,234,230,229,231,235,240,246,252,258,264,269,275,274,266,256,248,241,235,221,224,220,218,218,223,228,231,235,240,245,250,256,265,274,
	275,268,259,252,246,241,236,231,229,228,231,235,240,246,253,261,267,273,279,279,271,261,252,245,239,232,226,221,219,220,226,231,235,238,243,247,251,258,267,276,
	282,274,265,259,251,243,237,233,229,229,232,236,241,247,254,264,271,277,284,283,274,264,256,249,242,235,230,225,222,222,227,231,234,238,244,250,255,262,272,281,
	290,282,273,266,258,248,241,236,232,231,233,237,242,247,255,264,272,278,284,283,273,263,256,249,242,236,231,227,224,223,226,230,232,236,243,251,258,265,275,284,
	290,283,275,267,259,248,240,236,232,230,231,235,239,244,252,262,270,276,282,281,272,262,255,249,243,237,232,228,225,223,225,228,231,235,241,249,257,264,273,281,
	282,276,268,262,253,244,237,232,228,226,228,233,237,242,250,260,268,274,280,280,273,264,258,251,245,238,232,229,225,223,224,227,230,234,240,248,255,262,271,278,
	279,272,264,258,251,243,236,230,226,224,227,232,237,242,249,258,266,272,270,281,276,268,261,255,247,239,232,228,224,222,223,226,230,235,241,249,256,263,272,280,
	280,281,274,284,278,270,262,254,249,246,252,258,262,268,276,285,292,300,278,290,276,278,284,278,270,262,254,250,247,244,246,251,255,259,266,275,281,273,274,283,
	285,277,268,262,256,249,241,235,230,228,231,236,241,246,252,259,266,273,279,281,277,269,261,255,248,241,235,230,226,224,225,229,233,237,242,249,254,262,271,280,
	288,270,262,251,246,241,234,228,224,221,223,225,230,234,240,244,250,258,276,283,277,250,248,242,237,231,226,221,216,215,216,218,222,221,231,237,241,261,270,277,
	290,272,261,265,260,253,246,239,234,232,234,238,243,247,254,264,273,282,289,288,278,266,258,252,247,242,237,231,227,225,227,231,235,239,245,251,258,265,274,282,
	294,285,275,269,262,253,245,239,233,232,236,241,246,251,258,268,277,286,294,292,279,266,258,251,246,242,237,232,227,226,229,233,237,241,247,254,261,268,277,285,
	299,291,282,274,266,256,247,240,235,233,237,244,249,254,260,268,276,285,292,291,280,269,260,253,248,243,238,233,228,228,233,237,241,245,251,257,263,270,279,287,
	300,292,282,275,267,257,248,242,236,234,237,242,247,252,258,266,275,284,291,291,283,272,264,257,251,245,240,234,230,230,236,241,246,249,255,261,267,274,283,292,
	298,289,279,272,265,258,251,245,239,236,237,242,246,251,258,267,275,284,290,292,285,275,267,260,253,247,241,236,231,232,238,244,248,251,257,264,270,277,287,296,
	298,290,280,273,266,260,254,248,241,238,239,244,248,252,258,266,274,282,288,291,286,278,270,263,255,247,241,236,231,232,239,245,249,252,257,263,269,277,286,294,
	299,291,281,273,266,260,254,247,241,240,243,248,252,256,261,268,276,283,290,292,287,279,272,264,257,248,241,235,231,232,240,247,251,254,258,263,268,276,285,293,
	299,290,280,272,264,257,251,245,240,240,246,252,256,259,264,270,278,285,291,294,289,281,274,266,259,251,244,237,233,234,242,249,253,255,259,263,269,277,286,294,
	297,289,278,270,262,254,248,243,239,239,246,253,257,260,264,270,277,284,290,293,287,279,273,266,260,253,247,240,236,236,244,250,253,256,259,263,269,276,286,294,
	295,286,276,268,262,255,249,244,239,239,245,251,254,258,264,271,279,286,292,293,286,277,270,264,259,255,250,244,240,241,247,253,257,259,262,265,269,276,285,295,
	293,285,276,268,263,259,253,247,242,242,247,252,256,260,267,278,287,295,301,299,288,276,268,262,257,252,248,243,239,241,250,257,261,264,266,268,272,279,289,299,
	297,290,280,273,267,262,257,251,246,246,252,258,262,267,274,284,294,302,307,305,291,278,269,263,257,250,245,239,236,239,249,257,261,263,267,270,276,282,293,302,
	302,294,284,276,269,262,257,251,247,248,256,264,268,272,278,286,294,302,308,307,295,282,273,266,259,251,245,239,235,237,247,255,258,261,265,271,278,285,295,304,
	302,294,284,275,268,261,256,250,246,247,255,262,266,270,275,284,292,300,307,307,298,287,277,270,263,255,249,243,239,240,247,254,257,260,265,272,280,287,296,305,
	300,292,281,272,266,260,255,250,245,245,252,259,262,266,273,284,293,301,308,308,298,287,278,270,264,259,254,249,245,244,249,255,258,261,265,272,279,286,295,305,
	299,291,280,271,265,259,254,249,244,245,253,260,264,268,275,287,298,306,312,310,297,285,275,268,263,260,256,252,248,246,251,256,259,262,267,274,281,288,298,308,
	300,291,279,271,265,260,255,250,246,248,256,262,266,271,278,289,300,309,314,311,297,284,274,267,262,258,255,250,247,247,253,259,262,265,270,277,284,291,301,311,
	301,291,280,271,265,262,258,253,250,251,257,263,266,271,277,287,296,304,310,308,296,284,275,267,261,255,251,247,244,246,256,264,268,271,275,280,286,293,304,313,
	303,293,281,272,266,262,258,254,251,252,258,264,268,272,278,287,295,302,308,308,297,285,276,268,261,255,251,247,244,248,259,268,273,275,279,285,291,298,309,319,
	304,294,281,272,265,261,257,254,251,254,263,270,275,279,284,292,300,307,312,311,299,287,277,269,263,258,254,250,247,250,260,269,273,275,279,286,294,301,311,321,
	307,296,283,272,264,258,253,249,248,254,266,275,280,285,290,297,304,311,317,314,301,288,278,270,264,260,257,252,249,251,260,267,271,274,278,285,293,300,310,319,
	311,299,285,274,265,258,252,247,246,251,263,272,277,281,287,295,303,310,316,313,300,288,278,270,264,260,257,252,249,252,262,270,274,277,281,288,296,304,314,323,
	315,303,288,277,268,262,257,252,250,252,260,267,272,276,283,291,299,306,312,310,299,287,277,269,263,260,256,252,250,253,263,272,277,280,285,294,302,310,321,331,
	318,306,291,279,271,265,261,256,253,254,260,267,271,276,282,291,298,305,311,309,299,287,277,269,263,259,255,251,249,251,260,268,273,277,284,296,306,315,326,336,
	319,307,293,280,271,265,260,256,253,254,261,268,273,277,283,291,298,305,310,309,298,286,277,270,263,258,254,250,248,250,256,263,268,273,281,294,306,315,326,336,
	320,309,294,281,271,264,258,254,252,254,262,270,275,279,284,291,297,304,309,307,296,285,276,268,262,257,253,250,249,250,256,262,267,272,281,294,305,314,325,334,
	322,311,296,284,274,266,260,257,254,256,264,272,277,281,286,292,299,305,309,307,298,288,278,270,263,257,253,250,249,251,257,264,269,275,284,297,308,317,327,337,
	325,314,300,288,279,273,268,264,261,263,271,278,283,288,293,299,305,311,315,313,303,292,281,273,266,260,256,254,252,253,260,267,273,280,290,304,315,324,335,345,
	326,316,302,291,284,281,277,273,270,271,277,284,288,292,297,305,312,318,322,319,309,296,285,276,270,265,262,258,256,257,262,268,274,282,294,309,320,330,341,352,
};

#endif
uint16_t FsCoffBuFreqNormalize[ROWS * COLS] =
{
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
};
uint16_t tx1PcCoffBuf[COLS_STYLUS_TIED * ROWS] =
{
107,99,97,94,89,90,93,96,100,98,96,96,96,90,90,86,91,93,99,104,107,100,99,91,91,91,95,96,98,97,94,95,96,89,90,86,90,92,98,103,
104,98,95,89,87,87,89,92,93,90,90,91,91,87,88,86,91,92,98,102,106,99,97,90,87,89,91,91,93,89,89,90,91,86,89,84,90,91,98,102,
108,99,98,92,89,90,91,95,95,94,92,95,95,92,92,90,94,97,101,107,109,104,99,94,91,91,92,94,95,92,92,93,93,89,91,88,92,95,100,105,
110,102,101,96,91,95,94,98,98,97,97,100,98,97,99,95,98,101,105,112,111,107,101,98,93,95,94,98,99,94,96,96,97,93,94,92,96,98,103,108,
112,104,102,98,94,96,96,102,100,100,101,103,101,99,98,98,100,105,107,114,114,108,103,101,95,96,97,100,101,98,98,99,101,97,97,94,99,101,106,111,
114,108,104,100,96,98,98,104,102,102,103,106,105,103,101,102,103,108,110,116,116,111,105,102,97,99,99,103,102,100,101,104,103,99,100,98,101,105,108,112,
116,109,106,103,98,101,100,107,106,105,106,109,107,107,105,104,107,111,114,119,119,114,108,105,100,101,101,106,105,102,104,105,105,103,102,101,104,108,111,116,
117,111,107,105,100,102,101,107,107,107,109,112,111,110,108,107,110,115,116,121,121,116,110,107,102,102,102,106,105,103,106,108,108,106,104,102,106,111,113,117,
121,114,110,107,103,105,105,109,109,108,112,116,114,111,111,110,112,114,118,123,124,118,113,107,104,104,103,107,107,104,108,112,109,107,108,105,109,111,116,120,
121,118,111,108,104,106,105,111,110,109,113,117,115,113,112,111,114,115,119,123,124,120,112,108,105,104,103,107,108,105,110,113,112,109,109,107,111,113,116,121,
124,120,114,111,106,108,107,112,112,111,116,119,117,115,114,112,116,118,121,124,125,120,114,108,105,105,104,108,108,106,111,114,113,111,110,109,112,115,118,123,
125,122,116,112,107,110,108,114,112,112,118,120,120,117,117,114,116,119,124,126,126,120,115,110,104,105,105,109,108,108,113,116,114,113,113,111,113,117,120,125
};
uint16_t tx1PrCoffBuf[COLS * ROWS_STYLUS_TIED] =
{ 
88,87,75,87,90,88,73,87,
90,90,76,89,92,91,77,90,
90,89,77,90,91,91,76,90,
90,91,78,91,92,91,77,90,
92,91,75,91,92,91,76,91,
92,91,78,93,94,93,77,92,
91,92,77,93,94,92,77,92,
94,92,79,93,96,93,79,93,
93,91,82,93,95,92,79,93,
95,93,82,95,97,94,80,94,
96,92,81,94,97,93,80,93,
94,93,83,96,97,93,82,95,
94,92,83,96,97,94,81,95,
97,94,85,97,99,96,84,96,
96,94,85,98,100,95,84,97,
97,94,87,99,101,95,85,97,
101,94,88,99,101,95,87,97,
98,94,90,100,102,94,87,99,
100,94,90,101,103,95,87,98,
100,94,91,100,103,94,89,100,
102,94,93,100,104,95,89,100,
101,95,93,101,103,96,90,101,
102,95,94,103,103,97,91,101,
101,92,96,103,103,94,94,102,
102,95,96,105,105,96,94,104,
103,95,98,105,104,96,95,105,
105,95,97,105,105,97,94,104,
103,96,99,105,104,96,96,104,
105,97,98,106,106,98,96,104,
104,97,99,108,106,98,97,107,
105,96,101,108,107,98,96,105,
107,98,102,110,107,97,99,107,
105,96,102,111,107,96,99,108,
107,97,104,112,109,98,100,109,
109,97,105,113,109,97,101,109,
108,98,105,112,110,99,102,111,
108,97,106,115,110,99,103,112,
112,98,106,114,112,100,102,110,
109,98,109,114,111,100,106,111,
109,99,112,115,112,100,107,112,
109,99,112,115,111,100,107,113,
110,99,111,115,112,101,107,112,
109,99,114,116,111,99,110,112,
111,101,112,117,114,100,109,114,
111,100,114,119,112,100,111,115,
111,99,117,117,113,99,110,115,
113,99,115,118,113,99,111,114,
113,101,116,119,113,100,113,116,
112,100,118,120,113,98,112,115,
113,101,116,120,114,99,113,116,
113,100,117,119,113,98,114,117,
114,103,120,121,114,100,115,117,
114,101,121,120,113,98,114,117,
116,102,120,122,114,99,116,118,
116,102,121,123,115,99,119,119,
118,104,121,124,115,99,118,121,
119,104,121,123,116,99,118,120,
120,105,125,124,117,101,119,120,
119,106,123,123,117,102,120,120,
121,105,124,122,117,101,120,120,
118,104,123,121,115,99,118,118
};
uint16_t tx2PcCoffBuf[COLS_STYLUS_TIED * ROWS] =
{
};
uint16_t tx2PrCoffBuf[COLS * ROWS_STYLUS_TIED] =
{
};
static uint16_t grid_data[RAWDATA_NODES];
uint16_t base_data_even[RAWDATA_NODES];
uint16_t grid_last_even_data[RAWDATA_NODES];
uint16_t test_data[ROWS*COLS]={
        337,332,322,321,331,323,316,316,324,342,321,317,347,328,331,330,323,311,328,328,320,297,316,317,311,314,316,307,304,320,299,305,306,311,293,303,302,308,291,315,303,309,299,292,293,315,287,288,297,292,280,287,293,295,289,276,278,275,262,272,282,
        328,332,322,320,329,324,309,312,321,335,313,312,341,320,323,317,313,304,316,317,309,289,308,300,301,305,306,296,296,312,294,295,300,304,286,293,294,299,282,308,289,299,290,280,286,298,276,275,284,281,274,278,284,283,283,270,272,271,258,267,273,
        321,330,318,316,325,318,303,305,310,321,303,299,331,306,311,307,301,289,303,303,296,279,296,297,294,298,299,290,287,302,284,290,295,294,278,285,287,292,275,297,283,291,282,272,274,291,268,267,275,273,265,270,273,275,274,259,264,265,250,262,259,
        317,321,309,309,318,310,297,300,302,318,299,295,326,299,300,302,296,285,299,298,289,269,289,288,284,289,289,281,280,293,275,281,287,286,269,275,277,282,266,290,275,283,275,266,269,280,261,258,268,265,257,258,267,269,267,252,258,258,245,260,252,
        314,315,302,301,313,304,289,292,296,313,296,289,318,296,293,296,289,283,294,291,283,265,284,284,278,278,283,274,275,288,273,275,280,279,267,271,270,276,258,283,267,276,266,260,263,277,255,252,261,259,251,256,260,262,262,245,254,254,239,249,249,
        293,289,292,295,280,289,284,285,284,289,277,292,289,280,282,282,288,279,275,273,274,262,273,271,272,273,285,266,282,275,265,268,256,273,261,268,270,282,265,261,253,263,269,263,247,265,257,250,251,261,253,251,245,256,252,238,249,245,243,243,255,
        286,286,289,291,280,284,282,280,281,286,276,287,291,279,275,282,286,275,273,273,275,260,271,271,270,271,282,267,280,272,262,267,259,272,257,266,268,281,263,259,256,262,267,261,244,264,253,248,248,258,248,248,240,250,245,231,238,232,234,233,249,
        290,286,288,292,281,285,282,280,283,286,276,288,289,279,273,281,286,276,273,270,273,260,270,272,269,270,282,259,279,271,258,265,257,270,257,268,270,280,261,259,253,261,268,260,242,262,254,247,247,258,247,248,238,247,243,238,238,230,233,234,251,
        286,281,287,287,276,281,281,277,278,285,271,285,285,275,274,277,284,273,270,270,270,258,266,269,266,267,281,258,276,269,256,264,254,269,254,264,267,278,257,256,252,257,263,256,244,260,251,246,245,251,243,243,235,244,240,230,236,231,230,233,251,
        280,275,282,285,275,276,275,273,273,279,269,280,278,269,264,272,277,266,264,265,265,254,262,260,259,258,274,250,270,263,251,255,247,264,251,257,260,272,254,249,244,253,254,249,236,248,242,237,240,247,240,237,232,241,236,223,234,228,227,229,248,
        275,264,266,267,264,244,258,266,251,241,273,260,266,242,267,269,252,269,245,257,254,265,252,257,247,259,255,262,246,248,254,245,257,248,245,242,247,244,261,245,266,237,255,246,241,249,246,244,245,248,236,233,240,242,228,233,225,235,222,238,251,
        275,264,269,268,266,249,265,264,256,250,282,270,273,246,273,273,265,277,248,259,252,271,257,263,251,266,260,271,248,255,259,252,263,252,247,246,249,244,260,241,267,238,255,243,242,252,241,243,247,247,237,234,241,242,230,231,223,232,213,238,250,
        280,275,276,272,271,261,268,272,260,252,287,271,276,252,279,278,271,284,249,265,269,278,265,266,264,272,268,275,255,262,264,257,268,259,253,253,256,250,266,247,272,247,261,246,247,258,249,251,246,253,248,239,247,247,239,237,228,238,225,242,252,
        282,277,279,273,275,263,272,276,267,257,290,272,280,249,283,282,278,287,256,271,278,283,269,273,267,278,272,281,262,269,269,268,276,265,260,263,264,264,276,256,276,245,265,253,251,262,261,255,252,259,248,244,251,253,240,242,233,245,226,248,264,
        287,287,285,278,284,264,280,287,272,264,297,280,287,258,290,289,279,294,267,276,279,288,272,277,274,283,275,283,264,272,272,270,278,269,262,264,265,263,274,254,279,254,270,262,256,267,261,257,264,262,252,246,256,257,240,247,232,248,234,251,265,
        308,288,294,286,290,286,286,275,276,284,271,276,295,275,284,285,270,297,277,279,281,292,277,287,268,273,287,274,267,278,272,278,275,272,269,258,282,253,271,266,265,263,283,259,272,280,290,258,249,269,256,258,261,266,268,254,254,252,256,252,270,
        316,301,306,299,303,297,295,284,284,294,280,281,303,284,291,294,278,303,286,286,291,298,281,295,278,279,294,280,269,286,276,282,278,279,272,265,286,262,277,274,271,273,288,268,278,283,282,261,253,271,258,261,263,268,273,255,252,252,266,253,279,
        323,307,310,304,308,304,305,296,292,299,289,288,311,289,299,301,282,311,292,295,295,305,290,301,283,283,304,284,279,293,281,287,289,283,280,273,293,263,281,277,277,275,291,269,283,290,295,269,263,278,271,267,270,275,271,263,261,261,269,261,288,
        328,317,322,316,320,310,310,299,301,311,297,300,321,295,308,311,296,318,297,305,303,317,299,309,291,289,304,295,287,298,289,288,296,297,289,282,301,270,289,281,285,281,299,279,293,296,309,273,267,284,271,273,271,280,281,268,267,264,267,265,288,
        339,323,328,321,325,314,317,313,306,317,300,307,326,308,314,318,293,329,311,312,310,326,300,319,300,299,318,304,290,311,297,305,302,306,295,285,307,282,296,289,289,284,306,284,296,301,311,280,271,289,276,280,277,287,292,274,266,269,280,267,293,
        330,332,354,350,347,350,331,345,315,331,321,340,336,323,331,331,332,328,334,333,335,322,333,340,354,325,321,335,324,342,329,316,320,316,310,332,329,317,306,338,314,300,303,303,316,315,308,291,294,293,299,291,301,303,299,284,281,292,280,286,301,
        326,328,349,342,337,344,325,337,306,327,323,335,329,313,330,321,326,319,328,331,329,314,328,336,344,313,315,323,313,335,315,306,316,305,300,316,310,308,295,326,303,289,296,294,302,307,300,284,284,283,291,285,296,294,290,275,272,279,269,276,294,
        324,335,350,346,341,344,328,336,305,323,320,331,329,316,323,320,321,312,324,330,325,308,323,331,338,313,310,321,311,325,306,301,304,303,295,315,310,305,295,323,298,285,293,288,299,300,295,281,281,279,288,282,291,288,289,274,270,275,266,272,291,
        316,330,343,340,338,342,321,335,306,326,314,332,332,317,321,317,323,315,323,324,324,313,323,332,340,314,311,321,310,332,308,301,307,303,295,316,310,304,290,323,296,284,292,289,299,297,295,280,281,279,287,281,287,286,284,266,268,274,265,262,275,
        311,323,339,334,332,335,312,325,298,315,306,320,318,305,312,305,311,304,313,314,312,296,310,320,326,300,298,308,299,313,298,294,300,297,285,309,301,297,282,317,292,277,287,285,299,292,287,266,272,268,280,277,282,281,278,263,262,266,256,254,269,
        312,306,308,315,301,299,307,298,303,302,309,312,300,298,322,303,309,314,293,288,291,291,310,280,289,288,294,293,290,283,289,297,286,276,271,282,275,283,264,283,267,280,270,273,270,272,269,278,257,273,251,251,262,266,267,243,279,260,273,246,270,
        307,304,305,311,295,293,301,292,299,300,299,308,296,299,315,294,305,312,288,283,288,290,311,279,287,286,292,290,288,282,282,294,282,275,272,280,271,279,264,281,263,277,266,271,263,268,266,273,252,270,249,249,258,258,263,240,275,257,269,242,267,
        306,307,306,311,297,293,304,294,298,300,299,308,299,296,311,299,301,309,285,278,282,288,304,274,280,284,285,285,280,274,276,286,275,267,264,272,262,270,253,273,255,270,258,263,256,263,261,265,247,265,242,242,253,253,259,233,268,249,263,238,267,
        303,302,306,308,290,292,300,291,295,295,298,303,292,292,303,291,298,305,283,274,278,285,300,269,276,275,280,278,275,266,273,281,270,262,257,269,260,267,249,267,254,266,252,258,253,261,256,260,243,261,239,242,248,249,255,229,266,249,260,238,265,
        293,297,298,301,287,285,292,285,286,289,290,296,285,286,299,285,292,300,278,270,275,280,296,261,270,267,275,272,270,261,266,276,264,256,250,261,252,262,244,262,248,261,250,252,246,253,250,256,238,254,232,231,242,242,248,223,258,243,255,235,258,
        269,265,285,262,259,262,260,252,272,258,261,246,264,254,262,271,258,258,246,270,247,248,256,250,252,255,260,262,250,252,253,237,247,239,241,241,245,237,250,238,258,233,248,249,249,243,228,236,240,238,233,238,223,245,227,231,226,237,234,238,246,
        275,266,286,257,260,264,262,255,275,261,264,251,265,256,266,272,255,264,256,273,248,251,253,252,256,260,258,266,254,255,257,243,252,236,242,244,250,236,252,237,260,237,252,248,251,245,236,239,248,238,235,241,226,248,225,235,225,240,238,241,253,
        276,265,292,263,265,273,267,262,278,267,267,254,271,264,270,276,263,268,261,278,258,255,258,255,259,263,262,270,253,258,260,246,255,241,246,245,251,240,255,240,263,238,254,249,253,247,232,241,240,239,234,242,232,249,231,236,225,242,238,242,251,
        276,259,289,262,264,274,266,258,280,266,264,258,270,258,270,278,257,269,258,280,257,256,258,256,261,262,263,270,260,257,260,244,257,237,247,246,252,241,255,236,260,235,253,254,253,248,234,240,241,240,233,242,228,251,227,236,224,242,242,242,251,
        283,272,296,267,273,279,273,265,285,268,272,265,276,266,275,285,269,275,264,283,264,261,261,260,264,267,266,273,258,262,265,246,259,238,249,248,255,245,255,240,265,245,257,263,254,250,233,241,248,241,234,243,230,253,229,239,232,245,247,244,257,
        295,272,284,263,280,266,280,268,280,277,282,276,273,265,280,286,279,290,259,267,274,267,259,292,265,277,261,268,264,269,269,265,269,265,265,254,267,259,264,267,263,250,261,242,257,267,244,248,253,255,260,257,237,243,242,242,232,241,233,244,246,
        300,278,291,269,286,277,291,276,289,287,291,284,280,278,286,291,288,298,266,274,285,273,269,298,273,284,266,273,267,275,276,269,275,270,270,258,272,267,268,269,269,262,265,247,260,271,256,254,257,260,262,262,238,249,244,245,238,245,240,248,246,
        306,284,298,277,291,285,298,279,294,286,294,282,283,277,290,296,294,299,272,279,284,275,270,301,277,287,274,273,273,277,277,276,277,271,271,264,275,268,272,272,270,263,267,245,262,273,253,256,262,263,266,266,243,252,251,250,238,250,248,254,243,
        305,276,291,268,285,276,290,272,287,280,290,280,281,275,285,290,291,294,265,273,280,269,266,294,270,280,265,267,268,273,282,278,283,283,279,270,281,275,278,281,277,264,273,252,268,279,258,260,261,266,269,269,256,256,256,254,252,253,249,257,255,
        311,277,294,271,290,283,291,274,290,289,289,284,280,277,290,292,288,296,266,275,281,272,269,299,274,284,268,273,262,272,273,266,273,264,266,259,271,262,267,267,265,257,261,239,259,265,249,249,253,254,258,256,241,247,252,243,233,243,238,244,254,
};
void cts_print_rawdata(uint16_t *rawdata)
{
    char line_buf[ROWS * 6 + 128];
    int offset = 0,i,j;
    CTS_THP_LOGD("frame data");

    for (i = 0; i < ROWS; i++)
    {
        offset = 0;
        for (j = 0; j < COLS; j++)
        {
            offset += snprintf(line_buf + offset,sizeof(line_buf) - offset," %4d", rawdata[i * COLS + j]);
        }
        offset += snprintf(line_buf + offset,
                           sizeof(line_buf) - offset, "\n");
        CTS_THP_LOGE("%s", line_buf);
    }
}

void cts_print_stylusdata(uint16_t freqIndex, uint16_t *rawdata, uint16_t row, uint16_t col)
{
    char line_buf[ROWS * 6 + 128];
    int offset = 0,i,j;

    CTS_THP_LOGD("freq%d -----stylus data",freqIndex);

    for (i = 0; i < row; i++)
    {
        offset = 0;
        for (j = 0; j < col; j++)
        {
            offset += snprintf(line_buf + offset,sizeof(line_buf) - offset," %4d", rawdata[i * col + j]);
        }
        offset += snprintf(line_buf + offset,sizeof(line_buf) - offset, "\n");
        CTS_THP_LOGE("%s", line_buf);
    }
}

static void cts_transposition_pr_data(uint16_t *src_data, uint16_t *dsc_data, uint16_t nrows, uint16_t ncols)
{
    uint16_t i, j;
    for (i = 0; i < nrows; i++)
    {
        for (j = 0; j < ncols; j++)
        {
            // dsc_data[j + i * ncols] = src_data[j * nrows + (nrows - 1 - i)];
            dsc_data[j + i * ncols] = src_data[nrows * ncols - (j * nrows + i) -1];
        }
    }
}
static void cts_transposition_pc_data(uint16_t *src_data, uint16_t *dsc_data, uint16_t nrows, uint16_t ncols)
{
    uint16_t i, j;   
    for (i = 0; i < nrows; i++)
    {
        for (j = 0; j < ncols; j++)
        {
            dsc_data[j + i * ncols] = src_data[ nrows * ncols - ( j * nrows + i ) - 1 ];
            // dsc_data[j + i * ncols] = src_data[j * nrows + i ];
        }
    }
}
static void cts_remap_grid_data(uint16_t *src_data, uint16_t *dsc_data, uint16_t nrows, uint16_t ncols)
{
    uint16_t i, j;
    uint16_t tmpdata[ROWS*COLS] = {0};
    for (i = 0; i < (ROWS*COLS); i++)
        tmpdata[ROWS*COLS-1-i] = src_data[i];

    for (i = 0; i < COLS; i++) {
        for (j = 0; j < ROWS; j++)
            dsc_data[j + i * ROWS] = tmpdata[i + j * COLS];
    }
}

static int cts_convert_grid_data(CTS_FRAME_STRUCT *thp_ctsframe)
{
    // int dst, src;
    int temp,index;

#if 0  
    uint16_t temp_rawdata[RAWDATA_NODES];
    uint16_t noise_data[RAWDATA_NODES];
   

    uint16_t raw_data[32*50] = {0};
    int offest =0;
#endif

    uint16_t *FsCoffBuFreq = NULL;
//#define NORMALIZE_MODE
#ifdef NORMALIZE_MODE
    FsCoffBuFreq = FsCoffBuFreqNormalize;
#else
    if(thp_ctsframe->finger_scan_freq == s_scan_freq[0])
    {
        FsCoffBuFreq = FsCoffBuFreq0;
    }
    else if(thp_ctsframe->finger_scan_freq == s_scan_freq[1])
    {
        FsCoffBuFreq = FsCoffBuFreq0;
    }
    else if(thp_ctsframe->finger_scan_freq == s_scan_freq[2])
    {
        FsCoffBuFreq = FsCoffBuFreq0;
    }
    else{
        FsCoffBuFreq = FsCoffBuFreq0;
    }
#endif    

    for (int i = 0; i < ROWS; i++)
    {
        for (int j = 0; j < COLS; j++)
        {
            index = i*COLS + j;
            temp = (int)(grid_data[index] - baserawdata[index]);
            grid_data[index] = (int)(temp * FsCoffBuFreq[index] *9 / 1000) + 0x8000;
#ifdef NOISE_LOG
             //memcpy(temp_rawdata, grid_data, sizeof(temp_rawdata));
#endif

        }
    }

    /********************************************************************************************************************/
#ifdef NOISE_LOG
        cnt ++;

       if (cnt == 1)
        {
            // memcpy(max_rawdata, curr_rawdata, sizeof(max_rawdata));
            // memcpy(min_rawdata, curr_rawdata, sizeof(min_rawdata));
             memcpy(max_rawdata, grid_data, sizeof(max_rawdata));
             memcpy(min_rawdata, grid_data, sizeof(min_rawdata));
        }
        else
        {
            for (i = 0; i < RAWDATA_NODES; i++)
            {
                if (grid_data[i] > max_rawdata[i])
                {
                    max_rawdata[i] = grid_data[i];
                }
                else if (grid_data[i] < min_rawdata[i])
                {
                    min_rawdata[i] = grid_data[i];
                }
            }
        }
        for (i = 0; i < RAWDATA_NODES; i++)
         {
           noise_data[i] = max_rawdata[i] - min_rawdata[i];
        
         }

         if((cnt%30) == 0 )
         {
            cnt =0;
            memset(max_rawdata, 0, sizeof(max_rawdata));
            memset(min_rawdata, 0, sizeof(max_rawdata));

            cts_dump_tsdata("noise", 30, noise_data);
            //cts_print_rawdata(noise_data);
            //LOGD("1111222");
            //cts_print_rawdata(min_rawdata);
         }
#endif            
    if ((thp_ctsframe->afe_status & 0x40) == 0x40)
    {
        //cts_tcs_get_debug_info(&debug);
        //read_hard_reg();
        CTS_THP_LOGI("sos,print origina data");
        // cts_print_fw_status(thp_ctsframe);
        // cts_print_rawdata(thp_ctsframe->rawdata);

    }   

    // memcpy(thp_ctsframe->rawdata, grid_data, ROWS*COLS*2);
#if 0
    if (!poweron)
    {
        memcpy(base, thp_data, RAWDATA_SIZE);
    }
#endif
    return 0;
}
#if  0
static void cts_convert_grid_data(uint16_t *src_data, uint16_t *dsc_data, uint16_t nrows, uint16_t ncols)
{
    uint16_t i;
    for (i = 0; i < nrows*ncols; i++)
    {
        dsc_data[i] = 0x8000 + 3 * (src_data[i] - s_Fs_raw_dest_value);
    }
}

static int cts_convert_grid_data_new(uint16_t *thp_data,  uint16_t  finger_scan_freq)
{
    int i, j;
    int dst, src;


    uint16_t Ka=10,Kb=10;

#if  0
    if (finger_scan_freq == F_FREQ2 )
        Ka=12;
    else if (finger_scan_freq == F_FREQ3 )
        Ka=15;
    else
        Ka=10;
#else
    Ka = finger_scan_freq;
    Kb = F_FREQ1;
#endif

    for (i = 0; i < ROWS; i++)
    {
        for (j = 0; j < COLS; j++)
        {
            dst = i * COLS + j;
            src = j * ROWS + i;

#if  1
            grid_data[dst] = (((thp_data[src] - s_Fs_raw_dest_value) * FsCoffBuf[src]/ 100) + 0x8000);
#else
            grid_data[dst] = (((thp_data[src] - s_Fs_raw_dest_value) * FsCoffBuf[src]* Ka/Kb/ 100) + 0x8000);
#endif
        }
    }

    memcpy(thp_data, grid_data, RAWDATA_SIZE);

    return 0;
}
#endif

//add yjl  ---need  check  para
//#define   CHECK_CALIBRATION_DONE_DATA

#ifdef   CHECK_CALIBRATION_DONE_DATA
#define   CALIBRATION_DONE_RAW_CHECK_DELTA        FS_RAW_DEST_VALUE
#define   CALIBRATION_DONE_RAW_CHECK_ERR_MAX_THD  (FS_RAW_DEST_VALUE*3)
#define   CALIBRATION_DONE_RAW_CHECK_ERR_MIN_THD  (FS_RAW_DEST_VALUE/4)

bool AppBeforeCheckCalibrationDone(uint16_t* rawdata)
{
    uint8_t  i, raw[4], col[4];
    uint8_t  CMDA1 = ROWS/2, LeftLength = COLS/2, RightLength = COLS/2;
    uint16_t offset, temp[4], max = 0, min = 0xFFFF;

    raw[0] = rand() % CMDA1;
    raw[1] = raw[0];
    col[0] = rand() % LeftLength;
    col[1] = rand() % RightLength + LeftLength;

    raw[2] = rand() % CMDA1 + CMDA1;
    raw[3] = raw[2];
    col[2] = rand() % LeftLength;
    col[3] = rand() % RightLength + LeftLength;


    for (i = 0; i < 4; i++)
    {
        offset = raw[i] * COLS + col[i];

        temp[i] = rawdata[offset];
        if (temp[i] > max)
        {
            max = temp[i];
        }
        if (temp[i] < min)
        {
            min = temp[i];
        }

        //CTS_THP_LOGI("offset:%04d,%04d,%04d",raw[i], col[i], temp[i]);
    }
    // CTS_THP_LOGI("raw jump:%04d,", max - min);
    if ((abs(max - min) > CALIBRATION_DONE_RAW_CHECK_DELTA)
        ||( max >  CALIBRATION_DONE_RAW_CHECK_ERR_MAX_THD)
        ||( min <  CALIBRATION_DONE_RAW_CHECK_ERR_MIN_THD)
       )
    {
        return  true;
    }
    return false;
}
#endif

#define BIG_NEG_DIFF_TH                  100
#define BIG_NEG_AREA_TH                  10
#define INTER_FRAME_NOISE_DIFF_TH        50
#define INTER_FRAME_NOISE_AREA_TH        8
#define NONE_NOISE_FRAME_TH              10
//add yjl  ---need  check  para

void cts_calibrate_check( uint16_t *rawdata,CTS_FRAME_STRUCT *cts_frame)
{
    uint8_t i, j;
    uint16_t  offset;
    uint16_t u16BigNoiDiffCnt = 0;
    int16_t g_s16realdiff0,  g_s16stable0;   //even
    static uint16_t u16NoneNoiFrameCnt =0;
    static uint16_t u16BigDiffNegCnt = 0 ;
    static  bool  nobase_even=true, negdiffFlag=false;
    int done_flag =0;

#ifdef   CHECK_CALIBRATION_DONE_DATA
    if ( AppBeforeCheckCalibrationDone(rawdata))
    {
        return;
    }
#endif

    if (1)
    {
        static  bool  noLastRaw=true;
        if ( ((cts_frame->frame_type & 0x01) ==0x01 ) &&
             (((cts_frame->afe_status & THP_AFE_STATUS_CALIBRATION_DONE )== THP_AFE_STATUS_CALIBRATION_DONE) || (cts_frame->frame_index == 1))
           )
        {
            return;
        }
        else if ( ((cts_frame->frame_type & 0x01) ==0x00 ) &&
                  ( (cts_frame->frame_index ==2) || noLastRaw || nobase_even ))
        {
            memcpy(base_data_even, rawdata, RAWDATA_SIZE);
            nobase_even=false;

            noLastRaw = false;
            memcpy(grid_last_even_data, rawdata, RAWDATA_SIZE);
            return;
        }
    }

    if (   (cts_frame->afe_status & THP_AFE_STATUS_SOS ) ==THP_AFE_STATUS_SOS || (cts_frame->afe_status & THP_AFE_STATUS_CALIBRATION_DONE ) ==THP_AFE_STATUS_CALIBRATION_DONE  )
    {
        return;
    }

    if ((cts_frame->frame_type & 0x01) ==0x01)
    {
        negdiffFlag =false;
        for (i = 0; i < COLS; i++)
        {
            for (j = 0; j < ROWS; j++)
            {
                offset = i*ROWS+j;
                g_s16realdiff0 = rawdata[offset] - base_data_even[offset];


                if (g_s16realdiff0 < (0- (int16_t)BIG_NEG_DIFF_TH))
                {
                    u16BigDiffNegCnt = u16BigDiffNegCnt +  abs(g_s16realdiff0)/BIG_NEG_DIFF_TH;
                }
            }

            if (  u16BigDiffNegCnt > BIG_NEG_AREA_TH  )
            {
                negdiffFlag  =true;
                break;
            }
        }
        return;
    }
    else
    {
        if (  negdiffFlag ==false )
        {
            memcpy(grid_last_even_data, rawdata,RAWDATA_SIZE);
            u16BigDiffNegCnt =0;

            // CTS_THP_LOGD("no neg diff--- u16BigDiffNegCnt  =  %4d", u16BigDiffNegCnt);
            return;
        }
        negdiffFlag =false ;
    }


    for (i = 0; i < COLS; i++)
    {
        for (j = 0; j < ROWS; j++)
        {
            offset = i*ROWS+j;
            g_s16stable0 = rawdata[offset] - grid_last_even_data[offset];

            if (abs(g_s16stable0) > INTER_FRAME_NOISE_DIFF_TH )
            {
                u16BigNoiDiffCnt =u16BigNoiDiffCnt + abs(g_s16stable0)/INTER_FRAME_NOISE_DIFF_TH ;
            }
        }
        if ( u16NoneNoiFrameCnt > INTER_FRAME_NOISE_AREA_TH )
        {
            break;
        }
    }

    if (u16BigNoiDiffCnt == 0 )
    {
        u16NoneNoiFrameCnt++;
        //CTS_THP_LOGE("u16NoneNoiFrameCnt   %d ", u16NoneNoiFrameCnt);
        if (u16NoneNoiFrameCnt >= NONE_NOISE_FRAME_TH )
        {
            u16NoneNoiFrameCnt =0;
            nobase_even=true;

            if (done_flag == 0)
            {
                int temp = 0;
                for (i = 0; i < COLS; i++)
                {
                    for (j = 0; j < ROWS; j++)
                    {
                        offset = i*ROWS+j;
                        temp = temp + (rawdata[offset])/(FS_RAW_DEST_VALUE/3*5);
                    }
                }

                //CTS_THP_LOGE("111   %d ", temp);
                if (temp == 0)
                {
                    cts_tcs_Calib_update();
                    done_flag = 1;
                    //CTS_THP_LOGE("11111calibra done");
                }

            }

            // CTS_THP_LOGE("find  calibration down-------nobase_even  =  %4d" ,nobase_even);
        }
    }
    else
    {
        if (u16NoneNoiFrameCnt>0)
            u16NoneNoiFrameCnt = u16NoneNoiFrameCnt>>1;
    }


    //CTS_THP_LOGD("u16BigDiffNegCnt=  %4d, u16BigNoiDiffCnt=  %4d, u16NoneNoiFrameCnt  =  %4d ++++++++++++++++++++++++++++++++++++++", u16BigDiffNegCnt, u16BigNoiDiffCnt , u16NoneNoiFrameCnt);
    //CTS_THP_LOGD("nobase_cardinal  =  %4d, nobase_even  =  %4d",  nobase_cardinal ,nobase_even);

    memcpy(grid_last_even_data, rawdata,RAWDATA_SIZE);
    u16BigDiffNegCnt =0;
}

static uint16_t tx1_line_data[(COLS_STYLUS_TIED*ROWS + ROWS_STYLUS_TIED*COLS)];
static uint16_t tx2_line_data[(COLS_STYLUS_TIED*ROWS + ROWS_STYLUS_TIED*COLS)];
void cts_convert_pc_line_data(uint16_t *data, int rows, int cols, bool is_tx2)
{
    int index = 0;
    for (int i = 0; i < rows; i++){
        for (int j = 0; j < cols; j++){
            index = i * cols + j;
#if 0            
            if (index == 0){
                data[index] = tx1PcCoffBuf[index];
                continue;
            }
            if (index == cols - 1){
                data[index] = tx1PcCoffBuf[index];
                continue;
            }
            if (index == cols*rows - cols){
                data[index] = tx1PcCoffBuf[index];
                continue;
            }
            if (index == cols*rows -1){
                data[index] = tx1PcCoffBuf[index];
                continue; 
            }                                           
#endif            
          	if (is_tx2)
            	data[index] = (uint16_t)((data[index] * tx1PcCoffBuf[index]) / 100);
            else
            	data[index] = (uint16_t)((data[index] * tx1PcCoffBuf[index]) / 150);
        }
    }
}
void cts_convert_pr_line_data(uint16_t *data, int rows, int cols, bool is_tx2)
{
    int index = 0;
    for (int i = 0; i < rows; i++){
        for (int j = 0; j < cols; j++){
            index = i * cols + j;
#if 0            
            if (index == 0){
                data[index] = tx1PrCoffBuf[index];
                continue;
            }
            if (index == cols - 1){
                data[index] = tx1PrCoffBuf[index];
                continue;
            }
            if (index == cols*rows - cols){
                data[index] = tx1PrCoffBuf[index];
                continue;
            }
            if (index == cols*rows -1){
                data[index] = tx1PrCoffBuf[index];
                continue; 
            }                                           
#endif     
            if (is_tx2)
            	data[index] = (uint16_t)((data[index] * tx1PrCoffBuf[index]) /100);
            else
            	data[index] = (uint16_t)((data[index] * tx1PrCoffBuf[index]) / 150);
        }
    }
}
void cts_remap_tx_line_data(uint16_t *stylus_frame)
{
    uint16_t offset=0,length=0;
    // uint16_t temp1[COLS_STYLUS_TIED*ROWS],temp2[COLS_STYLUS_TIED*ROWS];
    // uint16_t temp3[ROWS_STYLUS_TIED*COLS],temp4[ROWS_STYLUS_TIED*COLS];
    // uint16_t temp5[COLS_STYLUS_TIED*ROWS],temp6[ROWS_STYLUS_TIED*COLS];

    uint16_t temp1[ROWS_STYLUS_TIED*COLS],temp2[ROWS_STYLUS_TIED*COLS];
    uint16_t temp3[COLS_STYLUS_TIED*ROWS],temp4[COLS_STYLUS_TIED*ROWS];  
    uint16_t temp5[ROWS_STYLUS_TIED*COLS],temp6[COLS_STYLUS_TIED*ROWS]; 

    offset=0;
    length =  sizeof(temp1);
    memcpy(temp1,&stylus_frame[offset],length);

    offset +=ROWS_STYLUS_TIED*COLS;
    length =  sizeof(temp2);
    memcpy(temp2,&stylus_frame[offset], length);

    memcpy(temp5,temp1,sizeof(temp5));
    cts_transposition_pr_data(temp5, temp1, COLS, ROWS_STYLUS_TIED);
    cts_convert_pr_line_data(temp1, COLS, ROWS_STYLUS_TIED, false);
    memcpy(temp5,temp2,sizeof(temp5));
    cts_transposition_pr_data(temp5, temp2, COLS, ROWS_STYLUS_TIED);
    cts_convert_pr_line_data(temp2, COLS, ROWS_STYLUS_TIED, true);

    offset +=ROWS_STYLUS_TIED*COLS;
    length =  sizeof(temp3);
    memcpy(temp3,&stylus_frame[offset], length);

    offset +=COLS_STYLUS_TIED*ROWS;
    length =  sizeof(temp4);
    memcpy(temp4,&stylus_frame[offset], length);

    memcpy(temp6,temp3,sizeof(temp3));
    cts_transposition_pc_data(temp6, temp3, COLS_STYLUS_TIED, ROWS);
    cts_convert_pc_line_data(temp3, COLS_STYLUS_TIED, ROWS, false);
    memcpy(temp6,temp4,sizeof(temp4));
    cts_transposition_pc_data(temp6, temp4, COLS_STYLUS_TIED, ROWS);
    cts_convert_pc_line_data(temp4, COLS_STYLUS_TIED, ROWS, true);

    offset=0;
    length =  sizeof(temp3);
    memcpy(&tx1_line_data[offset],temp3,length);

    offset +=COLS_STYLUS_TIED*ROWS;
    length =  sizeof(temp1);
    memcpy(&tx1_line_data[offset],temp1,length);


    offset=0;
    length =  sizeof(temp4);
    memcpy(&tx2_line_data[offset],temp4,length);

    offset +=COLS_STYLUS_TIED*ROWS;
    length =  sizeof(temp2);
    memcpy(&tx2_line_data[offset],temp2,length);

    //for (offset=0; offset <(COLS_STYLUS_TIED*ROWS + ROWS_STYLUS_TIED*COLS) ; offset++)
    // {
    //tx1_line_data[offset] /=2;
    //}
}

// uint16_t stylusmode_fingerRaw_0[ROWS*COLS/4];
// uint16_t stylusmode_fingerRaw_1[ROWS*COLS/4];
// uint16_t stylusmode_fingerRaw_2[ROWS*COLS/4];
// uint16_t stylusmode_fingerRaw_3[ROWS*COLS/4];
uint16_t stylusmode_fingerRaw_All[ROWS * COLS];
uint8_t stylusFingerStatus = 0;
//#define DUMP_STYLUS_FINGER_DATA
void cts_convert_tylusmode_grid_data(CTS_FRAME_FINGER_STYLUS_STRUCT *cts_merge_frame)
{
    uint16_t length = (int)(ROWS*COLS/4);
    uint16_t offset = 0;
    if (cts_merge_frame->frame_type == FRAME_TYPE_STYLUS_0)
    {
        memcpy(stylusmode_fingerRaw_All,cts_merge_frame->rawdata, length* sizeof(uint16_t));
        stylusFingerStatus |= 1 << 0;
#ifdef DUMP_STYLUS_FINGER_DATA
        CTS_THP_LOGI("frame_type:%2x",cts_merge_frame->frame_type);
        cts_print_stylusdata(1,stylusmode_fingerRaw_All,ROWS/4,COLS );
#endif        
    }
    offset += length;
    if (cts_merge_frame->frame_type == FRAME_TYPE_STYLUS_1)
    {
        memcpy(&stylusmode_fingerRaw_All[offset],cts_merge_frame->rawdata, length* sizeof(uint16_t));
        stylusFingerStatus |= 1 << 1;
#ifdef DUMP_STYLUS_FINGER_DATA        
        CTS_THP_LOGI("frame_type:%2x",cts_merge_frame->frame_type);
        cts_print_stylusdata(1,&stylusmode_fingerRaw_All[offset],ROWS/4,COLS );
#endif        
    }
    offset += length;
    if (cts_merge_frame->frame_type == FRAME_TYPE_STYLUS_2)
    {
        memcpy(&stylusmode_fingerRaw_All[offset],cts_merge_frame->rawdata, length* sizeof(uint16_t));
        stylusFingerStatus |= 1 << 2;
#ifdef DUMP_STYLUS_FINGER_DATA        
        CTS_THP_LOGI("frame_type:%2x",cts_merge_frame->frame_type);
        cts_print_stylusdata(1,&stylusmode_fingerRaw_All[offset],ROWS/4,COLS );
#endif        
    }
    offset += length;
    if (cts_merge_frame->frame_type == FRAME_TYPE_STYLUS_3)
    {
        memcpy(&stylusmode_fingerRaw_All[offset],cts_merge_frame->rawdata, length* sizeof(uint16_t));
        stylusFingerStatus |= 1 << 3;
#ifdef DUMP_STYLUS_FINGER_DATA
        CTS_THP_LOGI("frame_type:%2x",cts_merge_frame->frame_type);
        cts_print_stylusdata(1,&stylusmode_fingerRaw_All[offset],ROWS/4,COLS );
#endif
        if (stylusFingerStatus != 0x0F){
            CTS_THP_LOGI("stylusFingerStatus:%2x",stylusFingerStatus);
            memset(stylusmode_fingerRaw_All,0,sizeof(stylusmode_fingerRaw_All));
            stylusFingerStatus = 0;
        }
    }
}

static int cts_convert_frame(struct timeval *tv,CTS_FRAME_STRUCT *cts_frame,CTS_FRAME_FINGER_STYLUS_STRUCT *cts_merge_frame,THP_AFE_FRAME_DATA_STRUCT *thp_frame,THP_AFE_STYLUS_FRAME_DATA_STRUCT *stylus_frame )
{

    memset(thp_frame, 0, sizeof(*thp_frame));
    memset(stylus_frame, 0, sizeof(*stylus_frame));

    // finger data
    if ( cts_frame->frame_type == FRAME_TYPE_FINGER_0 || cts_frame->frame_type == FRAME_TYPE_FINGER_1 )
    {
        thp_frame->time_stamp.tv_sec = tv->tv_sec;
        thp_frame->time_stamp.tv_usec = tv->tv_usec;

#if  0
    //cts_transposition_grid_data(cts_frame->rawdata, grid_data, ROWS, COLS);
    cts_convert_grid_data(grid_data,grid_data,ROWS, COLS);
#elif  1
    if (((cts_frame->afe_status & THP_AFE_STATUS_CALIBRATION_DONE) == THP_AFE_STATUS_CALIBRATION_DONE)
		&& !first_cali_done)
    {
		first_cali_done = true;

        // cts_remap_grid_data(test_data, baserawdata, ROWS, COLS);
        // dump_spi_full_data(baserawdata, ROWS * COLS);

        cts_remap_grid_data(cts_frame->rawdata, baserawdata, ROWS, COLS);
        //dump_spi_full_data(baserawdata, ROWS * COLS);
        // memcpy(baserawdata, cts_frame->rawdata,ROWS * COLS * 2);
        CTS_THP_LOGI("calibration done, base update.");
    }
    cts_remap_grid_data(cts_frame->rawdata, grid_data, ROWS, COLS);
    //dump_spi_full_data(grid_data, ROWS * COLS);
    cts_convert_grid_data(cts_frame);
#else
		uint16_t i, j;
		for (i = 0; i < (ROWS*COLS); i++)
			grid_data[ROWS*COLS-1-i] = cts_frame->rawdata[i];

		uint16_t tmpdata[ROWS*COLS];
		MEMCPY(tmpdata, grid_data, sizeof(tmpdata));
		for (i = 0; i < COLS; i++) {
			for (j = 0; j < ROWS; j++)
				grid_data[j + i * ROWS] = tmpdata[i + j * COLS];
		}

		cts_convert_grid_data(grid_data, grid_data, ROWS, COLS);
#endif

        thp_frame->frame_index = cts_frame->frame_index;
        thp_frame->grid_data = grid_data;
        thp_frame->line_data = NULL;
        thp_frame->button_data = NULL;
        thp_frame->noise_data = NULL;//cts_frame->finger_noise;
        thp_frame->scan_freq =  cts_frame->finger_scan_freq;
        thp_frame->scan_rate = cts_frame->finger_scan_rate;
        thp_frame->status = cts_frame->afe_status;

        //CTS_THP_LOGD("frame_index=%d,thp_frame->status =%x,scan_freq=%d,frame_type=%x,scan_rate=%d",  cts_frame->frame_index,thp_frame->status, thp_frame->scan_freq , cts_frame->frame_type, thp_frame->scan_rate);


        if ((cts_frame->afe_status & THP_AFE_STATUS_SOS) == THP_AFE_STATUS_SOS)
        {
            cts_print_rawdata(cts_frame->rawdata);
            CTS_THP_LOGI("sos");
        }

        if ( (cts_frame->afe_status & THP_AFE_STATUS_RECAL_REQUEST) == THP_AFE_STATUS_RECAL_REQUEST )
        {
            CTS_THP_LOGI("recalibration request");
        }


        if ( last_afe_status != (cts_frame->afe_status & (THP_AFE_STATUS_IDLE_MODE | THP_AFE_STATUS_ACTIVE_MODE)))
        {
            if ( last_afe_status == THP_AFE_STATUS_IDLE_MODE )
            {
                CTS_THP_LOGI("idle exit[status=0x%x]", cts_frame->afe_status );
                //CTS_THP_LOGD("Set active timeout %d ms after real active", DAEMON_GET_DATA_TIME_OUT_ACTIVE);
                thp_ioctl_set_timeout(DAEMON_GET_DATA_TIME_OUT_ACTIVE);
            }
            else
            {
                CTS_THP_LOGI("idle in[status=0x%x]", cts_frame->afe_status);
                //thp_ioctl_set_timeout(DAEMON_GET_DATA_TIME_OUT_IDLE);
            }
        }

#if 1
        if (abs(last_Frame_index - cts_frame->frame_index ) > 1 && 
            abs(last_Frame_index - cts_frame->frame_index ) < 100 && 
            last_Frame_index !=0)
        {
            CTS_THP_LOGI("LastIndex:%d,CurrentIndex:%d", last_Frame_index,cts_frame->frame_index);
        }
        else
        {
             //CTS_THP_LOGI("CurrentIndex:%d", cts_frame->frame_index);
        }
#endif

        if (last_finger_freq != thp_frame->scan_freq)
        {
            CTS_THP_LOGI("curr_freq=%d,last_freq=%d", thp_frame->scan_freq,last_finger_freq);
        }

        //CTS_THP_LOGI("curr_freq=%d,last_freq=%d", thp_frame->scan_freq,last_finger_freq);

        thp_frame->gesture = cts_frame->gesture_status;
        thp_frame->side_data = NULL;
        thp_frame->force_data = NULL;
        thp_frame->scan_state = THP_AFE_SCAN_STATE_WHOLE;


        thp_frame->stylus = stylus_frame;
        stylus_frame->tx1_line_data = tx1_line_data;
        stylus_frame->tx2_line_data = tx2_line_data;

        // stylus_frame->status = cts_frame->stylus_status|THP_AFE_STATUS_HPP3_0_PROTOCOL|THP_AFE_STATUS_STYLUS_DETECT_MODE;
        stylus_frame->status = THP_AFE_STATUS_HPP3_0_PROTOCOL|THP_AFE_STATUS_STYLUS_DETECT_MODE;
        stylus_frame->pressure = 1;
        stylus_frame->button = 0;
        stylus_frame->stylus_noise = NULL;  //cts_frame->stylus_noise;

        stylus_frame->tx1_scan_freq = cts_frame->stylus_tx1_curr_scan_freq;
        stylus_frame->tx2_scan_freq = cts_frame->stylus_tx2_curr_scan_freq;
        stylus_frame->tx1_new_scan_freq = cts_frame->stylus_tx1_next_scan_freq;
        stylus_frame->tx2_new_scan_freq = cts_frame->stylus_tx2_next_scan_freq;


        if (last_stylus_status)
        {
            CTS_THP_LOGI("stylus out");
        }

        last_afe_status = thp_frame->status & ( THP_AFE_STATUS_IDLE_MODE | THP_AFE_STATUS_ACTIVE_MODE);
        last_stylus_status =0;
        last_finger_freq = thp_frame->scan_freq;
        last_Frame_index = thp_frame->frame_index;

        return 0;
    }// finger data

    if (cts_frame->frame_type == FRAME_TYPE_STYLUS_0 || cts_frame->frame_type == FRAME_TYPE_STYLUS_1 || 
        cts_frame->frame_type == FRAME_TYPE_STYLUS_2 || cts_frame->frame_type == FRAME_TYPE_STYLUS_3)
    {
        memset(stylus_frame, 0, sizeof(*stylus_frame));

        thp_frame->time_stamp.tv_sec = tv->tv_sec;
        thp_frame->time_stamp.tv_usec = tv->tv_usec;
        thp_frame->frame_index = cts_frame->frame_index;

        cts_remap_tx_line_data(cts_merge_frame->stylusdata);
        cts_convert_tylusmode_grid_data(cts_merge_frame);

        // CTS_THP_LOGD("frame_index=%d,thp_frame->status=%x,frame_type=%x,scan_freq=%d,scan_rate=%d", cts_frame->frame_index, thp_frame->status,cts_frame->frame_type,  thp_frame->scan_freq , thp_frame->scan_rate);
        if (cts_frame->frame_type == FRAME_TYPE_STYLUS_3 && stylusFingerStatus == 0x0F){
            cts_remap_grid_data(stylusmode_fingerRaw_All, grid_data, ROWS, COLS);
            //dump_spi_full_data(grid_data, ROWS * COLS);
            cts_convert_grid_data(cts_frame);
            thp_frame->grid_data = grid_data;
            stylusFingerStatus = 0;
        }else{
            thp_frame->grid_data = NULL;
        }
        thp_frame->line_data = NULL;
        thp_frame->button_data = NULL;
        thp_frame->noise_data = NULL;//cts_frame->finger_noise;
        thp_frame->scan_freq =  cts_frame->finger_scan_freq;
        thp_frame->scan_rate = cts_frame->finger_scan_rate;
        thp_frame->status = cts_frame->afe_status;
        thp_frame->status = cts_frame->afe_status & (THP_AFE_STATUS_ACTIVE_MODE|THP_AFE_STATUS_IDLE_MODE);
        thp_frame->gesture = cts_frame->gesture_status;
        thp_frame->side_data = NULL;
        thp_frame->force_data = NULL;
        thp_frame->scan_state = THP_AFE_SCAN_STATE_WHOLE;

        thp_frame->stylus = stylus_frame;
        stylus_frame->tx1_line_data = tx1_line_data;
        stylus_frame->tx2_line_data = tx2_line_data;
        //stylus_frame->status = cts_frame->stylus_status;
        stylus_frame->status = THP_AFE_STATUS_HPP3_0_PROTOCOL|THP_AFE_STATUS_STYLUS_ACTIVE_MODE;
        stylus_frame->pressure = 1;
        stylus_frame->button = 0;
        stylus_frame->stylus_noise = NULL;  //cts_frame->stylus_noise;
        stylus_frame->tx1_scan_freq = cts_frame->stylus_tx1_curr_scan_freq;
        stylus_frame->tx2_scan_freq = cts_frame->stylus_tx2_curr_scan_freq;
        stylus_frame->tx1_new_scan_freq = cts_frame->stylus_tx1_next_scan_freq;
        stylus_frame->tx2_new_scan_freq = cts_frame->stylus_tx2_next_scan_freq;

        if (last_stylus_status != stylus_frame->status)
        {
            CTS_THP_LOGI("stylus in");
        }
        last_afe_status = THP_AFE_STATUS_ACTIVE_MODE ;
        last_stylus_status=stylus_frame->status;
        last_Frame_index= cts_frame->frame_index;

        return 0;
    }

    CTS_THP_LOGE("ERROR!! Should not be here!!");
    return 0;
}

/* thp */
int cts_open(void)
{
    return cts_open_project(PROJECT_ID);
}

int cts_open_project(const char *proj_id)
{
    return strcmp(PROJECT_ID, proj_id);
}

int cts_set_calib_data_callback_func(
    THP_AFE_ERR_ENUM(*calibDataWriteCallback)(void* dataPtr, uint32_t dataLen),
    THP_AFE_ERR_ENUM(*calibDataReadCallback)(void* dataPtr, uint32_t dataLen))
{
    //yjl
    CTS_THP_LOGD("----------cts_set_calib_data_callback_func---");
    return 0;
}

int cts_start(void)
{
    int ret = -1;
    ret = thp_dev_open();
    if (ret < 0)
    {
        ret = thp_dev_open();
        if (ret < 0)
        {
            CTS_THP_LOGE("Open thp device failed");
            return -1;
        }
    }

    ret = cts_prework();
    if (ret < 0)
    {
        CTS_THP_LOGE("Do prework failed");
        return -1;
    }

#ifdef DEBUG_SOCKET_TOOL
    cts_tool_start_thread();
#endif

    ret = thp_dev_set_block(1);
    if (ret < 0)
    {
        ret = thp_dev_set_block(1);
        if (ret < 0)
        {
            CTS_THP_LOGE("Set block 1 failed");
            return -1;
        }
    }

    thp_ioctl_clear_frame_buffer(1);
    ret = thp_ioctl_hal_set_afe_status(2, 0, 0);
    if (ret < 0)
    {
        ret = thp_ioctl_hal_set_afe_status(2, 0, 0);
        if (ret < 0)
        {
            CTS_THP_LOGW("Set afe status 2,0,0 failed");
            return -1;
        }
    }
    thp_ioctl_set_irq(1);
    ret = thp_ioctl_set_timeout(DAEMON_GET_DATA_TIME_OUT_IDLE);
    if (ret)
    {
        ret = thp_ioctl_set_timeout(DAEMON_GET_DATA_TIME_OUT_IDLE);
        if (ret)
            CTS_THP_LOGE("Set timeout failed failed: rc=%d", ret);
    }
    cts_normal_mode_init();

    //cts_tcs_enable_mnt();
    return 0;
}

int cts_stop(void)
{
    int ret;
    ret = cts_postwork();
    if (ret < 0)
    {
        CTS_THP_LOGE("Do postwork failed");
    }

    ret = thp_dev_close();
    if (ret < 0)
    {
        ret = thp_dev_close();
        if (ret < 0)
            CTS_THP_LOGE("Close thp device failed");
    }
    thp_ioctl_clear_frame_buffer(1);
    return 0;
}

void cts_print_fw_status(CTS_FRAME_STRUCT *frame)
{
    CTS_THP_LOGI("cur short mode=%d",frame->points[100]);
    CTS_THP_LOGI("index=%d,type=%x,size=%d,afe_status=%x",frame->index,frame->frame_type,frame->curr_frame_size,frame->afe_status);
    CTS_THP_LOGI("gesture_status=%x,stylus_status=%x,data_type=%x,data_len=%d",frame->gesture_status,frame->stylus_status,frame->data_type,frame->data_len);

#ifdef CTS_FW_DUMP_INFO
    if ((frame->frame_index % FRAME_NUM_TO_PRINT == (FRAME_NUM_TO_PRINT - 1)))
    {
        CTS_THP_LOGI("frame_index=%d",frame->frame_index);
        CTS_ID_INFO_STRUCT *id = (CTS_ID_INFO_STRUCT *)frame;
        for (int i = 0; i < CTS_ID_NUM; i++)
        {
            CTS_THP_LOGI("ID=%d,dbg_cnt=%d,job_id=%d,ddi_line_num=%d,ddi_vsync_cnt=%d,ddi_tps_cnt=%d",\
                     i,(id+i)->dbg_cnt,(id+i)->job_id,(id+i)->ddi_line_num,(id+i)->ddi_vsync_cnt,(id+i)->ddi_tps_cnt);
        }
        CTS_FW_DUMP_INFO_STRUCT *dump_info = (CTS_FW_DUMP_INFO_STRUCT *)frame;
        CTS_THP_LOGI("mstr_scan_go_err0_sts=0x%08x",dump_info->mstr_scan_go_err0_sts);
        CTS_THP_LOGI("mstr_scan_go_err1_sts=0x%08x",dump_info->mstr_scan_go_err1_sts);
        CTS_THP_LOGI("slave_scan_go_err0_sts=0x%08x",dump_info->slave_scan_go_err0_sts);
        CTS_THP_LOGI("slave_scan_go_err1_sts=0x%08x",dump_info->slave_scan_go_err1_sts);
        CTS_THP_LOGI("mstr_dmct_go_err0=0x0x%08x",dump_info->mstr_dmct_go_err0);
        CTS_THP_LOGI("mstr_dmct_go_err1=0x%08x",dump_info->mstr_dmct_go_err1);
        CTS_THP_LOGI("slave_dmct_go_err0=0x%08x",dump_info->slave_dmct_go_err0);
        CTS_THP_LOGI("slave_dmct_go_err1=0x%08x",dump_info->slave_dmct_go_err1);
        CTS_THP_LOGI("ddi_r_0A=0x%02x",dump_info->ddi_r_0A);
        CTS_THP_LOGI("ddi_fsm_state=0x%02x",dump_info->ddi_fsm_state);
    }
#endif

	cts_tcs_get_debug_info();
}

static bool cts_enter_spec_mode(void)
{
    if (nonblock == SCREEN_OFF_FLAG)
    {
        CTS_THP_LOGI("Get frame with nonblock or tui mode");
        return true;
    }
    return false;
}

/*
struct timeval
{
__time_t  tv_sec;        // Seconds.
__suseconds_t  tv_usec;  // Microseconds.
};

*/

THP_AFE_FRAME_DATA_STRUCT *cts_get_frame(void)
{
    CTS_FRAME_STRUCT *cts_frame;
	TIME_T start_tv;
    long elapsed_ms;
    int ret = -1;
    uint32_t count = 0;

    gettimeofday(&start_tv, NULL);

    //CTS_THP_LOGE("get_frame + ");

    ret = thp_ioctl_get_frame_count(&count);
    if (ret)
    {
        CTS_THP_LOGE("Get frame count failed");
    }
    else if (count > 0)
    {
        CTS_THP_LOGI("driver busy. get_frame_count=%d", count);
    }

    ret = cts_ioctl_get_frame(&g_ioctl_frame);
    if (ret)
    {
        CTS_THP_LOGE("Get frame from kernel failed");
        goto end_get_frame;
    }

    // CTS_THP_LOGE("check_frame + ");
    ret = cts_check_ioctl_frame(&g_ioctl_frame);
    if (ret)
    {
        CTS_THP_LOGE("Invalid frame check, ret:%d", ret);
        goto end_get_frame;
    }

    cts_frame = (CTS_FRAME_STRUCT *)&g_ioctl_frame.frame;
    current_afe_data_type = cts_frame->frame_type;

    if ( cts_frame->frame_type == FRAME_TYPE_FINGER_0 || cts_frame->frame_type == FRAME_TYPE_FINGER_1 )
    {
        // CTS_THP_LOGI("send cmd");
        tcs_cmd_delay_start();
    }

#ifdef DEBUG_SOCKET_TOOL
    cts_frame->magic_number = cts_frame->magic_number & 0xFFFF0000;
    cts_frame->magic_number |= cts_frame->frame_index;
    cts_tool_send_data_to_client(cts_frame);
    cts_tool_save_frame_data(cts_frame);
#endif

    //cts_print_rawdata(cts_frame->rawdata);

    if(0)
    cts_print_fw_status(cts_frame);

    ret = cts_convert_frame(&g_ioctl_frame.tv,cts_frame,(CTS_FRAME_FINGER_STYLUS_STRUCT *)g_ioctl_frame.frame,&g_thp_frame,&g_stylus_frame);
    if (ret)
    {
        CTS_THP_LOGE("Convert frames failed");
        goto end_get_frame;
    }

	if (cts_frame->points[11] == 88) {
		CTS_THP_LOGE("Trigger Display ESD Flow, Get ESD info");
		
		CTS_THP_LOGD("%+18s = 0x%02x, %+18s = 0x%02x",
			"u8MstrDdiRAC", cts_frame->points[12], "u8SlvDdiRAC", cts_frame->points[17]);
		CTS_THP_LOGD("%+18s = 0x%02x, %+18s = 0x%02x",
			"u8MstrDdiR0A", cts_frame->points[13], "u8SlvDdiR0A", cts_frame->points[18]);
		CTS_THP_LOGD("%+18s = 0x%02x, %+18s = 0x%02x",
			"u8MstrDdiRD7", cts_frame->points[14], "u8SlvDdiRD7", cts_frame->points[19]);
		CTS_THP_LOGD("%+18s = 0x%02x, %+18s = 0x%02x",
			"u8MstrDdiR7A", cts_frame->points[15], "u8SlvDdiR7A", cts_frame->points[20]);
		CTS_THP_LOGD("%+18s = 0x%02x, %+18s = 0x%02x",
			"u8MstrDdiRD3", cts_frame->points[16], "u8SlvDdiRD3", cts_frame->points[21]);
	}

end_get_frame:
    elapsed_ms = ELAPSED_MS(start_tv);
    if (ret == 0)
    {
        //CTS_THP_LOGE("Get frame OK,cost %lldms", elapsed_ms);
        return &g_thp_frame;
    }else{        
        if ( cts_enter_spec_mode() )
            return NULL;

        cts_print_fw_status(cts_frame);
        if (elapsed_ms < GET_FRAME_TIMEOUT_MS)
        {
            CTS_THP_LOGE("Get frame error,cost %lldms", elapsed_ms);
        }else{
            CTS_THP_LOGE("Get frame failed timeout, time: %dms", elapsed_ms);
        }
    }

    return NULL;
}

int cts_clear_status(THP_AFE_STATUS_ENUM status)
{
    CTS_THP_LOGD("Clear status=0x%4x", status);
    //yjl
    cts_tcs_clear_status(status);
	
    return 0;
}

void cts_screen_on_off_setflag(int flag)
{
    nonblock = flag;
}

int cts_screen_off(void)
{
    int ret;
    cts_screen_on_off_setflag(SCREEN_OFF_FLAG );
    cts_normal_mode_init();
    g_esd_flag = false;

    // cts_tool_start_gesture_data_thread();
    thp_ioctl_clear_frame_buffer(1);

    ret = thp_dev_set_block(0);
    if (ret < 0)
    {
        CTS_THP_LOGE("Set block 0 failed");
        return -1;
    }
    return 0;
}

int cts_screen_on(void)
{
    int ret;

    cts_screen_on_off_setflag(SCREEN_ON_FLAG );
    // cts_tool_stop_gesture_data_thread();
    if (cts_NeedUpgradeCheck())
    {
        ret = cts_DoUpgrade();
        if (ret < 0)
        {
            CTS_THP_LOGE("Update firmware failed");
            return -1;
        }
    }

    ret = thp_ioctl_clear_frame_buffer(1);
    if (ret < 0)
    {
        CTS_THP_LOGI("Clear frame buffer failed");
    }

    ret = thp_dev_set_block(1);
    if (ret < 0)
    {
        ret = thp_dev_set_block(1);
        if (ret < 0)
        {
            CTS_THP_LOGE("Set block 0 failed");
            return -1;
        }
    }

    ret = thp_ioctl_hal_set_afe_status(2, 0, 0);
    if (ret < 0)
    {
        CTS_THP_LOGW("Set afe status 2,0,0 failed");
    }

    thp_ioctl_set_irq(1);
    ret = thp_ioctl_set_timeout(DAEMON_GET_DATA_TIME_OUT_IDLE);
    if (ret)
    {
        ret = thp_ioctl_set_timeout(DAEMON_GET_DATA_TIME_OUT_IDLE);
        if (ret)
            CTS_THP_LOGE("Set timeout failed failed: rc=%d", ret);
    }

    cts_normal_mode_init();
    //cts_tcs_enable_mnt();

    return 0;
}


int cts_set_idle_touch_threshold(uint16_t threshold)
{

return 0;

#ifdef  MNT_EXIT_THD_DEFINED_BY_FW
    return 0;

#elif  (defined DECREASE_MNT_CMD)
    // Decrease cmd for DP416
    CTS_THP_LOGE("default--invalid");
    return 0;
#else
    MntOptions options;
    int rc;

    rc = cts_tcs_get_mnt_options(&options);
    if (rc)
    {
        CTS_THP_LOGE("Get monitor options failed: rc=%d", rc);
        return -1;
    }

    /*
        CTS_THP_LOGD("baseTraceMntEn: %d", options.baseTraceMntEn);
        CTS_THP_LOGD("reportRateDownRatio: %d", options.reportRateDownRatio);
        CTS_THP_LOGD("CfbAdjMnt: %d", options.CfbAdjMnt);
        CTS_THP_LOGD("CycleNumMnt: %d", options.CycleNumMnt);
        CTS_THP_LOGD("MntTpTh: %d", options.MntTpTh);
        CTS_THP_LOGD("EnterMntCnt: %d", options.EnterMntCnt);
        CTS_THP_LOGD("Vstim0LevelMnt: %d", options.Vstim0LevelMnt);
        CTS_THP_LOGD("ShiftNumMnt: %d", options.ShiftNumMnt);
        CTS_THP_LOGD("MntToNormalCnt: %d", options.MntToNormalCnt);
    */

    options.MntTpTh = threshold;
    CTS_THP_LOGD("Set idle threshold: %d", options.MntTpTh);
    rc = cts_tcs_set_mnt_options(&options);
    if (rc)
    {
        CTS_THP_LOGE("Set monitor options failed: rc=%d", rc);
        return -1;
    }
    return 0;
#endif
}


int cts_set_baseline_update_interval(uint16_t interval)
{

return 0;

#ifdef  MNT_EXIT_THD_DEFINED_BY_FW
    return 0;
#elif  (defined DECREASE_MNT_CMD)
    // Decrease cmd for DP416
    CTS_THP_LOGE("default--invalid");
    return 0;
#else

    MntOptions options;
    int rc;
    rc = cts_tcs_get_mnt_options(&options);
    if (rc)
    {
        CTS_THP_LOGE("Get monitor options failed: rc=%d", rc);
        return -1;
    }

    /*
        CTS_THP_LOGD("baseTraceMntEn: %d", options.baseTraceMntEn);
        CTS_THP_LOGD("reportRateDownRatio: %d", options.reportRateDownRatio);
        CTS_THP_LOGD("CfbAdjMnt: %d", options.CfbAdjMnt);
        CTS_THP_LOGD("CycleNumMnt: %d", options.CycleNumMnt);
        CTS_THP_LOGD("MntTpTh: %d", options.MntTpTh);
        CTS_THP_LOGD("EnterMntCnt: %d", options.EnterMntCnt);
        CTS_THP_LOGD("Vstim0LevelMnt: %d", options.Vstim0LevelMnt);
        CTS_THP_LOGD("ShiftNumMnt: %d", options.ShiftNumMnt);
        CTS_THP_LOGD("MntToNormalCnt: %d", options.MntToNormalCnt);
    */

    options.MntToNormalCnt = (uint16_t)(60 * interval / 1000);
    CTS_THP_LOGD("Set intverval %d to %d", interval, options.MntToNormalCnt);

    rc = cts_tcs_set_mnt_options(&options);
    if (rc)
    {
        CTS_THP_LOGE("Set monitor options failed: rc=%d", rc);
        return -1;
    }

    return 0;
#endif

}

int cts_enter_idle(void)
{

// return 0;

#ifdef DISABLE_IDLE
    CTS_THP_LOGI("Enter idle invalid");
    return 0;
#else
    int rc;

    CTS_THP_LOGI("Enter idle+");

    //CTS_THP_LOGD("Set idle timeout  %d ms before real idle",DAEMON_GET_DATA_TIME_OUT_IDLE);
    rc = thp_ioctl_set_timeout(DAEMON_GET_DATA_TIME_OUT_IDLE);
    if (rc)
    {
        CTS_THP_LOGE("Set timeout failed failed: rc=%d", rc);
        return -1;
    }

    rc = cts_tcs_force_enter_mnt();
    if (rc)
    {
        CTS_THP_LOGE("Enter monitor mode failed: rc=%d", rc);
        return -1;
    }
    //CTS_THP_LOGD("Enter idle-");
    return 0;
#endif
}

int cts_exit_idle(void)
{
    int rc =0;

    //CTS_THP_LOGD("Exit idle");
    rc = cts_tcs_force_exit_mnt();
    if (rc)
    {
        CTS_THP_LOGE("Exit monitor mode failed: rc=%d", rc);
        return -1;
    }
    //CTS_THP_LOGD("Set active timeout value after real active");
    return 0;
}


int cts_force_to_freq_point(uint8_t index)
{
    if (index >= 0 && index < MAX_NUM_SCAN_FREQ)
    {
        //yjl update
        return cts_tcs_set_scan_freq(index);
    }
    return -1;
}

//yjl
int cts_freq_shift_switch(uint8_t enable)
{
    return cts_tcs_freq_shift_switch(enable);
}

bool cts_afe_is_esd_triggered(void)
{
    if (g_esd_flag)
    {
        CTS_THP_LOGE("esd happened, report one time!!!");
        return false;
    }
    g_esd_flag = (g_thp_frame.status & 0x40) == 0x40;
    return g_esd_flag;
}
