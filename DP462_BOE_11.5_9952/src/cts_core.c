#include "cts_core.h"
#include "cts_hal.h"

#ifndef PROJECT_ID
#error "PROJECT_ID UNDEFINED!"
#endif

#include "thp_ioctl.h"
#include "cts_log.h"
#include "cts_utils.h"
#include "cts_prog.h"
#include "cts_tcs.h"
#include "cts_spi.h"
#include "cts_tool.h"
#include "cts_tcs.h"
#include "thp_afe_hal.h"

//static int cnt = 0;
//#define DEBUG_NOISE

#define TCS_RET_CODE_OK                 0
#define TCS_CMD_VALUE                   0x4122

#define STYLUS_COL_AFTER_TIED           8
#define STYLUS_ROW_AFTER_TIED           12

#define STYLUS_PR_ITEM_SIZE             (COLS * STYLUS_ROW_AFTER_TIED)
#define STYLUS_PC_ITEM_SIZE             (ROWS * STYLUS_COL_AFTER_TIED)

#define STYLUS_PC1_ITEM_OFFSET          000
#define STYLUS_PC2_ITEM_OFFSET          200
#define STYLUS_PR1_ITEM_OFFSET          400
#define STYLUS_PR2_ITEM_OFFSET          600
#define STYLUS_PCR_TATAL_SIZE           800
#define RAW_DEST_DATA                   2500
#define STYLUS_FRAME_TV_ADJUST          3000//4167
#define MAGIC_NUMBER                    0xFEFCF8F0
#define DOUBLE_RATA                     0

static bool first_cali_done = false;

static THP_AFE_FRAME_DATA_STRUCT g_thp_frame;
static THP_AFE_STYLUS_FRAME_DATA_STRUCT g_stylus_frame;
static CTS_IOCTL_FRAME_STRUCT g_ioctl_frame;
uint16_t  g_version=0;
extern uint16_t s_scan_freq[MAX_NUM_SCAN_FREQ];
extern uint16_t s_scan_rate[MAX_NUM_SCAN_RATE];
extern uint16_t s_Fs_raw_dest_value;
uint16_t  last_afe_status=2;
uint16_t  last_stylus_status=0;
uint16_t  last_finger_freq=97;
uint16_t  last_Frame_index=0;
uint16_t  current_afe_data_type = FRAME_TYPE_FINGER_0;
uint16_t  baserawdata[ROWS*COLS] = {0};


int nonblock = SCREEN_ON_FLAG;            //for screenon/screenoff
uint8_t  g_tcs_cmd[MAX_TCS_CMD_NUM] = {0};
static volatile bool g_esd_flag = false;
extern void cts_get_fwfile_version(uint16_t *getfileFwversion);
extern int cts_update_firmware(void);
static THP_AFE_INFO_STRUCT g_thp_info =
{
    VENDOR_NAME,
    PRODUCT_NAME,
    AFE_VERSION,
};

THP_AFE_INFO_STRUCT *cts_get_info(void)
{
    char buf[32];
    snprintf(buf, 32, "HAL%s_FW%04x", AFE_VERSION, g_version);
    MEMCPY(g_thp_info.version, buf, 32);
    CTS_THP_LOGI("%s[VENDOR_NAME], %s[PRODUCT_NAME], %s, build at %s %s",VENDOR_NAME, PRODUCT_NAME, g_thp_info.version, __TIME__, __DATE__);
    return &g_thp_info;
}

void cts_reset_device_hardware(void)
{
    CTS_THP_LOGD("Reset the device");
    thp_ioctl_reset(1);
    mdelay(1);
    thp_ioctl_reset(0);
    mdelay(5);   // min 20ms   safe 60ms
    thp_ioctl_reset(1);
    mdelay(90);      //2024/11/29 modified by mbteng// min 120ms   safe 150ms
}

void cts_reset_hal_buffer(void)
{
    //hal buffer clear
    thp_ioctl_clear_frame_buffer(1);
}

void cts_reset_device(void)
{
    // ic reset
    cts_reset_device_hardware();
    // hal buffer clear
    cts_reset_hal_buffer();
}

int wait_to_norm(uint16_t retryMax, uint16_t  time1msDelay)
{
    uint16_t i = 0;
    int ret;
    uint8_t work_mode;

    do
    {
        ret = cts_tcs_get_work_mode(&work_mode);

        CTS_THP_LOGI("Wait firmware to normal work mode=%d, retry times:%d",work_mode, i*10);

        if (ret == 0 && work_mode == CTS_FIRMWARE_WORK_MODE_NORM)
        {
            return 0;
        }
        else
        {
            CTS_THP_LOGD("Get firmware work mode failed, work_mode: %d", work_mode );
            ret = -1;
            mdelay(time1msDelay);
            continue;
        }
    }
    while ((++i) < retryMax);

    return ret;
}

int wait_to_curr_mode(uint16_t retryMax, uint16_t  time1msDelay)
{
    int i = 0;
    int ret;
    uint8_t curr_mode;

    do
    {
        CTS_THP_LOGI("Wait firmware to WORK_MODE_OPEN_SHORT work, times:%d", i*10);
        ret = cts_tcs_get_curr_mode(&curr_mode);
        if (ret == 0 && curr_mode == CTS_FIRMWARE_WORK_MODE_OPEN_SHORT)
        {
            return 0;
        }
        else
        {
            CTS_THP_LOGI("Get firmware work mode failed, curr_mode: %d", curr_mode);

            ret = -1;
            mdelay(time1msDelay);
            continue;
        }
    }
    while (++i < retryMax);

    return ret;
}

int wait_to_cfg_mode(void)
{
    int i = 0;
    int ret;
    uint8_t work_mode;

    do
    {
        CTS_THP_LOGI("Wait firmware to CTS_FIRMWARE_WORK_MODE_CFG work, times:%d", i);
        ret = cts_tcs_get_work_mode(&work_mode);
        if (ret == 0 && work_mode == CTS_FIRMWARE_WORK_MODE_CFG)
        {
            return 0;
        }
        else
        {
            CTS_THP_LOGE("Get firmware work mode failed, curr_mode: %d", work_mode);
            ret = -1;
            mdelay(10);
            continue;
        }
    }
    while (++i < 150);

    return ret;
}

int cts_NeedUpgradeCheck(void)
{
    int ret = -1;
    int needUpgradeFw = 0;
    uint16_t fw_ver = 0xFFFF;
    uint16_t getfileFwversion=0x00;

    cts_get_fwfile_version( &getfileFwversion );

    CTS_THP_LOGI("get_fw_ver before upgrade ");
    ret = cts_tcs_get_fw_ver(&fw_ver);
    if (ret < 0)
    {
        needUpgradeFw = 1;
        CTS_THP_LOGE("get_fw_ver failed.Do upgrade.needUpgradeFw=%d",needUpgradeFw);
        return needUpgradeFw;
    }
    else
    {
        g_version = fw_ver;
        CTS_THP_LOGI("get_current_fw_ver = 0x%x.", fw_ver);
        if (getfileFwversion == fw_ver)
        {
            CTS_THP_LOGI("0x%x[getFileFwVer] == 0x%x[current_fw_ver]. Do not upgrade.needUpgradeFw=%d", getfileFwversion,fw_ver,needUpgradeFw);
            return needUpgradeFw;
        }
        else
        {
            needUpgradeFw = 1;
            CTS_THP_LOGI("0x%x[getFileFwVer] != 0x%x[current_fw_ver]. Do upgrade.needUpgradeFw=%d", getfileFwversion,fw_ver,needUpgradeFw);
            return needUpgradeFw;
        }
    }
    return needUpgradeFw;
}

int cts_DoUpgrade(void)
{
    int ret = -1;
    uint16_t fw_ver = 0xFFFF;
    CTS_THP_LOGD("Set spi speed 12M--start");
    ret = cts_set_spi_speed(12000000);
    if (ret < 0)
    {
        CTS_THP_LOGI("Set spi speed failed");
    }

    ret = cts_update_firmware();
    if (ret < 0)
    {
        CTS_THP_LOGE("Update firmware failed");
        return -1;
    }

    CTS_THP_LOGE("Update firmware pass");

    CTS_THP_LOGD("Set spi speed 25M--start");
    ret = cts_set_spi_speed(25000000);
    mdelay(5);

    ret = cts_tcs_get_fw_ver(&fw_ver);
    if (ret < 0)
    {
        CTS_THP_LOGE("get_fw_ver failed");
    }
    else
    {
        CTS_THP_LOGI("get current fw ver = %x", fw_ver);
    }

    return 0;
}


static int cts_prework(void)
{
    int ret = -1;
#if  0
    int i;
    uint8_t value[16] = {0};
    CTS_THP_LOGE("0x791F0: read");
    ret = cts_tcs_read_hw_reg(0x791F0, value, sizeof(value));
    if (ret < 0)
    {
        CTS_THP_LOGE("0x791F0: readfailed");
    }

    for (i = 0; i < 16; i++)
    {
        CTS_THP_LOGE("[%2d]:%02x", i, value[i]);
    }

#endif

    cts_reset_device();

    //if (cts_NeedUpgradeCheck() || g_esd_flag)
    if (cts_NeedUpgradeCheck())
    {
        ret = cts_DoUpgrade();
        if (ret < 0)
        {
            CTS_THP_LOGE("Update firmware failed");
            return -1;
        }

        ret = cts_force_get_hw_cap();
        if (ret < 0)
        {
            CTS_THP_LOGE("Get hw_cap failed");

            return -1;
        }
    }
    else
    {
        ret = cts_force_get_hw_cap();
        if (ret < 0)
        {
            CTS_THP_LOGE("Get hw_cap failed");
            return -1;
        }
    }

    //g_esd_flag = false;

    return 0;
}

static int cts_postwork(void)
{
    CTS_THP_LOGE("WARN: Do post work??");

    cts_tcs_set_pwr_mode(2);

    return 0;
}

void cts_normal_mode_init(void)
{
    last_afe_status = THP_AFE_STATUS_ACTIVE_MODE ;
    last_stylus_status = 0;
    inspect_flag = INSPECT_NORMAL_FLAG;
    MEMSET(g_tcs_cmd,0,sizeof(g_tcs_cmd));
}

bool cts_switch_mode(uint8_t i)
{
    //CTS_THP_LOGI("clear level:0x%d", i);
    switch (i)
    {
        case TCS_ENTER_IDLE_LEVEL:
            cts_enter_idle();
            g_tcs_cmd[TCS_ENTER_IDLE_LEVEL] = 0;
            return true;//false;

        case  TCS_CLEAR_STATUS_CALIBRATE_DONE_LEVEL:
            cts_clear_status(THP_AFE_STATUS_CALIBRATION_DONE);
			first_cali_done = false;
            g_tcs_cmd[TCS_CLEAR_STATUS_CALIBRATE_DONE_LEVEL] = 0;
            return true;

        case TCS_CLEAR_STATUS_FREQ_SHIFT_LEVEL:
            cts_clear_status(THP_AFE_STATUS_FREQ_SHIFT_DONE);
            g_tcs_cmd[TCS_CLEAR_STATUS_FREQ_SHIFT_LEVEL] = 0;
            return true;

        default:
            CTS_THP_LOGI("INVALID VALUE: %{public}d", i);
            return true;
    }

}

void  tcs_cmd_delay_start(void)
{
    uint8_t i;
    for (i = 0; i <  MAX_TCS_CMD_NUM; i++)
    {
        if (g_tcs_cmd[i])
        {
            if ( cts_switch_mode(i) )
            {
                break;
            }
        }
    }
}

static int cts_ioctl_get_frame(CTS_IOCTL_FRAME_STRUCT *ioctl_frame)
{
    int ret = -1;
    uint8_t *frame = ioctl_frame->frame;
    size_t framelen = sizeof(ioctl_frame->frame);
    struct timeval *tv = &ioctl_frame->tv;

    memset(ioctl_frame, 0, sizeof(*ioctl_frame));
    ret = thp_ioctl_get_frame(frame, framelen, tv);
    if (ret < 0)
    {
        CTS_THP_LOGE("Ioctl cts_get_frame failed: %s", strerror(errno));
        ret  = cts_tcs_get_debug_info();
        return -1;
    }
    ioctl_frame->framelen = framelen;

    return 0;
}

static int cts_check_ioctl_frame(CTS_IOCTL_FRAME_STRUCT *ioctl_frame)
{
    CTS_FRAME_STRUCT *cts_frame = (CTS_FRAME_STRUCT *)ioctl_frame->frame;
    tcs_rx_tail *cts_tcs_ret = (tcs_rx_tail *)
                               (ioctl_frame->frame + FRAME_SIZE);
    uint16_t crc16_calc;

    if (cts_frame->magic_number != MAGIC_NUMBER)
    {
        CTS_THP_LOGE("cts_get_frame Invalid magic number: recv %#010x calc %#010x",
                 cts_frame->magic_number, MAGIC_NUMBER);
        return -1;
    }

    if (cts_frame->curr_frame_size > FRAME_SIZE_HAS_TAIL  )
    {
        CTS_THP_LOGE("cts_get_frame Invalid current frame size: %d > %d",
                 cts_frame->curr_frame_size, FRAME_SIZE_HAS_TAIL);
        return -1;
    }

    if (cts_frame->curr_frame_size < CURRENT_FRAME_MIN_SIZ)
    {
        CTS_THP_LOGE("cts_get_frame Invalid current frame size: %d < ",
                 cts_frame->curr_frame_size, CURRENT_FRAME_MIN_SIZ);
        return -1;
    }

    //  if (cts_frame->next_frame_size > FRAME_SIZE_HAS_TAIL)
    // {
    //    CTS_THP_LOGE("cts_get_frame Invalid next frame size: %d", cts_frame->next_frame_size);
    //      return -1;
    //  }

    crc16_calc = cts_crc16((const uint8_t *)cts_frame,FRAME_SIZE_HAS_TAIL - sizeof(uint16_t));
    if (cts_tcs_ret->crc16 != crc16_calc)
    {
        CTS_THP_LOGE("cts_get_frame Invalid crc16: recv %#06x calc %#06x",
                 cts_tcs_ret->crc16, crc16_calc);
        return -1;
    }

    if (cts_tcs_ret->cmd != TCS_CMD_VALUE)
    {
        CTS_THP_LOGE("cts_get_frame Invalid cmd value: recv %#06x expect %#06x",
                 cts_tcs_ret->cmd, TCS_CMD_VALUE);
        return -1;
    }

    if (cts_tcs_ret->ecode != TCS_RET_CODE_OK)
    {
        CTS_THP_LOGE("cts_get_frame Invalid ret code: recv %d expect %d",
                 cts_tcs_ret->ecode, TCS_RET_CODE_OK);
        return -1;
    }
    return 0;
}

uint16_t FsCoffBuFreq2[ROWS*COLS] =
{
    304,305,306,307,308,309,311,312,313,314,315,316,318,319,320,321,323,324,325,326,328,329,330,332,333,334,336,337,338,340,341,342,
    306,307,308,309,311,312,313,314,315,316,318,319,320,321,323,324,325,326,328,329,330,332,333,334,336,337,338,340,341,342,344,345,
    308,309,311,312,313,314,315,316,318,319,320,321,323,324,325,326,328,329,330,332,333,334,336,337,338,340,341,342,344,345,347,348,
    311,312,313,314,315,316,318,319,320,321,323,324,325,326,328,329,330,332,333,334,336,337,338,340,341,342,344,345,347,348,350,351,
    313,314,315,316,318,319,320,321,323,324,325,326,328,329,330,332,333,334,336,337,338,340,341,342,344,345,347,348,350,351,352,354,
    315,316,318,319,320,321,323,324,325,326,328,329,330,332,333,334,336,337,338,340,341,342,344,345,347,348,350,351,352,354,355,357,
    318,319,320,321,323,324,325,326,328,329,330,332,333,334,336,337,338,340,341,342,344,345,347,348,350,351,352,354,355,357,358,360,
    320,321,323,324,325,326,328,329,330,332,333,334,336,337,338,340,341,342,344,345,347,348,350,351,352,354,355,357,358,360,362,363,
    323,324,325,326,328,329,330,332,333,334,336,337,338,340,341,342,344,345,347,348,350,351,352,354,355,357,358,360,362,363,365,366,
    325,326,328,329,330,332,333,334,336,337,338,340,341,342,344,345,347,348,350,351,352,354,355,357,358,360,362,363,365,366,368,370,
    328,329,330,332,333,334,336,337,338,340,341,342,344,345,347,348,350,351,352,354,355,357,358,360,362,363,365,366,368,370,371,373,
    330,332,333,334,336,337,338,340,341,342,344,345,347,348,350,351,352,354,355,357,358,360,362,363,365,366,368,370,371,373,375,376,
    333,334,336,337,338,340,341,342,344,345,347,348,350,351,352,354,355,357,358,360,362,363,365,366,368,370,371,373,375,376,378,380,
    336,337,338,340,341,342,344,345,347,348,350,351,352,354,355,357,358,360,362,363,365,366,368,370,371,373,375,376,378,380,381,383,
    338,340,341,342,344,345,347,348,350,351,352,354,355,357,358,360,362,363,365,366,368,370,371,373,375,376,378,380,381,383,385,387,
    341,342,344,345,347,348,350,351,352,354,355,357,358,360,362,363,365,366,368,370,371,373,375,376,378,380,381,383,385,387,388,390,
    344,345,347,348,350,351,352,354,355,357,358,360,362,363,365,366,368,370,371,373,375,376,378,380,381,383,385,387,388,390,392,394,
    347,348,350,351,352,354,355,357,358,360,362,363,365,366,368,370,371,373,375,376,378,380,381,383,385,387,388,390,392,394,396,398,
    350,351,352,354,355,357,358,360,362,363,365,366,368,370,371,373,375,376,378,380,381,383,385,387,388,390,392,394,396,398,400,401,
    352,354,355,357,358,360,362,363,365,366,368,370,371,373,375,376,378,380,381,383,385,387,388,390,392,394,396,398,400,401,403,405,
    355,357,358,360,362,363,365,366,368,370,371,373,375,376,378,380,381,383,385,387,388,390,392,394,396,398,400,401,403,405,407,409,
    358,360,362,363,365,366,368,370,371,373,375,376,378,380,381,383,385,387,388,390,392,394,396,398,400,401,403,405,407,409,411,413,
    362,363,365,366,368,370,371,373,375,376,378,380,381,383,385,387,388,390,392,394,396,398,400,401,403,405,407,409,411,413,415,417,
    365,366,368,370,371,373,375,376,378,380,381,383,385,387,388,390,392,394,396,398,400,401,403,405,407,409,411,413,415,417,420,422,
    368,370,371,373,375,376,378,380,381,383,385,387,388,390,392,394,396,398,400,401,403,405,407,409,411,413,415,417,420,422,424,426,
    371,373,375,376,378,380,381,383,385,387,388,390,392,394,396,398,400,401,403,405,407,409,411,413,415,417,420,422,424,426,428,430,
    375,376,378,380,381,383,385,387,388,390,392,394,396,398,400,401,403,405,407,409,411,413,415,417,420,422,424,426,428,430,432,435,
    378,380,381,383,385,387,388,390,392,394,396,398,400,401,403,405,407,409,411,413,415,417,420,422,424,426,428,430,432,435,437,439,
    381,383,385,387,388,390,392,394,396,398,400,401,403,405,407,409,411,413,415,417,420,422,424,426,428,430,432,435,437,439,442,444,
    385,387,388,390,392,394,396,398,400,401,403,405,407,409,411,413,415,417,420,422,424,426,428,430,432,435,437,439,442,444,446,449,
    388,390,392,394,396,398,400,401,403,405,407,409,411,413,415,417,420,422,424,426,428,430,432,435,437,439,442,444,446,449,451,454,
    392,394,396,398,400,401,403,405,407,409,411,413,415,417,420,422,424,426,428,430,432,435,437,439,442,444,446,449,451,454,456,459,
    396,398,400,401,403,405,407,409,411,413,415,417,420,422,424,426,428,430,432,435,437,439,442,444,446,449,451,454,456,459,461,464,
    400,401,403,405,407,409,411,413,415,417,420,422,424,426,428,430,432,435,437,439,442,444,446,449,451,454,456,459,461,464,466,469,
    403,405,407,409,411,413,415,417,420,422,424,426,428,430,432,435,437,439,442,444,446,449,451,454,456,459,461,464,466,469,471,474,
    407,409,411,413,415,417,420,422,424,426,428,430,432,435,437,439,442,444,446,449,451,454,456,459,461,464,466,469,471,474,477,480,
    411,413,415,417,420,422,424,426,428,430,432,435,437,439,442,444,446,449,451,454,456,459,461,464,466,469,471,474,477,480,482,485,
    415,417,420,422,424,426,428,430,432,435,437,439,442,444,446,449,451,454,456,459,461,464,466,469,471,474,477,480,482,485,488,491,
    420,422,424,426,428,430,432,435,437,439,442,444,446,449,451,454,456,459,461,464,466,469,471,474,477,480,482,485,488,491,494,497,
    424,426,428,430,432,435,437,439,442,444,446,449,451,454,456,459,461,464,466,469,471,474,477,480,482,485,488,491,494,497,500,502,
    428,430,432,435,437,439,442,444,446,449,451,454,456,459,461,464,466,469,471,474,477,480,482,485,488,491,494,497,500,502,506,509,
    432,435,437,439,442,444,446,449,451,454,456,459,461,464,466,469,471,474,477,480,482,485,488,491,494,497,500,502,506,509,512,515,
    437,439,442,444,446,449,451,454,456,459,461,464,466,469,471,474,477,480,482,485,488,491,494,497,500,502,506,509,512,515,518,521,
    442,444,446,449,451,454,456,459,461,464,466,469,471,474,477,480,482,485,488,491,494,497,500,502,506,509,512,515,518,521,525,528,
    446,449,451,454,456,459,461,464,466,469,471,474,477,480,482,485,488,491,494,497,500,502,506,509,512,515,518,521,525,528,531,535,
    451,454,456,459,461,464,466,469,471,474,477,480,482,485,488,491,494,497,500,502,506,509,512,515,518,521,525,528,531,535,538,541,
    456,459,461,464,466,469,471,474,477,480,482,485,488,491,494,497,500,502,506,509,512,515,518,521,525,528,531,535,538,541,545,549,
    461,464,466,469,471,474,477,480,482,485,488,491,494,497,500,502,506,509,512,515,518,521,525,528,531,535,538,541,545,549,552,556,
};

uint16_t FsCoffBuFreq1[ROWS*COLS] =
{
    240,241,242,243,243,244,245,245,246,247,248,248,249,250,251,251,252,253,254,255,255,256,257,258,259,259,260,261,262,263,264,264,
    242,243,243,244,245,245,246,247,248,248,249,250,251,251,252,253,254,255,255,256,257,258,259,259,260,261,262,263,264,264,265,266,
    243,244,245,245,246,247,248,248,249,250,251,251,252,253,254,255,255,256,257,258,259,259,260,261,262,263,264,264,265,266,267,268,
    245,245,246,247,248,248,249,250,251,251,252,253,254,255,255,256,257,258,259,259,260,261,262,263,264,264,265,266,267,268,269,270,
    246,247,248,248,249,250,251,251,252,253,254,255,255,256,257,258,259,259,260,261,262,263,264,264,265,266,267,268,269,270,270,271,
    248,248,249,250,251,251,252,253,254,255,255,256,257,258,259,259,260,261,262,263,264,264,265,266,267,268,269,270,270,271,272,273,
    249,250,251,251,252,253,254,255,255,256,257,258,259,259,260,261,262,263,264,264,265,266,267,268,269,270,270,271,272,273,274,275,
    251,251,252,253,254,255,255,256,257,258,259,259,260,261,262,263,264,264,265,266,267,268,269,270,270,271,272,273,274,275,276,277,
    252,253,254,255,255,256,257,258,259,259,260,261,262,263,264,264,265,266,267,268,269,270,270,271,272,273,274,275,276,277,278,279,
    254,255,255,256,257,258,259,259,260,261,262,263,264,264,265,266,267,268,269,270,270,271,272,273,274,275,276,277,278,279,280,281,
    255,256,257,258,259,259,260,261,262,263,264,264,265,266,267,268,269,270,270,271,272,273,274,275,276,277,278,279,280,281,282,283,
    257,258,259,259,260,261,262,263,264,264,265,266,267,268,269,270,270,271,272,273,274,275,276,277,278,279,280,281,282,283,283,284,
    259,259,260,261,262,263,264,264,265,266,267,268,269,270,270,271,272,273,274,275,276,277,278,279,280,281,282,283,283,284,285,286,
    260,261,262,263,264,264,265,266,267,268,269,270,270,271,272,273,274,275,276,277,278,279,280,281,282,283,283,284,285,286,287,288,
    262,263,264,264,265,266,267,268,269,270,270,271,272,273,274,275,276,277,278,279,280,281,282,283,283,284,285,286,287,288,289,291,
    264,264,265,266,267,268,269,270,270,271,272,273,274,275,276,277,278,279,280,281,282,283,283,284,285,286,287,288,289,291,292,293,
    265,266,267,268,269,270,270,271,272,273,274,275,276,277,278,279,280,281,282,283,283,284,285,286,287,288,289,291,292,293,294,295,
    267,268,269,270,270,271,272,273,274,275,276,277,278,279,280,281,282,283,283,284,285,286,287,288,289,291,292,293,294,295,296,297,
    269,270,270,271,272,273,274,275,276,277,278,279,280,281,282,283,283,284,285,286,287,288,289,291,292,293,294,295,296,297,298,299,
    270,271,272,273,274,275,276,277,278,279,280,281,282,283,283,284,285,286,287,288,289,291,292,293,294,295,296,297,298,299,300,301,
    272,273,274,275,276,277,278,279,280,281,282,283,283,284,285,286,287,288,289,291,292,293,294,295,296,297,298,299,300,301,302,303,
    274,275,276,277,278,279,280,281,282,283,283,284,285,286,287,288,289,291,292,293,294,295,296,297,298,299,300,301,302,303,304,306,
    276,277,278,279,280,281,282,283,283,284,285,286,287,288,289,291,292,293,294,295,296,297,298,299,300,301,302,303,304,306,307,308,
    278,279,280,281,282,283,283,284,285,286,287,288,289,291,292,293,294,295,296,297,298,299,300,301,302,303,304,306,307,308,309,310,
    280,281,282,283,283,284,285,286,287,288,289,291,292,293,294,295,296,297,298,299,300,301,302,303,304,306,307,308,309,310,311,313,
    282,283,283,284,285,286,287,288,289,291,292,293,294,295,296,297,298,299,300,301,302,303,304,306,307,308,309,310,311,313,314,315,
    283,284,285,286,287,288,289,291,292,293,294,295,296,297,298,299,300,301,302,303,304,306,307,308,309,310,311,313,314,315,316,317,
    285,286,287,288,289,291,292,293,294,295,296,297,298,299,300,301,302,303,304,306,307,308,309,310,311,313,314,315,316,317,319,320,
    287,288,289,291,292,293,294,295,296,297,298,299,300,301,302,303,304,306,307,308,309,310,311,313,314,315,316,317,319,320,321,322,
    289,291,292,293,294,295,296,297,298,299,300,301,302,303,304,306,307,308,309,310,311,313,314,315,316,317,319,320,321,322,324,325,
    292,293,294,295,296,297,298,299,300,301,302,303,304,306,307,308,309,310,311,313,314,315,316,317,319,320,321,322,324,325,326,328,
    294,295,296,297,298,299,300,301,302,303,304,306,307,308,309,310,311,313,314,315,316,317,319,320,321,322,324,325,326,328,329,330,
    296,297,298,299,300,301,302,303,304,306,307,308,309,310,311,313,314,315,316,317,319,320,321,322,324,325,326,328,329,330,331,333,
    298,299,300,301,302,303,304,306,307,308,309,310,311,313,314,315,316,317,319,320,321,322,324,325,326,328,329,330,331,333,334,336,
    300,301,302,303,304,306,307,308,309,310,311,313,314,315,316,317,319,320,321,322,324,325,326,328,329,330,331,333,334,336,337,338,
    302,303,304,306,307,308,309,310,311,313,314,315,316,317,319,320,321,322,324,325,326,328,329,330,331,333,334,336,337,338,340,341,
    304,306,307,308,309,310,311,313,314,315,316,317,319,320,321,322,324,325,326,328,329,330,331,333,334,336,337,338,340,341,343,344,
    307,308,309,310,311,313,314,315,316,317,319,320,321,322,324,325,326,328,329,330,331,333,334,336,337,338,340,341,343,344,345,347,
    309,310,311,313,314,315,316,317,319,320,321,322,324,325,326,328,329,330,331,333,334,336,337,338,340,341,343,344,345,347,348,350,
    311,313,314,315,316,317,319,320,321,322,324,325,326,328,329,330,331,333,334,336,337,338,340,341,343,344,345,347,348,350,351,353,
    314,315,316,317,319,320,321,322,324,325,326,328,329,330,331,333,334,336,337,338,340,341,343,344,345,347,348,350,351,353,354,356,
    316,317,319,320,321,322,324,325,326,328,329,330,331,333,334,336,337,338,340,341,343,344,345,347,348,350,351,353,354,356,357,359,
    319,320,321,322,324,325,326,328,329,330,331,333,334,336,337,338,340,341,343,344,345,347,348,350,351,353,354,356,357,359,361,362,
    321,322,324,325,326,328,329,330,331,333,334,336,337,338,340,341,343,344,345,347,348,350,351,353,354,356,357,359,361,362,364,365,
    324,325,326,328,329,330,331,333,334,336,337,338,340,341,343,344,345,347,348,350,351,353,354,356,357,359,361,362,364,365,367,369,
    326,328,329,330,331,333,334,336,337,338,340,341,343,344,345,347,348,350,351,353,354,356,357,359,361,362,364,365,367,369,370,372,
    329,330,331,333,334,336,337,338,340,341,343,344,345,347,348,350,351,353,354,356,357,359,361,362,364,365,367,369,370,372,374,375,
    331,333,334,336,337,338,340,341,343,344,345,347,348,350,351,353,354,356,357,359,361,362,364,365,367,369,370,372,374,375,377,379,
};

uint16_t FsCoffBuFreqNormalize[ROWS*COLS] =
{
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
    300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,
};


#ifdef BOE
uint16_t FsCoffBuFreq0[ROWS*COLS] =
{
/*
	419,363,366,336,334,340,308,306,310,292,291,288,286,281,269,283,286,290,295,307,297,271,268,249,256,239,238,234,237,233,255,263,252,269,264,267,266,279,284,302,
	426,353,359,335,310,330,301,301,299,292,287,268,268,285,280,302,293,276,288,307,301,272,261,268,265,251,243,250,266,238,261,252,274,246,269,259,267,291,275,314,
	385,314,311,298,297,297,288,275,256,265,283,275,281,275,273,294,280,280,283,299,275,275,263,253,253,232,230,237,250,221,267,247,260,249,263,271,276,264,275,317,
	331,298,292,277,262,286,264,271,261,273,252,266,275,291,279,284,273,283,284,300,292,278,262,260,261,248,246,244,250,231,263,254,260,263,239,254,264,261,274,303,
	298,304,280,272,255,263,250,247,249,255,262,265,273,284,273,282,277,290,288,302,298,270,255,259,248,243,243,235,242,228,258,262,280,244,277,274,278,264,277,301,
	334,306,279,284,270,269,258,253,252,272,268,271,251,271,275,289,293,294,277,301,299,281,267,263,261,252,254,248,252,246,252,269,260,254,270,284,272,266,297,293,
	294,297,271,267,254,278,247,255,248,258,273,289,268,291,271,288,288,293,289,307,290,263,269,265,247,252,241,243,247,238,269,279,262,252,268,275,286,278,283,307,
	327,298,277,267,263,263,257,265,270,264,257,261,256,286,293,282,279,291,286,308,281,283,273,266,259,261,253,251,256,244,271,270,269,253,269,271,279,264,283,307,
	309,284,285,261,268,255,243,254,246,250,260,270,261,285,278,293,280,295,295,315,290,300,271,268,250,250,252,250,249,235,273,267,279,267,259,279,287,278,280,310,
	321,313,297,272,281,270,269,256,254,257,269,276,270,269,261,278,284,305,296,301,302,290,281,273,256,263,254,263,255,244,273,262,283,251,269,275,287,273,273,330,
	312,277,289,258,265,255,243,248,260,257,274,281,288,278,285,292,287,309,294,315,295,288,262,279,261,254,259,255,251,234,282,280,290,253,267,276,286,280,295,314,
	318,303,292,267,270,264,261,256,264,268,267,264,257,269,286,293,280,299,287,309,302,278,278,281,261,258,257,264,256,246,259,276,280,268,261,283,292,257,281,315,
	304,294,283,278,264,274,265,247,257,245,269,269,271,270,282,285,292,299,293,321,294,291,279,275,263,258,247,262,251,242,270,279,277,264,274,281,291,278,292,309,
	305,296,309,291,281,286,259,268,261,253,272,265,280,284,262,279,279,303,301,326,293,298,281,292,266,257,253,266,263,246,264,287,272,262,258,275,278,285,282,304,
	300,289,284,292,272,274,259,245,255,261,268,277,285,297,275,282,294,305,303,319,300,298,274,279,270,259,248,272,265,243,279,293,288,279,259,284,283,285,297,328,
	339,299,300,283,273,269,266,258,262,265,258,264,265,267,266,280,297,299,293,313,305,303,267,287,274,265,257,270,262,251,258,272,285,263,270,280,288,279,291,308,
	322,299,292,268,284,263,255,260,253,254,267,270,274,274,269,302,287,310,291,316,289,302,277,295,272,263,248,262,267,247,274,287,287,265,272,287,287,291,299,329,
	311,289,300,297,287,274,260,255,275,261,264,270,277,283,289,285,289,292,304,326,296,293,283,290,284,270,263,267,262,260,275,279,300,257,280,280,286,281,305,317,
	301,283,293,261,278,274,257,254,255,250,286,271,286,289,300,303,293,309,303,329,292,298,272,283,264,270,249,261,265,258,274,295,296,279,289,292,295,292,300,337,
	323,323,297,290,279,272,266,256,268,261,263,258,282,276,271,281,291,312,293,312,309,303,284,275,284,280,257,268,265,261,255,277,283,271,290,299,291,294,296,320,
	311,312,293,282,262,283,258,244,263,250,284,266,281,280,280,276,320,306,308,315,303,290,280,283,297,265,254,257,261,262,272,290,291,279,277,288,298,297,309,343,
	320,302,290,291,294,273,266,248,252,272,266,263,287,288,290,275,297,294,297,324,306,298,275,289,288,289,254,274,267,267,266,277,280,296,269,270,291,296,298,352,
	308,294,281,283,271,269,264,252,248,249,269,280,278,290,295,289,319,304,312,322,315,303,281,289,286,273,259,260,265,274,290,291,297,296,286,292,301,308,301,345,
	326,309,319,287,285,279,268,259,255,264,280,257,264,288,278,274,300,306,316,312,308,307,282,287,276,301,265,265,268,270,281,270,289,270,284,298,296,301,320,346,
	304,296,313,285,279,259,271,251,244,272,270,280,272,285,283,290,299,334,308,327,318,305,274,278,285,292,251,262,261,277,274,290,293,287,290,300,299,309,325,357,
	330,307,299,284,282,275,273,253,250,263,288,264,274,292,287,296,292,308,301,310,319,304,274,278,296,296,273,259,276,269,264,279,276,287,301,300,283,295,314,350,
	337,299,290,284,275,259,272,253,251,263,275,269,291,286,297,289,315,331,305,332,309,315,270,283,289,279,262,260,257,264,256,303,294,301,302,307,299,314,314,348,
	330,309,306,318,283,274,279,254,258,266,282,278,274,279,292,285,297,308,310,336,320,306,285,288,299,290,284,272,270,276,289,279,271,289,275,310,313,312,309,355,
	328,289,300,317,272,265,262,266,255,254,280,269,291,287,294,296,316,311,334,328,326,310,285,277,290,279,273,261,265,264,277,288,297,300,295,305,309,315,315,361,
	352,310,305,302,273,281,279,267,258,256,270,279,277,289,300,297,316,303,311,319,331,312,281,281,289,288,277,287,271,286,274,271,292,294,285,303,310,300,304,342,
	323,321,300,292,274,269,263,266,258,261,278,273,281,309,293,287,310,325,332,326,314,310,300,277,295,285,272,278,279,270,301,271,315,311,302,308,315,323,320,365,
	344,313,308,308,306,287,278,277,259,271,283,276,281,283,294,299,306,308,312,323,334,311,283,289,301,293,272,292,287,280,298,313,289,292,310,316,321,325,315,360,
	333,312,293,302,301,275,277,265,266,265,290,277,276,307,293,303,315,327,313,355,320,309,294,289,286,285,278,301,278,274,277,299,297,307,300,299,314,333,313,363,
	333,323,310,303,287,302,283,275,266,267,288,268,286,290,302,304,316,325,308,328,326,322,291,284,293,297,273,286,300,282,278,286,296,293,297,308,321,330,301,345,
	338,305,319,307,281,267,278,261,265,261,273,273,276,293,320,292,309,319,332,357,318,303,294,292,290,285,276,274,286,283,290,294,279,324,301,307,321,338,320,366,
	349,321,316,308,294,280,293,273,275,267,283,274,278,307,295,303,325,319,313,320,325,325,295,287,304,307,280,282,313,297,276,297,316,312,280,316,321,329,322,360,
	331,309,314,289,289,279,291,269,255,274,306,282,285,293,322,295,327,326,333,330,311,313,290,291,301,297,278,287,308,285,283,287,309,311,304,317,323,336,330,359,
	358,315,329,311,289,281,306,282,273,275,303,279,278,313,306,310,319,324,338,324,344,320,303,293,297,299,285,282,308,307,297,291,317,305,297,319,325,332,330,337,
	332,323,307,317,284,296,286,268,259,280,295,272,279,300,313,307,317,323,335,350,324,314,291,286,306,303,275,278,294,293,286,301,324,298,327,320,343,342,334,365,
	367,329,327,309,294,293,292,294,274,283,294,286,279,305,324,313,335,339,330,322,352,324,310,296,301,308,297,287,302,319,296,303,325,332,313,326,337,335,330,367,
	363,314,319,311,281,288,299,279,267,271,304,301,292,309,348,315,317,351,343,354,332,316,299,291,308,300,270,292,296,313,303,295,316,327,324,325,357,337,351,376,
	363,335,323,327,297,286,294,309,282,284,311,295,292,298,311,311,340,338,349,347,349,342,303,303,308,308,288,289,303,311,298,300,313,323,303,323,344,339,352,377,
	360,310,332,303,306,283,302,281,270,271,306,294,278,301,346,321,328,332,337,350,348,322,293,293,302,311,276,283,298,292,302,293,326,335,311,317,356,355,347,383,
	371,342,340,322,296,294,303,296,293,282,310,289,297,303,328,323,337,346,364,341,355,350,312,309,309,320,293,301,305,301,316,301,309,324,310,319,362,346,343,379,
	357,334,329,314,299,279,303,306,282,279,323,303,311,313,329,338,337,340,369,363,325,337,304,303,309,307,285,291,300,312,298,311,317,324,317,327,366,359,344,384,
	375,343,352,318,311,302,303,295,308,291,312,311,302,318,330,311,335,354,363,362,350,351,332,303,318,323,296,293,310,303,319,305,331,321,325,303,365,346,350,381,
	357,332,323,322,297,289,300,316,271,281,318,305,301,302,338,332,346,359,357,355,331,354,317,306,302,303,289,279,300,306,310,309,315,330,333,325,355,361,361,389,
	382,339,358,327,309,319,312,309,292,300,308,310,290,312,334,323,346,367,374,375,350,359,345,305,324,320,313,301,319,304,308,318,326,314,324,308,357,371,351,387,
	368,334,348,332,297,283,299,302,288,283,310,322,312,338,344,320,361,371,366,388,353,328,331,302,305,303,300,289,305,305,312,302,331,324,320,317,363,362,364,385,
	372,346,353,335,301,307,323,310,294,319,327,322,323,333,344,334,332,364,386,378,353,360,348,324,315,318,318,298,308,310,329,318,321,331,312,326,341,363,346,383,
	384,333,348,319,309,294,307,314,295,292,322,326,312,327,348,334,357,381,388,365,354,339,355,306,310,311,303,301,308,304,325,312,327,315,327,336,348,350,359,400,
	371,354,358,346,316,309,337,320,303,303,338,315,316,313,350,330,345,382,397,382,368,363,361,334,317,320,321,313,313,319,303,308,333,322,321,331,338,354,370,388,
	369,341,346,346,321,303,307,290,304,294,335,314,327,334,353,340,340,407,397,373,348,361,334,320,305,312,308,290,306,296,339,315,321,334,332,317,352,365,367,405,
	396,337,361,345,326,316,329,325,301,305,340,338,323,336,346,337,356,359,383,390,367,363,364,331,333,341,323,312,312,313,326,326,336,322,349,310,357,343,375,383,
	364,352,351,338,312,300,323,314,299,319,332,329,326,332,355,343,353,394,401,389,352,347,338,334,311,329,317,295,314,319,328,325,332,334,337,324,379,352,358,400,
	390,340,376,350,338,314,334,346,311,316,351,344,311,334,352,346,348,369,400,393,360,370,361,340,337,335,330,315,328,325,338,294,330,347,344,327,366,346,357,417,
	398,339,361,342,333,299,337,318,289,320,344,344,315,352,374,354,358,373,429,401,355,354,361,324,324,326,330,304,313,319,332,341,338,343,344,334,371,361,390,414,
	427,368,371,364,352,318,350,347,325,327,333,357,351,352,379,355,365,380,387,402,364,380,368,342,343,341,354,321,330,334,356,333,352,365,352,361,365,379,375,420,
	410,353,391,368,359,331,340,343,329,342,376,364,351,372,384,376,375,400,437,437,382,383,367,330,361,338,352,323,322,334,356,348,370,370,396,360,402,403,408,418,
	445,401,405,417,392,388,384,392,382,375,401,417,392,369,414,399,404,423,452,487,413,424,421,385,390,390,383,356,366,390,381,374,362,389,394,388,432,423,440,466,
*/

	397,375,354,339,330,323,312,304,299,293,288,284,281,280,280,284,287,289,294,297,291,277,266,259,253,246,241,241,242,244,251,257,260,262,264,266,271,278,288,297,
	385,362,341,327,318,312,303,295,290,286,282,279,278,279,282,286,287,286,291,295,289,276,266,260,254,247,242,243,245,246,252,257,259,260,262,266,271,277,287,299,
	358,337,318,305,298,294,288,280,275,274,274,274,276,279,282,284,284,284,288,292,286,275,265,259,253,246,242,243,244,245,251,256,258,258,260,264,269,274,285,298,
	328,313,298,286,279,277,272,266,264,265,267,270,275,279,281,282,282,284,288,292,287,276,265,259,253,247,243,243,242,244,252,258,259,258,260,264,268,271,282,295,
	313,302,288,277,270,266,261,257,258,261,264,268,272,276,279,282,284,286,290,293,289,277,266,259,254,249,245,244,243,245,253,261,262,261,264,269,271,273,283,293,
	309,299,285,274,268,264,258,255,256,261,266,269,270,275,279,283,287,289,291,294,289,278,268,261,255,251,248,246,246,248,256,263,263,262,267,273,275,277,285,294,
	307,296,282,271,266,263,258,256,257,262,267,269,271,277,281,284,287,290,292,295,289,278,270,263,257,252,249,248,248,251,260,266,264,262,267,274,277,279,287,296,
	307,295,281,270,265,261,258,257,258,260,264,267,271,278,282,284,286,290,294,296,291,282,273,265,258,254,252,250,249,253,262,268,267,264,267,274,277,279,287,298,
	308,297,284,273,267,261,257,256,256,258,263,267,270,276,280,283,287,292,297,299,294,286,277,267,259,255,254,252,251,253,262,269,269,266,268,274,279,280,289,302,
	308,299,286,275,268,263,258,255,256,260,266,271,273,275,278,283,289,295,299,301,296,288,278,269,262,257,256,255,252,254,264,271,271,267,268,275,280,282,291,305,
	307,298,286,274,267,262,257,256,258,262,268,272,274,276,280,285,290,296,300,301,297,287,278,271,264,259,257,256,253,254,265,273,274,268,269,276,280,282,292,305,
	306,297,286,275,269,264,259,257,258,262,266,269,271,275,281,286,290,295,299,302,297,287,279,273,265,259,257,257,254,254,264,273,274,270,271,277,281,282,291,303,
	303,297,289,280,274,269,263,258,258,260,265,269,272,275,279,284,290,296,301,304,299,289,282,275,267,259,257,257,255,256,265,274,274,270,271,277,281,283,291,302,
	302,297,292,285,278,272,264,259,258,260,265,271,275,278,278,282,289,297,304,307,301,292,284,277,269,260,258,260,258,258,267,276,276,270,270,276,281,285,293,303,
	306,299,293,286,278,271,264,259,258,261,266,271,276,278,278,282,291,299,304,307,302,293,284,278,270,262,260,262,260,259,268,278,278,273,271,277,282,287,296,307,
	312,302,292,284,277,269,263,259,259,261,265,269,273,275,277,284,292,298,303,305,302,293,285,280,273,264,261,262,261,260,268,277,278,274,273,279,284,289,299,309,
	312,302,292,284,277,269,262,259,260,261,265,269,273,276,280,287,293,298,303,305,301,293,286,282,275,266,261,262,261,262,269,279,280,275,276,281,286,291,301,312,
	306,299,292,285,279,271,263,260,260,262,267,272,277,281,286,290,294,299,305,307,301,293,286,282,276,268,262,262,262,264,272,281,283,278,279,284,288,293,304,315,
	306,300,292,284,278,271,263,259,260,263,268,273,278,283,287,291,296,301,306,309,303,294,285,280,276,269,263,262,263,265,272,281,284,282,284,288,291,295,306,317,
	311,305,295,284,277,271,263,259,259,262,267,272,277,281,284,289,297,303,306,308,304,295,286,281,278,271,264,262,263,264,270,279,283,282,285,290,293,297,308,320,
	312,306,295,286,278,272,263,257,258,262,267,272,277,281,283,288,297,303,307,309,304,295,286,284,282,273,265,263,264,266,271,279,283,283,283,287,293,299,311,326,
	310,303,294,286,280,272,263,256,256,261,267,273,279,284,286,290,298,303,308,311,306,296,288,285,284,276,266,264,266,269,275,281,285,285,283,286,293,301,314,330,
	310,303,294,287,280,272,264,257,256,261,267,272,278,284,287,291,299,306,310,313,309,299,289,285,284,277,268,265,267,272,278,283,287,287,286,290,296,304,317,332,
	311,306,299,289,280,273,265,258,257,262,269,272,276,282,285,290,300,308,313,314,310,300,289,284,284,279,270,265,267,273,278,283,286,286,289,293,299,307,321,336,
	312,307,300,290,280,272,265,258,257,264,271,273,276,282,286,291,301,310,313,315,311,300,287,283,285,281,271,265,267,271,276,281,285,288,292,296,299,308,324,339,
	317,308,298,288,279,272,266,258,257,265,272,275,279,285,289,294,302,310,313,315,312,300,287,283,286,282,272,266,266,269,274,281,286,291,295,298,300,307,323,338,
	321,309,299,290,280,272,266,260,258,265,272,276,280,286,290,295,304,311,315,318,314,302,289,285,287,282,273,267,266,269,274,282,287,292,297,301,304,310,323,337,
	321,311,303,296,283,273,267,262,260,265,272,277,281,286,291,296,304,312,318,322,317,304,291,287,287,283,276,270,268,271,277,283,287,291,295,302,307,313,324,339,
	323,312,304,297,284,274,269,263,260,264,271,277,282,287,293,298,306,313,319,323,319,306,292,286,286,283,277,272,271,274,278,283,289,293,296,302,308,313,324,339,
	326,315,305,295,283,275,270,265,262,264,271,277,283,290,295,300,307,314,319,322,319,307,293,287,286,284,279,276,275,277,280,285,292,296,299,304,309,314,324,339,
	327,317,306,296,286,278,272,267,264,266,273,278,284,291,295,300,307,315,320,322,319,308,295,289,288,285,281,280,280,281,286,290,296,300,303,308,313,318,328,342,
	328,317,307,300,292,283,275,270,267,270,276,279,284,291,296,301,308,315,321,324,321,309,296,290,290,287,283,284,283,283,289,294,298,301,305,310,316,322,331,344,
	327,317,307,301,294,286,278,271,268,271,277,279,284,292,298,304,311,317,322,327,322,310,297,291,290,287,284,286,285,283,287,293,297,300,303,309,317,323,330,342,
	328,319,309,301,293,285,279,272,268,271,276,278,284,293,300,305,312,319,324,328,323,311,298,291,290,287,284,285,286,285,286,290,296,300,303,309,318,324,330,341,
	330,321,312,302,291,283,278,272,269,270,275,278,284,294,302,306,313,319,325,328,322,311,299,293,292,289,284,285,288,288,287,292,298,302,304,310,320,326,333,344,
	332,322,312,302,291,284,280,274,270,273,278,280,286,296,303,308,315,321,325,326,321,311,300,295,295,292,287,288,293,291,289,294,302,305,305,312,321,328,336,347,
	332,323,313,302,292,287,284,277,272,277,284,284,288,298,305,310,317,324,327,327,322,312,301,296,296,294,288,290,295,294,292,296,304,307,308,314,323,330,337,345,
	335,325,315,305,294,289,286,279,274,279,286,285,288,299,307,312,319,326,330,331,326,315,302,297,297,294,289,289,296,297,295,299,307,309,311,319,327,333,338,345,
	339,328,317,307,296,291,287,280,276,280,286,285,289,300,310,315,321,328,333,334,329,317,304,298,298,296,290,289,295,298,298,303,311,314,317,324,332,336,342,350,
	344,332,319,308,297,292,289,283,278,282,288,289,292,304,315,319,326,333,336,337,332,320,306,300,300,298,291,291,297,302,302,306,314,319,321,328,335,340,347,357,
	348,334,321,309,298,292,291,286,281,284,292,294,296,307,318,322,329,337,341,341,336,323,308,302,301,298,291,292,299,304,303,306,314,320,322,329,338,343,352,363,
	349,335,323,312,300,293,293,289,283,286,294,296,297,306,317,323,330,338,343,345,339,326,310,303,303,299,292,292,298,302,302,305,314,319,320,328,340,347,356,367,
	350,337,326,314,302,295,294,290,285,287,295,296,297,307,319,326,332,339,345,347,342,328,312,304,304,302,294,293,298,301,303,306,314,319,320,328,342,350,357,368,
	353,341,329,316,303,296,296,293,288,290,298,299,301,310,322,329,335,343,350,349,343,331,316,308,307,304,297,295,299,303,305,308,315,319,321,330,345,352,358,369,
	355,344,332,318,304,298,298,297,293,294,302,305,307,314,323,330,337,347,355,353,345,334,320,311,309,306,298,297,301,305,307,311,316,320,322,331,346,353,359,370,
	356,345,333,320,307,300,300,299,295,296,304,307,308,315,324,330,339,350,357,355,347,338,324,313,310,306,299,297,301,306,309,313,319,322,324,332,346,355,362,372,
	357,346,335,322,309,303,303,300,295,296,304,307,307,315,325,333,343,355,360,357,350,342,328,315,310,307,300,298,302,307,310,314,319,323,325,332,347,357,365,375,
	360,349,338,325,311,305,304,301,296,298,305,309,310,318,328,335,347,360,366,363,354,344,331,317,312,309,304,301,304,307,310,315,320,322,324,331,347,359,367,376,
	361,351,341,327,311,304,305,302,298,301,310,314,318,326,333,338,349,363,371,368,357,345,333,319,312,310,305,303,305,309,312,316,321,322,323,331,346,358,367,376,
	363,352,342,328,312,306,307,305,302,306,315,319,323,330,336,340,350,366,374,370,359,348,337,323,314,311,308,305,306,311,315,318,321,323,324,331,345,356,366,377,
	364,354,343,330,315,309,311,309,305,308,317,321,322,329,337,342,353,370,378,372,361,352,342,327,317,313,310,307,308,312,315,318,322,323,326,333,344,355,367,380,
	364,355,346,335,321,313,313,310,306,310,319,322,322,329,338,343,356,374,382,375,364,355,344,329,319,315,312,309,309,312,315,318,323,325,327,333,344,356,370,383,
	365,355,348,338,324,316,313,310,306,311,321,325,326,333,340,345,357,375,384,377,365,356,345,331,322,318,313,309,309,313,318,322,325,328,329,333,345,358,372,385,
	367,357,349,339,326,317,316,313,309,315,325,329,329,335,342,347,357,374,384,379,366,356,346,334,326,323,317,311,311,316,322,325,328,331,333,336,347,358,371,384,
	368,359,351,341,327,319,320,318,314,319,329,331,331,336,344,349,359,375,386,381,367,357,347,337,329,326,320,314,315,320,324,326,330,334,336,340,351,359,372,387,
	373,362,355,345,331,323,324,322,317,322,333,335,333,340,349,353,361,377,390,385,370,359,350,339,332,329,323,318,319,324,326,327,332,339,340,345,354,363,377,394,
	384,369,359,350,336,328,329,326,321,326,337,340,340,348,357,359,365,380,394,390,374,364,354,342,335,333,329,322,322,328,333,335,340,346,348,351,361,370,385,401,
	395,379,369,360,347,337,337,336,331,335,346,351,352,359,367,369,374,388,402,399,384,373,362,349,343,342,337,330,329,335,342,346,352,358,360,364,373,383,396,409,
	406,391,383,376,364,354,353,352,349,354,364,369,368,372,379,382,388,403,420,419,403,389,376,363,358,356,350,342,341,349,355,358,363,371,376,381,392,402,413,423,
	417,403,396,392,382,373,370,369,367,372,382,387,382,382,389,394,401,417,436,439,421,406,394,380,375,371,364,355,356,364,368,367,370,379,386,394,407,418,430,440,
};

uint16_t tx1PcCoffBuf[COLS_STYLUS_TIED * ROWS] =
{
/*
	54,51,51,46,45,43,45,44,48,48,50,49,50,46,47,43,45,46,50,53,57,53,51,47,45,43,45,45,48,48,50,49,50,46,46,43,45,46,49,53,
	56,51,51,48,47,44,46,46,50,50,52,52,52,48,48,46,48,48,51,55,59,54,52,49,47,45,47,47,50,50,52,52,52,48,48,45,48,48,51,55,
	58,53,52,49,48,45,47,47,51,52,54,54,53,50,50,48,49,50,53,58,60,55,53,50,49,46,48,49,52,52,53,53,54,50,50,48,50,50,53,57,
	60,56,53,51,49,47,49,49,53,53,55,56,55,53,52,50,51,53,56,60,62,58,54,52,50,48,50,51,54,53,55,56,56,53,53,49,52,52,55,60,
	61,57,55,53,50,53,50,51,55,56,57,59,57,55,54,52,53,56,57,63,64,60,57,55,52,55,52,52,56,57,57,60,58,55,54,52,53,55,57,63,
	63,59,56,54,52,55,55,52,57,56,57,59,60,57,57,54,55,58,59,63,66,62,58,57,54,56,57,54,58,57,58,60,60,58,57,55,55,57,59,64,
	64,60,58,56,53,55,56,60,58,59,59,60,56,59,58,56,58,60,61,66,67,63,59,58,55,58,58,62,60,59,60,61,57,61,59,56,58,59,61,66,
	65,61,59,57,55,57,58,61,61,60,61,61,57,57,60,57,59,61,62,67,68,64,61,58,56,59,59,63,63,61,61,62,58,58,60,58,59,61,62,68,
	66,63,60,58,56,58,58,63,63,63,63,63,60,59,57,59,60,63,64,69,69,65,62,60,57,59,60,64,64,63,64,63,59,59,56,59,60,62,63,69,
	67,65,61,60,58,59,59,64,64,64,64,64,61,60,58,60,61,63,65,70,71,68,63,61,60,61,62,66,65,65,65,64,61,61,57,61,61,63,65,72,
	67,67,62,61,58,61,59,65,64,66,65,66,62,62,59,61,61,64,66,72,70,68,64,63,60,62,62,67,66,66,66,66,63,63,59,61,61,65,66,73,
	69,67,63,62,59,61,61,65,65,66,66,66,62,63,59,62,62,66,68,73,71,69,64,63,61,63,62,66,66,67,66,66,63,63,60,62,62,66,68,73,
*/

	53,52,50,48,46,45,45,46,48,49,50,50,49,48,47,46,46,48,51,54,55,54,51,48,46,45,46,47,48,49,50,50,49,48,46,46,46,48,50,52,
	55,53,51,48,47,46,46,47,49,50,51,52,51,49,48,47,48,49,52,55,56,55,52,49,47,46,47,48,49,50,51,52,51,49,48,47,48,49,51,54,
	56,54,52,50,48,47,47,48,50,52,53,53,53,51,50,49,50,51,54,57,58,56,53,51,49,48,48,50,51,52,53,53,53,51,50,49,50,51,53,56,
	58,56,53,51,50,49,49,50,52,54,55,55,55,53,52,51,52,53,56,59,60,58,55,53,51,50,50,52,53,54,55,56,55,53,52,51,52,53,56,58,
	60,58,55,53,52,51,51,52,54,55,56,57,57,55,54,53,54,56,58,61,62,60,57,55,53,53,53,54,55,56,57,58,57,56,54,53,54,55,58,60,
	61,59,56,54,53,54,54,55,56,57,58,58,58,57,56,55,56,58,60,63,63,62,59,56,55,55,56,56,57,58,59,59,59,58,56,55,56,57,60,62,
	62,60,58,56,55,55,56,58,58,59,59,59,58,58,57,57,58,59,62,64,65,63,60,58,57,57,58,59,60,60,60,60,59,59,58,57,58,59,62,64,
	64,62,59,57,56,57,58,60,61,61,61,60,59,58,58,58,59,61,63,66,66,64,61,59,58,58,60,61,62,62,61,61,60,59,58,58,59,61,63,66,
	65,63,60,58,58,58,59,61,62,63,62,62,60,59,59,59,60,62,65,67,67,65,62,60,59,60,61,63,63,63,63,62,60,59,59,59,60,62,65,67,
	66,64,62,60,59,59,60,62,64,64,64,63,62,60,59,60,61,63,66,68,69,67,64,61,60,61,62,64,65,65,64,63,62,60,59,60,61,63,66,69,
	67,65,63,61,60,60,61,63,64,65,65,64,63,61,60,61,62,64,67,69,70,67,65,62,61,62,63,65,66,66,65,65,63,62,61,61,62,64,67,70,
	67,66,63,61,60,60,62,64,65,65,65,65,63,62,61,61,63,65,68,70,70,68,65,63,62,62,63,65,66,66,66,65,64,62,61,61,63,65,68,71,
};
uint16_t tx1PrCoffBuf[COLS * ROWS_STYLUS_TIED] =
{
/*
	46,44,41,46,47,45,41,46,
	47,45,42,47,48,45,42,47,
	47,45,42,47,47,45,42,48,
	47,45,43,48,47,46,43,48,
	47,45,43,48,47,46,42,48,
	49,46,44,48,49,46,43,48,
	48,46,44,48,48,47,44,49,
	48,47,44,50,50,48,44,49,
	48,47,45,50,49,47,44,50,
	49,47,45,50,50,47,45,51,
	48,47,45,50,50,48,45,51,
	49,47,46,50,51,48,46,51,
	49,47,47,52,52,48,47,51,
	51,48,47,51,53,49,47,51,
	51,48,48,51,52,49,48,52,
	52,49,48,51,53,49,48,51,
	52,48,49,52,54,50,49,52,
	52,49,49,52,55,50,50,52,
	53,48,50,54,55,50,50,53,
	54,49,51,53,56,51,50,53,
	54,50,53,54,55,51,52,54,
	55,51,52,54,57,52,52,55,
	54,50,53,55,56,52,53,55,
	55,50,53,55,57,52,53,54,
	55,51,53,56,56,52,54,56,
	55,51,53,56,58,53,53,56,
	55,52,54,57,57,53,55,57,
	55,52,54,57,58,54,55,57,
	55,53,55,58,58,55,56,58,
	56,54,55,58,58,56,55,58,
	56,54,56,59,58,56,57,59,
	57,53,56,59,59,56,56,59,
	57,53,55,61,59,55,56,60,
	57,55,55,60,59,56,56,59,
	57,54,55,60,59,56,56,60,
	58,54,56,60,59,56,56,60,
	57,54,57,60,60,56,57,61,
	58,55,57,61,60,57,58,60,
	59,55,58,61,60,57,59,61,
	60,55,57,61,61,57,58,61,
	59,55,58,61,61,56,58,62,
	60,56,58,61,62,57,58,60,
	59,55,58,62,62,57,58,62,
	60,56,59,61,61,57,59,61,
	59,56,60,62,62,57,59,62,
	61,56,59,62,62,58,60,62,
	61,55,60,64,62,58,61,63,
	61,55,59,63,63,57,60,63,
	61,56,60,63,62,58,61,63,
	62,56,60,63,63,57,61,62,
	62,57,61,63,63,58,62,63,
	62,56,61,63,64,58,61,63,
	63,57,62,63,64,59,62,63,
	63,56,61,63,64,58,62,63,
	63,57,62,65,64,58,63,65,
	63,56,62,63,64,58,63,64,
	63,57,62,64,64,58,63,64,
	65,58,63,63,65,58,63,64,
	63,57,63,64,65,59,64,65,
	64,57,63,64,66,59,64,65,
*/

	45,44,44,45,46,45,44,45,
	46,45,44,45,46,45,44,45,
	46,45,45,46,46,45,45,46,
	46,45,45,46,46,45,45,46,
	47,46,45,46,47,46,45,46,
	47,46,46,47,47,46,46,47,
	47,46,46,47,48,47,46,47,
	47,47,47,48,48,47,47,48,
	48,47,47,48,49,47,47,48,
	48,47,47,48,49,48,47,49,
	48,47,47,49,49,48,48,49,
	48,48,48,49,50,49,48,49,
	49,48,48,50,50,49,49,50,
	49,49,49,50,51,50,49,50,
	50,49,49,50,51,50,49,50,
	51,50,50,51,51,50,50,50,
	51,50,50,51,52,51,50,51,
	51,50,50,52,52,51,51,51,
	52,51,51,52,53,52,51,52,
	52,51,52,53,53,52,52,52,
	53,52,52,54,54,53,52,53,
	53,52,53,54,54,53,53,54,
	53,52,53,54,55,54,53,54,
	53,53,53,55,55,54,54,54,
	54,53,53,55,55,54,54,55,
	54,53,54,55,55,54,54,55,
	54,53,54,56,56,55,55,56,
	54,54,55,56,56,56,56,56,
	55,54,55,57,57,56,56,57,
	55,55,56,57,57,57,57,57,
	55,55,56,57,58,57,57,58,
	56,55,56,58,58,57,57,58,
	56,55,56,58,58,57,57,58,
	56,56,56,58,58,57,57,58,
	56,56,57,58,58,57,57,58,
	56,56,57,58,58,57,58,59,
	57,56,57,59,59,58,58,59,
	57,57,58,59,59,58,59,60,
	58,57,58,59,59,59,59,60,
	58,57,58,60,60,59,59,60,
	58,57,58,60,60,59,59,60,
	58,58,58,60,60,59,59,60,
	58,58,59,60,60,59,59,60,
	58,58,59,60,60,59,59,60,
	59,58,59,61,60,59,60,61,
	59,58,59,61,61,60,60,61,
	59,58,60,61,61,60,61,62,
	59,59,60,61,61,60,61,62,
	60,59,60,61,61,60,61,62,
	60,59,60,62,61,60,61,62,
	60,60,60,62,62,61,61,62,
	61,60,61,62,62,61,61,62,
	61,60,61,62,62,61,61,62,
	61,60,61,62,62,61,62,63,
	61,60,61,63,62,61,62,63,
	61,60,61,63,62,61,62,63,
	61,61,61,63,62,61,62,63,
	62,61,62,63,63,62,62,64,
	62,61,62,63,63,62,63,64,
	62,61,62,63,63,62,63,64,
};
uint16_t tx2PcCoffBuf[COLS_STYLUS_TIED * ROWS] =
{
};
uint16_t tx2PrCoffBuf[COLS * ROWS_STYLUS_TIED] =
{
};

#elif defined(CSOT)

uint16_t FsCoffBuFreq0[ROWS*COLS] =
{
	259,255,249,244,241,240,240,240,240,240,241,241,241,242,244,248,250,252,254,253,247,241,236,232,231,232,231,230,231,236,241,244,247,246,245,247,251,258,267,274,
	259,255,249,243,241,241,240,238,238,240,242,241,241,243,244,247,251,255,256,254,249,244,239,234,234,236,234,232,234,239,242,242,245,247,246,249,253,257,263,269,
	256,253,246,239,237,239,236,233,233,238,241,240,239,243,245,247,252,258,260,256,250,245,239,235,234,236,234,232,233,238,240,240,242,245,246,249,253,256,261,267,
	254,250,244,236,234,235,234,231,231,236,239,238,238,241,245,247,252,260,262,258,251,245,240,235,233,233,232,231,232,236,239,239,240,244,247,250,253,256,263,269,
	254,250,245,237,233,234,233,231,232,237,240,239,238,241,245,247,252,258,261,259,253,247,242,237,234,233,232,231,233,237,241,241,242,247,250,252,254,257,263,270,
	257,253,249,241,234,233,233,232,232,237,242,241,241,243,247,249,252,258,261,259,254,249,244,238,235,235,234,234,235,239,244,244,244,248,252,254,255,258,262,268,
	259,256,252,243,234,233,233,231,231,236,242,243,243,245,250,253,255,261,264,262,255,250,245,239,236,236,236,237,238,242,247,246,244,247,251,254,256,259,262,266,
	259,256,253,244,236,234,234,232,232,236,241,242,242,245,250,254,256,261,266,263,256,251,246,241,237,237,237,237,238,243,248,248,245,247,251,254,257,261,263,267,
	260,257,255,247,238,236,236,234,234,237,242,242,242,244,250,254,255,261,265,263,256,252,248,243,239,238,237,236,238,244,250,250,248,249,252,255,258,263,266,269,
	263,261,259,252,242,238,237,235,234,238,243,244,243,245,250,253,255,260,266,264,258,253,249,243,239,238,237,236,239,246,252,252,250,250,253,255,259,264,269,271,
	266,263,262,255,245,240,239,236,234,237,242,245,245,247,250,253,257,261,267,267,261,255,250,243,239,238,237,237,241,248,254,254,252,252,253,256,259,265,270,272,
	267,264,263,256,246,242,243,239,236,238,243,244,244,246,250,253,257,261,267,268,261,255,251,245,240,239,238,237,241,249,256,256,253,254,254,256,260,266,271,275,
	266,265,264,258,249,246,247,242,238,241,246,245,244,246,250,253,257,261,267,268,260,255,252,246,242,241,239,237,239,249,258,259,256,255,256,258,262,267,273,278,
	267,266,267,261,253,250,250,245,240,243,248,247,246,248,252,254,257,262,267,267,260,256,253,248,243,242,240,238,240,250,259,260,257,256,256,259,264,269,275,281,
	270,269,269,263,255,253,253,248,242,245,249,248,247,250,255,255,257,264,269,267,260,256,254,249,244,242,240,238,241,251,260,261,259,258,257,260,265,270,276,281,
	273,270,269,263,256,254,256,251,244,245,249,249,247,250,255,256,258,264,269,267,260,256,254,250,245,243,241,238,241,249,258,261,260,259,258,260,264,270,276,280,
	273,270,269,264,257,255,256,252,246,245,250,250,247,250,255,257,259,265,270,268,261,256,255,251,248,245,242,239,240,247,255,260,261,260,259,261,265,271,277,281,
	272,270,269,265,259,257,256,252,247,247,252,251,249,251,257,258,259,265,271,269,261,257,256,253,249,247,244,240,240,246,254,259,260,260,260,263,267,272,277,281,
	273,272,271,266,259,258,259,255,249,250,254,253,250,252,257,258,259,266,274,271,262,258,257,253,249,246,244,240,240,246,256,260,260,260,260,262,266,272,277,282,
	274,274,273,268,260,258,259,257,252,252,257,255,250,251,256,258,259,266,275,273,264,258,257,254,250,248,244,240,240,248,257,260,259,260,260,261,265,271,278,284,
	273,274,273,268,260,257,258,256,252,254,258,255,250,252,258,260,261,267,275,273,264,258,257,254,252,250,246,241,241,248,257,259,259,261,261,261,265,272,279,287,
	273,273,273,270,262,258,257,255,252,253,257,255,251,253,260,262,262,268,276,274,264,259,258,255,253,250,247,242,241,247,256,259,260,261,262,262,267,273,281,289,
	274,274,275,272,264,259,258,256,253,254,258,258,253,253,259,261,261,267,277,277,266,259,258,256,253,250,247,243,240,246,256,259,259,261,262,264,267,273,281,289,
	275,275,276,273,265,260,258,256,254,256,260,260,254,253,258,261,262,269,278,279,268,261,260,257,253,251,250,245,241,246,255,258,258,260,263,265,267,273,280,287,
	276,274,275,272,265,261,259,256,253,254,259,260,254,253,259,263,266,272,281,280,269,263,261,257,253,253,252,246,242,246,256,259,258,261,265,266,268,274,282,287,
	277,274,273,271,264,260,260,256,252,253,258,259,254,254,260,264,267,272,281,281,271,265,264,259,255,254,253,247,243,250,260,262,260,262,266,266,269,276,284,289,
	277,274,274,272,265,260,260,257,253,255,260,260,256,256,262,266,267,271,280,280,271,266,265,261,256,255,253,248,245,252,264,266,263,265,268,269,271,277,284,291,
	276,274,275,275,267,261,260,258,255,256,260,261,258,258,263,267,268,272,280,280,271,267,266,261,256,255,255,251,248,253,263,266,264,266,271,273,274,277,285,292,
	276,274,274,275,267,261,262,260,255,254,258,260,258,259,264,268,269,274,282,281,272,268,268,262,255,254,256,254,250,252,261,265,265,267,273,275,275,279,287,295,
	279,275,274,273,265,260,263,262,256,254,257,260,258,260,266,270,271,275,284,284,276,271,270,264,256,255,257,255,250,252,261,267,267,270,275,276,275,281,290,298,
	282,277,275,273,266,260,263,264,258,254,258,261,260,262,268,273,273,276,284,286,279,274,272,266,259,257,258,256,251,253,263,270,270,272,278,279,279,283,291,298,
	283,277,275,275,269,263,265,266,260,255,259,262,261,264,270,274,275,278,286,287,279,274,273,269,262,261,262,259,254,255,263,269,269,272,278,282,283,285,291,298,
	282,278,276,276,271,265,266,269,263,257,259,262,262,265,272,275,276,281,289,290,280,275,275,271,265,264,266,262,258,258,263,266,267,271,277,281,283,287,293,301,
	284,280,278,277,271,265,267,270,266,260,261,264,264,267,275,280,279,282,290,292,284,279,278,272,266,265,266,263,259,261,266,268,269,273,278,280,283,287,296,304,
	286,282,279,278,271,265,267,272,269,263,265,267,267,270,280,285,283,285,291,292,285,281,280,274,267,266,267,263,260,263,270,272,273,277,281,283,286,291,298,305,
	288,282,279,278,272,265,268,274,272,267,268,270,269,273,283,288,286,287,294,293,284,279,279,274,268,267,269,265,262,266,271,272,273,277,283,286,289,294,301,307,
	290,283,279,279,273,267,270,276,275,270,270,270,269,273,284,290,287,288,296,296,285,279,280,275,269,268,270,267,264,267,272,270,270,276,285,288,290,296,303,309,
	296,287,281,281,276,272,273,277,276,273,273,273,271,274,285,293,291,290,297,297,287,282,283,278,270,269,272,267,263,268,274,272,271,279,289,291,291,296,304,310,
	302,290,284,284,279,275,275,277,277,276,276,276,274,276,287,297,295,294,300,299,288,283,284,280,271,271,273,268,264,269,276,275,274,283,293,294,293,300,308,314,
	303,292,285,284,280,274,273,277,278,277,277,278,275,277,289,298,297,295,301,301,289,282,283,279,272,273,275,270,266,270,278,276,273,282,293,295,295,303,313,317,
	301,291,285,284,280,274,273,278,279,277,277,278,275,277,288,299,299,297,302,302,290,281,281,279,274,274,277,273,268,272,279,276,272,280,291,295,296,303,314,319,
	300,293,287,286,281,275,277,281,280,277,278,280,277,277,288,300,303,301,304,304,292,283,283,282,277,277,279,275,269,273,281,279,274,280,292,296,296,303,314,320,
	301,296,290,289,282,276,279,282,279,276,279,283,280,279,288,301,304,303,306,306,295,285,285,283,278,277,280,275,270,276,285,284,279,283,293,297,297,306,319,325,
	302,297,292,289,281,275,277,280,279,276,279,283,281,279,287,299,302,301,305,307,295,285,283,281,277,277,279,276,272,278,288,286,281,283,293,297,299,309,323,331,
	303,297,292,289,281,274,276,280,280,277,279,283,280,277,284,296,301,301,305,306,296,285,282,281,278,279,281,277,273,279,288,287,281,284,293,297,300,309,323,333,
	309,300,295,291,283,276,279,285,283,278,280,285,283,278,283,295,302,305,308,309,299,288,285,284,281,282,283,279,275,279,289,289,283,286,295,299,302,310,323,331,
	312,302,297,294,285,279,281,288,285,278,281,286,286,282,286,296,303,307,311,310,300,291,288,286,281,280,282,280,276,281,291,291,286,290,299,301,303,311,325,334,
	312,302,297,295,286,279,281,287,284,278,280,285,285,283,287,295,301,305,309,308,298,290,288,286,280,277,281,281,278,283,292,292,287,292,302,303,303,312,326,335,
	315,303,297,295,286,277,279,285,284,279,280,284,284,283,287,292,298,305,311,308,297,290,289,286,281,280,284,283,279,283,291,291,287,292,303,304,303,312,325,333,
	317,305,297,295,287,278,278,285,286,280,280,285,286,285,288,291,297,306,315,314,301,293,293,291,286,285,288,285,281,284,291,292,288,292,301,304,304,312,324,332,
	318,307,298,297,288,279,279,285,286,280,280,286,287,287,290,294,298,307,318,317,303,295,296,294,288,286,287,284,281,285,293,295,292,293,301,304,303,311,324,333,
	318,307,299,297,290,281,279,284,284,278,279,285,286,285,290,295,297,305,316,317,303,295,297,296,288,284,284,284,282,285,293,296,294,295,302,305,304,310,324,333,
	316,307,299,297,291,282,279,283,282,278,279,285,285,284,289,294,295,303,316,319,305,296,298,297,288,283,286,287,284,286,293,294,292,294,302,306,304,310,325,335,
	314,307,301,298,292,283,280,284,284,281,282,287,288,286,290,295,295,302,317,322,307,297,298,298,290,285,290,291,287,288,295,294,291,293,301,305,304,311,327,337,
	311,306,301,299,295,286,282,286,287,284,285,290,291,289,294,299,298,303,317,322,308,295,296,298,291,286,290,290,286,290,297,297,294,296,303,306,306,312,326,337,
	312,307,302,300,297,289,285,288,288,285,286,292,293,292,298,302,301,304,316,321,308,295,294,297,291,287,289,288,286,291,300,301,297,299,306,309,309,314,326,339,
	316,310,305,303,300,293,290,292,291,288,289,294,296,296,302,305,304,305,316,323,310,297,297,299,294,290,292,292,291,296,306,307,301,304,312,315,314,318,331,345,
	323,315,311,310,305,297,295,298,298,295,296,301,302,303,310,313,311,312,321,327,315,305,305,306,301,298,300,302,300,303,312,314,309,312,321,322,319,324,338,353,
	326,318,315,314,307,300,299,303,304,302,303,308,309,311,317,321,321,321,328,332,322,313,312,312,309,306,307,307,305,306,314,318,317,321,328,328,327,332,344,356,
	325,318,315,312,306,300,300,304,306,306,305,308,310,312,316,322,325,326,329,332,324,316,314,314,313,311,309,308,306,308,314,319,321,325,331,331,331,337,347,356,
};

uint16_t tx1PcCoffBuf[COLS_STYLUS_TIED * ROWS] =
{
	64,63,61,60,58,58,59,61,64,67,68,68,66,63,60,59,58,60,62,64,64,63,61,59,57,56,57,59,62,64,66,66,64,61,59,58,58,59,61,63,
	66,64,63,61,60,59,60,63,66,69,71,71,69,66,63,61,61,62,64,66,66,65,62,60,59,58,59,61,64,66,68,68,66,63,61,59,59,61,63,65,
	68,66,64,63,62,61,62,65,69,72,74,74,72,69,66,64,64,65,67,69,69,67,65,63,61,60,61,64,66,68,70,70,68,65,63,61,61,63,65,67,
	70,68,66,65,64,64,65,67,71,74,76,77,75,72,69,67,67,68,70,72,72,69,67,65,63,63,64,66,68,70,72,72,70,68,65,63,64,65,67,70,
	72,70,68,67,66,67,68,70,73,76,78,79,77,74,72,70,70,71,73,74,74,72,69,67,66,66,67,68,70,72,73,73,72,70,67,66,66,67,69,71,
	74,72,70,68,68,70,71,73,75,78,79,79,78,76,73,72,72,73,75,76,76,74,71,69,68,69,71,72,73,74,75,74,73,71,69,67,67,69,71,73,
	75,73,71,70,70,72,74,76,78,80,81,80,78,76,75,74,74,75,77,78,78,75,73,71,70,71,73,75,76,76,76,75,73,72,71,69,69,71,73,75,
	77,75,73,71,71,73,76,79,81,82,82,81,78,77,76,75,75,77,78,80,79,77,74,72,72,73,75,78,79,79,78,76,74,72,71,70,71,73,75,77,
	78,76,74,73,73,75,77,81,83,85,84,82,80,77,76,76,77,78,80,81,81,78,76,74,73,74,77,80,81,81,80,78,75,73,71,71,72,74,76,78,
	80,78,76,74,74,76,79,82,85,86,86,84,81,78,76,76,78,79,81,82,82,80,77,75,74,75,78,81,82,83,82,80,77,74,72,72,73,75,77,79,
	80,79,77,75,75,77,79,82,85,86,87,85,82,79,77,77,79,80,82,83,82,80,78,76,75,76,78,81,83,83,83,81,78,75,73,73,74,76,78,80,
	81,79,77,75,75,77,79,82,85,86,87,85,82,79,77,77,79,80,82,83,82,80,78,76,75,76,78,81,83,83,83,81,78,75,73,73,75,77,79,81,
};
uint16_t tx1PrCoffBuf[COLS * ROWS_STYLUS_TIED] =
{
	45,45,45,45,45,45,45,45,
	46,46,45,46,46,45,45,46,
	46,46,46,46,46,46,46,46,
	46,46,46,47,47,46,46,47,
	47,47,47,47,47,47,46,47,
	47,47,47,48,48,47,47,47,
	47,47,48,48,48,47,47,47,
	47,48,48,49,48,48,48,48,
	48,48,49,49,49,48,48,48,
	48,49,49,50,50,49,48,49,
	49,49,50,51,50,49,49,49,
	49,49,51,51,51,50,49,50,
	49,50,51,52,51,50,50,50,
	50,50,51,52,51,51,50,51,
	50,51,52,52,52,51,50,51,
	50,51,52,52,52,51,50,51,
	51,51,52,53,52,51,51,51,
	51,52,53,53,53,52,51,51,
	52,52,53,54,53,52,52,52,
	52,52,54,54,54,52,52,52,
	52,53,54,55,54,53,52,52,
	53,53,54,55,55,53,53,53,
	53,53,55,56,55,54,53,53,
	53,54,55,56,55,54,53,53,
	53,54,55,56,55,54,53,54,
	54,54,56,57,56,55,54,54,
	54,54,56,57,56,55,54,55,
	54,55,56,57,57,55,55,55,
	54,55,57,58,57,56,56,56,
	54,56,57,58,57,57,56,56,
	55,56,57,58,58,57,56,56,
	55,56,57,58,57,56,56,56,
	55,56,57,58,58,56,56,56,
	55,56,58,59,58,57,56,57,
	55,56,58,59,58,57,56,57,
	55,56,58,59,59,57,57,57,
	56,57,59,60,59,57,57,57,
	56,57,59,60,59,58,57,58,
	57,58,59,60,59,58,58,58,
	57,58,59,60,60,58,58,58,
	57,58,59,60,60,58,58,58,
	57,58,59,61,60,59,58,58,
	57,58,60,61,60,59,59,59,
	57,58,60,61,61,59,59,60,
	58,58,60,61,61,59,59,60,
	58,59,60,62,61,60,60,60,
	58,59,61,62,61,60,60,60,
	58,59,61,62,61,60,60,60,
	59,59,61,62,61,60,60,61,
	59,59,61,63,62,60,60,61,
	59,60,62,63,62,60,60,61,
	59,60,62,63,62,60,60,61,
	59,60,62,63,62,60,60,61,
	59,60,62,63,62,60,61,61,
	59,60,62,63,62,61,61,62,
	59,60,62,63,62,61,61,62,
	59,60,62,63,62,61,61,62,
	59,60,62,63,62,60,61,62,
	59,59,61,63,61,60,61,61,
	59,59,61,62,61,60,60,61,
};
uint16_t tx2PcCoffBuf[COLS_STYLUS_TIED * ROWS] =
{
};
uint16_t tx2PrCoffBuf[COLS * ROWS_STYLUS_TIED] =
{
};

#endif

static uint16_t grid_data[RAWDATA_NODES];
uint16_t base_data_even[RAWDATA_NODES];
uint16_t grid_last_even_data[RAWDATA_NODES];

void cts_print_rawdata(uint16_t *rawdata)
{
    char line_buf[ROWS * 6 + 128];
    int offset = 0,i,j;
    CTS_THP_LOGD("frame data");

    for (i = 0; i < ROWS; i++)
    {
        offset = 0;
        for (j = 0; j < COLS; j++)
        {
            offset += snprintf(line_buf + offset,sizeof(line_buf) - offset," %4d", rawdata[i * COLS + j]);
        }
        offset += snprintf(line_buf + offset,
                           sizeof(line_buf) - offset, "\n");
        CTS_THP_LOGE("%s", line_buf);
    }
}

void cts_print_stylusdata(uint16_t freqIndex, uint16_t *rawdata, uint16_t row, uint16_t col)
{
    char line_buf[ROWS * 6 + 128];
    int offset = 0,i,j;

    CTS_THP_LOGD("freq%d -----stylus data",freqIndex);

    for (i = 0; i < row; i++)
    {
        offset = 0;
        for (j = 0; j < col; j++)
        {
            offset += snprintf(line_buf + offset,sizeof(line_buf) - offset," %4d", rawdata[i * col + j]);
        }
        offset += snprintf(line_buf + offset,sizeof(line_buf) - offset, "\n");
        CTS_THP_LOGE("%s", line_buf);
    }
}

static void cts_transposition_pr_data(uint16_t *src_data, uint16_t *dsc_data, uint16_t nrows, uint16_t ncols)
{
	uint16_t i, j;
	for (i = 0; i < nrows; i++) {
		for (j = 0; j < ncols; j++)
			//dsc_data[i*ncols + j] = src_data[j*nrows + i];
			dsc_data[i*ncols + j] = src_data[nrows*ncols - (j*nrows + i) - 1];
	}
}

static void cts_transposition_pc_data(uint16_t *src_data, uint16_t *dsc_data, uint16_t nrows, uint16_t ncols)
{
	uint16_t i, j;
	for (i = 0; i < nrows; i++) {
		for (j = 0; j < ncols; j++)
			//dsc_data[i*ncols + j] = src_data[j*nrows + i];
			dsc_data[i*ncols + j] = src_data[nrows*ncols - (j*nrows + i) - 1];
	}
}


#if  1
static void cts_remap_grid_data(uint16_t *src_data, uint16_t *dsc_data, uint16_t nrows, uint16_t ncols)
{
    uint16_t i, j;
	uint16_t tmpdata[ROWS*COLS] = {0};
	
    for (i = 0; i < (ROWS*COLS); i++)
        tmpdata[ROWS*COLS-1-i] = src_data[i];

    for (i = 0; i < COLS; i++) {
        for (j = 0; j < ROWS; j++)
            dsc_data[j + i * ROWS] = tmpdata[i + j * COLS];
    }
}

//#define CTS_DEBUG_FREQ_NOISE
#ifdef CTS_DEBUG_FREQ_NOISE
extern void cts_print_fw_status(CTS_FRAME_STRUCT *frame);
#endif
static int cts_convert_grid_data(CTS_FRAME_STRUCT *thp_ctsframe)
{
    // int dst, src;
    int temp,index;
#ifdef CTS_DEBUG_FREQ_NOISE
	int nodes = 0;
#endif

#if 0  
    uint16_t temp_rawdata[RAWDATA_NODES];
    uint16_t noise_data[RAWDATA_NODES];
   

    uint16_t raw_data[32*50] = {0};
    int offest =0;
#endif

    uint16_t *FsCoffBuFreq = NULL;
//#define NORMALIZE_MODE
#ifdef NORMALIZE_MODE
    FsCoffBuFreq = FsCoffBuFreqNormalize;
#else
    if(thp_ctsframe->finger_scan_freq == s_scan_freq[0])
    {
       FsCoffBuFreq = FsCoffBuFreq0;
    }
    else if(thp_ctsframe->finger_scan_freq == s_scan_freq[1])
    {
      FsCoffBuFreq = FsCoffBuFreq0;
    }
    else if(thp_ctsframe->finger_scan_freq == s_scan_freq[2])
    {
      FsCoffBuFreq = FsCoffBuFreq0;
    }
    else{
        FsCoffBuFreq = FsCoffBuFreq0;
    }
#endif    

    for (int i = 0; i < ROWS; i++)
    {
        for (int j = 0; j < COLS; j++)
        {
            index = i*COLS + j;
            temp = (int)(grid_data[index] - baserawdata[index]);
#ifdef CTS_DEBUG_FREQ_NOISE
			if (temp > 500)
				nodes++;
#endif
            grid_data[index] = (int)(temp * FsCoffBuFreq[index] / 100) + 0x8000;
#ifdef NOISE_LOG
             //memcpy(temp_rawdata, grid_data, sizeof(temp_rawdata));
#endif
        }
    }
#ifdef CTS_DEBUG_FREQ_NOISE
	if (nodes > 64) {
		CTS_THP_LOGI("++ framedata error ++");
		cts_print_fw_status(thp_ctsframe);
	}
#endif

    /********************************************************************************************************************/
#ifdef NOISE_LOG
        cnt ++;

       if (cnt == 1)
        {
            // memcpy(max_rawdata, curr_rawdata, sizeof(max_rawdata));
            // memcpy(min_rawdata, curr_rawdata, sizeof(min_rawdata));
             memcpy(max_rawdata, grid_data, sizeof(max_rawdata));
             memcpy(min_rawdata, grid_data, sizeof(min_rawdata));
        }
        else
        {
            for (i = 0; i < RAWDATA_NODES; i++)
            {
                if (grid_data[i] > max_rawdata[i])
                {
                    max_rawdata[i] = grid_data[i];
                }
                else if (grid_data[i] < min_rawdata[i])
                {
                    min_rawdata[i] = grid_data[i];
                }
            }
        }
        for (i = 0; i < RAWDATA_NODES; i++)
         {
           noise_data[i] = max_rawdata[i] - min_rawdata[i];
        
         }

         if((cnt%30) == 0 )
         {
            cnt =0;
            memset(max_rawdata, 0, sizeof(max_rawdata));
            memset(min_rawdata, 0, sizeof(max_rawdata));

            cts_dump_tsdata("noise", 30, noise_data);
            //cts_print_rawdata(noise_data);
            //LOGD("1111222");
            //cts_print_rawdata(min_rawdata);
         }
#endif            
    if ((thp_ctsframe->afe_status & 0x40) == 0x40)
    {
        //cts_tcs_get_debug_info(&debug);
        //read_hard_reg();
        CTS_THP_LOGI("sos,print origina data");
        // cts_print_fw_status(thp_ctsframe);
        // cts_print_rawdata(thp_ctsframe->rawdata);
        //flag = true;

    }   

    // memcpy(thp_ctsframe->rawdata, grid_data, ROWS*COLS*2);
#if 0
    if (!poweron)
    {
        memcpy(base, thp_data, RAWDATA_SIZE);
    }
#endif
    return 0;
}

#elif 0
static void cts_convert_grid_data(uint16_t *src_data, uint16_t *dsc_data, uint16_t nrows, uint16_t ncols)
{
    uint16_t i;
    for (i = 0; i < nrows*ncols; i++)
    {
        dsc_data[i] = 0x8000 + (src_data[i] - s_Fs_raw_dest_value)*5/2;
    }
}

#else
static int cts_convert_grid_data_new(uint16_t *thp_data,  uint16_t  finger_scan_freq)
{
    int i, j;
    int dst, src;


    uint16_t Ka=10,Kb=10;

#if  0
    if (finger_scan_freq == F_FREQ2 )
        Ka=12;
    else if (finger_scan_freq == F_FREQ3 )
        Ka=15;
    else
        Ka=10;
#else
    Ka = finger_scan_freq;
    Kb = F_FREQ1;
#endif

    for (i = 0; i < ROWS; i++)
    {
        for (j = 0; j < COLS; j++)
        {
            dst = i * COLS + j;
            src = j * ROWS + i;

#if  0
            grid_data[dst] = (((thp_data[src] - s_Fs_raw_dest_value) * FsCoffBuf[src]/ 100) + 0x8000);
#else
            grid_data[dst] = (((thp_data[src] - s_Fs_raw_dest_value) * FsCoffBuf[src]* Ka/Kb/ 100) + 0x8000);
#endif
        }
    }

    memcpy(thp_data, grid_data, RAWDATA_SIZE);

    return 0;
}
#endif
uint16_t FreqBase0[RAWDATA_NODES];
uint16_t FreqBase1[RAWDATA_NODES];
uint16_t FreqBase2[RAWDATA_NODES];
uint16_t LastData[RAWDATA_NODES];
bool bBaseDone= 0;
bool bBaseRetry= false;
bool bBaseGet= false;
uint16_t DifStableCnt = 0;
uint16_t u16BaseSave= 0;

int checkBaseDif(uint16_t *pCurBase)
{
    // uint16_t Dif0[ROWS*COLS];
    // uint16_t maxDif =0;
    uint16_t tmpDif = 0;
    uint16_t index = 0;

    for (int i = 0; i < ROWS; i++) {
        for (int j = 0; j < COLS; j++) {
            index = i*COLS + j;
            tmpDif = abs(grid_data[index] - pCurBase[index]);
            // maxDif = max( tmpDif, maxDif);
            if(tmpDif  > 80) {
                return false;
            }
        }
    }
    return true;
}

static int checkDifStable(uint16_t *pCurBase)
{
    // uint16_t Dif0[ROWS*COLS];
    // uint16_t maxDif =0;
    int32_t tmpDif1 = 0;
    int32_t tmpDif2 = 0;
    uint16_t index = 0;
    for (int i = 0; i < ROWS; i++) {
        for (int j = 0; j < COLS; j++) {
            index = i*COLS + j;
            tmpDif1 = (grid_data[index] - pCurBase[index]);
            tmpDif2 = abs(grid_data[index] - LastData[index]);
            if(tmpDif1  > 80  || tmpDif2 > 80) {
                return false;
            }
        }
    }
    return true;
}
  int cts_Freq_base_process(CTS_FRAME_STRUCT *thp_ctsframe)
{
    // CTS_THP_LOGW("frame_index ----%d----  ",thp_ctsframe->frame_index);

    uint16_t index = 0;
    uint16_t *pCurBase = NULL;
	
    if(thp_ctsframe->finger_scan_freq == s_scan_freq[0]) {
        pCurBase = FreqBase0;
    } else if(thp_ctsframe->finger_scan_freq == s_scan_freq[1]) {
        pCurBase = FreqBase1;
    } else if(thp_ctsframe->finger_scan_freq == s_scan_freq[2]) {
        pCurBase = FreqBase2;
    } else {
        return 0;
    }
	
    //CTS_THP_LOGW("scan_freq ----%d----  ", thp_ctsframe->finger_scan_freq);
    //CTS_THP_LOGW("bBaseDone ----%d----  ", bBaseDone);
	
    if(bBaseDone) {
        
        if(thp_ctsframe->finger_scan_freq == s_scan_freq[0]) {
            //  CTS_THP_LOGW("bBasepro %d --00000-");
            return 0;
        }

        for (int i = 0; i < ROWS; i++) {
            for (int j = 0; j < COLS; j++) {
                index = i*COLS + j;
                grid_data[index] = grid_data[index] - pCurBase[index] + FreqBase0[index];
            }
        }
        // CTS_THP_LOGW("bBasepro %d ------", thp_ctsframe->finger_scan_freq);
        
        return 0 ;
    }

//  CTS_THP_LOGW("u16BaseSave ----%d----  ", u16BaseSave);

    if(u16BaseSave == (BIT(0)|BIT(1)|BIT(2))
    /* && (thp_ctsframe->finger_scan_freq == s_scan_freq[0])*/) {
        bBaseGet = true;
        if(!bBaseRetry) {
            if(checkBaseDif(pCurBase)) {
                DifStableCnt++;
               
                if(DifStableCnt >= 3) {
                    bBaseDone = true;
                    u16BaseSave = 0;
                    CTS_THP_LOGI("Reference Data Done!");
                }
            } else {
                bBaseRetry = true;
                DifStableCnt = 0;
            }
        }
    }
	
    if (bBaseRetry || !bBaseGet) {
        if(checkDifStable(pCurBase)) {
            DifStableCnt ++;
        } else {
            if(DifStableCnt) {
                DifStableCnt --;
            }
            if(DifStableCnt) {
                DifStableCnt --;
            }
        }
        //CTS_THP_LOGW("bBaseRetry DifStableCnt %d ------", DifStableCnt);
        if(DifStableCnt > 10) {
            u16BaseSave = 0;
            bBaseGet = false;
            DifStableCnt = 0;
            bBaseRetry = false;
			
            CTS_THP_LOGI("Reference Data Update Restart");
            cts_tcs_freq_base_update();
        }

    }
    
	//CTS_THP_LOGW("u16BaseSave ----%d---%d---  ", u16BaseSave, bBaseGet);

    if( thp_ctsframe->afe_status & THP_AFE_STATUS_ALL_FREQ_NOISY) {
        thp_ctsframe->afe_status &= ~THP_AFE_STATUS_ALL_FREQ_NOISY;
        DifStableCnt = 0;
        if (thp_ctsframe->finger_scan_freq == s_scan_freq[0]) {
            memcpy(FreqBase0, LastData, RAWDATA_SIZE);
            u16BaseSave |= BIT(0);
            // CTS_THP_LOGW("F000");
        } else if (thp_ctsframe->finger_scan_freq == s_scan_freq[1]) {
            memcpy(FreqBase1, grid_data, RAWDATA_SIZE);
            u16BaseSave |= BIT(1);
            memcpy(grid_data, LastData, RAWDATA_SIZE);
            // CTS_THP_LOGW("F111");
        } else if (thp_ctsframe->finger_scan_freq == s_scan_freq[2]) {
            memcpy(FreqBase2, grid_data, RAWDATA_SIZE);
            u16BaseSave |= BIT(2);
            memcpy(grid_data, LastData, RAWDATA_SIZE);
            // CTS_THP_LOGW("F222");
        } else {
            return 0;
        }
    }
    memcpy(LastData, grid_data, RAWDATA_SIZE);

    return 0;
}
//add yjl  ---need  check  para
//#define   CHECK_CALIBRATION_DONE_DATA

#ifdef   CHECK_CALIBRATION_DONE_DATA
#define   CALIBRATION_DONE_RAW_CHECK_DELTA        FS_RAW_DEST_VALUE
#define   CALIBRATION_DONE_RAW_CHECK_ERR_MAX_THD  (FS_RAW_DEST_VALUE*3)
#define   CALIBRATION_DONE_RAW_CHECK_ERR_MIN_THD  (FS_RAW_DEST_VALUE/4)

bool AppBeforeCheckCalibrationDone(uint16_t* rawdata)
{
    uint8_t  i, raw[4], col[4];
    uint8_t  CMDA1 = ROWS/2, LeftLength = COLS/2, RightLength = COLS/2;
    uint16_t offset, temp[4], max = 0, min = 0xFFFF;

    raw[0] = rand() % CMDA1;
    raw[1] = raw[0];
    col[0] = rand() % LeftLength;
    col[1] = rand() % RightLength + LeftLength;

    raw[2] = rand() % CMDA1 + CMDA1;
    raw[3] = raw[2];
    col[2] = rand() % LeftLength;
    col[3] = rand() % RightLength + LeftLength;


    for (i = 0; i < 4; i++)
    {
        offset = raw[i] * COLS + col[i];

        temp[i] = rawdata[offset];
        if (temp[i] > max)
        {
            max = temp[i];
        }
        if (temp[i] < min)
        {
            min = temp[i];
        }

        //CTS_THP_LOGI("offset:%04d,%04d,%04d",raw[i], col[i], temp[i]);
    }
    // CTS_THP_LOGI("raw jump:%04d,", max - min);
    if ((abs(max - min) > CALIBRATION_DONE_RAW_CHECK_DELTA)
        ||( max >  CALIBRATION_DONE_RAW_CHECK_ERR_MAX_THD)
        ||( min <  CALIBRATION_DONE_RAW_CHECK_ERR_MIN_THD)
       )
    {
        return  true;
    }
    return false;
}
#endif

#define BIG_NEG_DIFF_TH                  100
#define BIG_NEG_AREA_TH                  10
#define INTER_FRAME_NOISE_DIFF_TH        50
#define INTER_FRAME_NOISE_AREA_TH        8
#define NONE_NOISE_FRAME_TH              10
//add yjl  ---need  check  para

void cts_calibrate_check( uint16_t *rawdata,CTS_FRAME_STRUCT *cts_frame)
{
    uint8_t i, j;
    uint16_t  offset;
    uint16_t u16BigNoiDiffCnt = 0;
    int16_t g_s16realdiff0,  g_s16stable0;   //even
    static uint16_t u16NoneNoiFrameCnt =0;
    static uint16_t u16BigDiffNegCnt = 0 ;
    static  bool  nobase_even=true, negdiffFlag=false;
    int done_flag =0;

#ifdef   CHECK_CALIBRATION_DONE_DATA
    if ( AppBeforeCheckCalibrationDone(rawdata))
    {
        return;
    }
#endif

    if (1)
    {
        static  bool  noLastRaw=true;
        if ( ((cts_frame->frame_type & 0x01) ==0x01 ) &&
             (((cts_frame->afe_status & THP_AFE_STATUS_CALIBRATION_DONE )== THP_AFE_STATUS_CALIBRATION_DONE) || (cts_frame->frame_index == 1))
           )
        {
            return;
        }
        else if ( ((cts_frame->frame_type & 0x01) ==0x00 ) &&
                  ( (cts_frame->frame_index ==2) || noLastRaw || nobase_even ))
        {
            memcpy(base_data_even, rawdata, RAWDATA_SIZE);
            nobase_even=false;

            noLastRaw = false;
            memcpy(grid_last_even_data, rawdata, RAWDATA_SIZE);
            return;
        }
    }

    if (   (cts_frame->afe_status & THP_AFE_STATUS_SOS ) ==THP_AFE_STATUS_SOS || (cts_frame->afe_status & THP_AFE_STATUS_CALIBRATION_DONE ) ==THP_AFE_STATUS_CALIBRATION_DONE  )
    {
        return;
    }

    if ((cts_frame->frame_type & 0x01) ==0x01)
    {
        negdiffFlag =false;
        for (i = 0; i < COLS; i++)
        {
            for (j = 0; j < ROWS; j++)
            {
                offset = i*ROWS+j;
                g_s16realdiff0 = rawdata[offset] - base_data_even[offset];


                if (g_s16realdiff0 < (0- (int16_t)BIG_NEG_DIFF_TH))
                {
                    u16BigDiffNegCnt = u16BigDiffNegCnt +  abs(g_s16realdiff0)/BIG_NEG_DIFF_TH;
                }
            }

            if (  u16BigDiffNegCnt > BIG_NEG_AREA_TH  )
            {
                negdiffFlag  =true;
                break;
            }
        }
        return;
    }
    else
    {
        if (  negdiffFlag ==false )
        {
            memcpy(grid_last_even_data, rawdata,RAWDATA_SIZE);
            u16BigDiffNegCnt =0;

            // CTS_THP_LOGD("no neg diff--- u16BigDiffNegCnt  =  %4d", u16BigDiffNegCnt);
            return;
        }
        negdiffFlag =false ;
    }


    for (i = 0; i < COLS; i++)
    {
        for (j = 0; j < ROWS; j++)
        {
            offset = i*ROWS+j;
            g_s16stable0 = rawdata[offset] - grid_last_even_data[offset];

            if (abs(g_s16stable0) > INTER_FRAME_NOISE_DIFF_TH )
            {
                u16BigNoiDiffCnt =u16BigNoiDiffCnt + abs(g_s16stable0)/INTER_FRAME_NOISE_DIFF_TH ;
            }
        }
        if ( u16NoneNoiFrameCnt > INTER_FRAME_NOISE_AREA_TH )
        {
            break;
        }
    }

    if (u16BigNoiDiffCnt == 0 )
    {
        u16NoneNoiFrameCnt++;
        //CTS_THP_LOGE("u16NoneNoiFrameCnt   %d ", u16NoneNoiFrameCnt);
        if (u16NoneNoiFrameCnt >= NONE_NOISE_FRAME_TH )
        {
            u16NoneNoiFrameCnt =0;
            nobase_even=true;

            if (done_flag == 0)
            {
                int temp = 0;
                for (i = 0; i < COLS; i++)
                {
                    for (j = 0; j < ROWS; j++)
                    {
                        offset = i*ROWS+j;
                        temp = temp + (rawdata[offset])/(FS_RAW_DEST_VALUE/3*5);
                    }
                }

                //CTS_THP_LOGE("111   %d ", temp);
                if (temp == 0)
                {
                    cts_tcs_Calib_update();
                    done_flag = 1;
                    //CTS_THP_LOGE("11111calibra done");
                }

            }

            // CTS_THP_LOGE("find  calibration down-------nobase_even  =  %4d" ,nobase_even);
        }
    }
    else
    {
        if (u16NoneNoiFrameCnt>0)
            u16NoneNoiFrameCnt = u16NoneNoiFrameCnt>>1;
    }


    //CTS_THP_LOGD("u16BigDiffNegCnt=  %4d, u16BigNoiDiffCnt=  %4d, u16NoneNoiFrameCnt  =  %4d ++++++++++++++++++++++++++++++++++++++", u16BigDiffNegCnt, u16BigNoiDiffCnt , u16NoneNoiFrameCnt);
    //CTS_THP_LOGD("nobase_cardinal  =  %4d, nobase_even  =  %4d",  nobase_cardinal ,nobase_even);

    memcpy(grid_last_even_data, rawdata,RAWDATA_SIZE);
    u16BigDiffNegCnt =0;
}

static uint16_t tx1_line_data[(COLS_STYLUS_TIED*ROWS + ROWS_STYLUS_TIED*COLS)];
static uint16_t tx2_line_data[(COLS_STYLUS_TIED*ROWS + ROWS_STYLUS_TIED*COLS)];
void cts_convert_pc_line_data(uint16_t *data, int rows, int cols, bool is_tx2)
{
    int index = 0;
    for (int i = 0; i < rows; i++){
        for (int j = 0; j < cols; j++){
            index = i * cols + j;
#if 0            
            if (index == 0){
                data[index] = tx1PcCoffBuf[index];
                continue;
            }
            if (index == cols - 1){
                data[index] = tx1PcCoffBuf[index];
                continue;
            }
            if (index == cols*rows - cols){
                data[index] = tx1PcCoffBuf[index];
                continue;
            }
            if (index == cols*rows -1){
                data[index] = tx1PcCoffBuf[index];
                continue; 
            }                                           
#endif            
          	if (is_tx2)
            data[index] = (uint16_t)((data[index] * tx1PcCoffBuf[index]) / 100);
            else
            	data[index] = (uint16_t)((data[index] * tx1PcCoffBuf[index]) / 200);
        }
    }
}
void cts_convert_pr_line_data(uint16_t *data, int rows, int cols, bool is_tx2)
{
    int index = 0;
    for (int i = 0; i < rows; i++){
        for (int j = 0; j < cols; j++){
            index = i * cols + j;
#if 0            
            if (index == 0){
                data[index] = tx1PrCoffBuf[index];
                continue;
            }
            if (index == cols - 1){
                data[index] = tx1PrCoffBuf[index];
                continue;
            }
            if (index == cols*rows - cols){
                data[index] = tx1PrCoffBuf[index];
                continue;
            }
            if (index == cols*rows -1){
                data[index] = tx1PrCoffBuf[index];
                continue; 
            }                                           
#endif     
            if (is_tx2)
            data[index] = (uint16_t)((data[index] * tx1PrCoffBuf[index]) / 100);
            else
            	data[index] = (uint16_t)((data[index] * tx1PrCoffBuf[index]) / 200);
        }
    }
}

//#define CTS_DEBUG_STYLUS_DATA
//#define CTS_DEBUG_STYLUS_DATA_BEFORE
void cts_remap_tx_line_data(uint16_t *stylus_frame)
{
    uint16_t offset = 0, length = 0;
    uint16_t temp1[ROWS_STYLUS_TIED*COLS],temp2[ROWS_STYLUS_TIED*COLS];
    uint16_t temp3[COLS_STYLUS_TIED*ROWS],temp4[COLS_STYLUS_TIED*ROWS];
    uint16_t temp5[ROWS_STYLUS_TIED*COLS],temp6[COLS_STYLUS_TIED*ROWS];

    offset = 0;
    length = sizeof(temp1);
    memcpy(temp1, &stylus_frame[offset], length);

    offset += ROWS_STYLUS_TIED*COLS;
    length = sizeof(temp2);
    memcpy(temp2, &stylus_frame[offset], length);

#ifdef CTS_DEBUG_STYLUS_DATA_BEFORE
	CTS_THP_LOGI("+++++++++++++++++ BEFORE PR TX1 +++++++++++++++++");
	dump_spi_full_data_16(temp1, ROWS_STYLUS_TIED, COLS);
#endif
	
    memcpy(temp5, temp1, sizeof(temp5));
    cts_transposition_pr_data(temp5, temp1, COLS, ROWS_STYLUS_TIED);
    cts_convert_pr_line_data(temp1, COLS, ROWS_STYLUS_TIED, false);
    memcpy(temp5, temp2, sizeof(temp5));
    cts_transposition_pr_data(temp5, temp2, COLS, ROWS_STYLUS_TIED);
    cts_convert_pr_line_data(temp2, COLS, ROWS_STYLUS_TIED, true);
	
    offset += ROWS_STYLUS_TIED*COLS;
    length = sizeof(temp3);
    memcpy(temp3, &stylus_frame[offset], length);

    offset += COLS_STYLUS_TIED*ROWS;
    length = sizeof(temp4);
    memcpy(temp4, &stylus_frame[offset], length);

#ifdef CTS_DEBUG_STYLUS_DATA_BEFORE
	CTS_THP_LOGI("+++++++++++++++++ BEFORE PC TX1 +++++++++++++++++");
	dump_spi_full_data_16(temp3, ROWS, COLS_STYLUS_TIED);
#endif

    memcpy(temp6, temp3, sizeof(temp3));
    cts_transposition_pc_data(temp6, temp3, COLS_STYLUS_TIED, ROWS);
    cts_convert_pc_line_data(temp3, COLS_STYLUS_TIED, ROWS, false);
	memcpy(temp6, temp4, sizeof(temp4));
    cts_transposition_pc_data(temp6, temp4, COLS_STYLUS_TIED, ROWS);
    cts_convert_pc_line_data(temp4, COLS_STYLUS_TIED, ROWS, true);
	
    offset = 0;
    length = sizeof(temp3);
    memcpy(&tx1_line_data[offset], temp3, length);

    offset += COLS_STYLUS_TIED*ROWS;
    length = sizeof(temp1);
    memcpy(&tx1_line_data[offset], temp1, length);
	
#ifdef CTS_DEBUG_STYLUS_DATA
	CTS_THP_LOGI("+++++++++++++++++ PC TX1 +++++++++++++++++");
	dump_spi_full_data_16(tx1_line_data, COLS_STYLUS_TIED, ROWS);
	CTS_THP_LOGI("+++++++++++++++++ PR TX1 +++++++++++++++++");
	dump_spi_full_data_16(&tx1_line_data[offset], COLS, ROWS_STYLUS_TIED);
#endif

    offset = 0;
    length = sizeof(temp4);
    memcpy(&tx2_line_data[offset], temp4, length);

    offset += COLS_STYLUS_TIED*ROWS;
    length = sizeof(temp2);
    memcpy(&tx2_line_data[offset], temp2, length);

    //for (offset=0; offset <(COLS_STYLUS_TIED*ROWS + ROWS_STYLUS_TIED*COLS) ; offset++)
    // {
    //tx1_line_data[offset] /=2;
    //}

}

uint16_t stylusmode_fingerRaw_All[ROWS * COLS];
uint8_t stylusFingerStatus = 0;
// #define DUMP_STYLUS_FINGER_DATA
void cts_convert_stylusmode_grid_data(CTS_FRAME_FINGER_STYLUS_STRUCT *cts_merge_frame)
{
    uint16_t length = (int)(ROWS*COLS/4);
    uint16_t offset = 0;
    if (cts_merge_frame->frame_type == FRAME_TYPE_STYLUS_0)
    {
        memcpy(stylusmode_fingerRaw_All,cts_merge_frame->rawdata, length* sizeof(uint16_t));
        stylusFingerStatus |= 1 << 0;
#ifdef DUMP_STYLUS_FINGER_DATA
        CTS_THP_LOGI("frame_type:%2x",cts_merge_frame->frame_type);
        cts_print_stylusdata(1, stylusmode_fingerRaw_All, ROWS/4,COLS);
#endif        
    }
    offset += length;
    if (cts_merge_frame->frame_type == FRAME_TYPE_STYLUS_1)
    {
        memcpy(&stylusmode_fingerRaw_All[offset], cts_merge_frame->rawdata, length*sizeof(uint16_t));
        stylusFingerStatus |= 1 << 1;
#ifdef DUMP_STYLUS_FINGER_DATA        
        CTS_THP_LOGI("frame_type:%2x", cts_merge_frame->frame_type);
        cts_print_stylusdata(1, &stylusmode_fingerRaw_All[offset], ROWS/4,COLS );
#endif        
    }
    offset += length;
    if (cts_merge_frame->frame_type == FRAME_TYPE_STYLUS_2)
    {
        memcpy(&stylusmode_fingerRaw_All[offset], cts_merge_frame->rawdata, length* sizeof(uint16_t));
        stylusFingerStatus |= 1 << 2;
#ifdef DUMP_STYLUS_FINGER_DATA        
        CTS_THP_LOGI("frame_type:%2x", cts_merge_frame->frame_type);
        cts_print_stylusdata(1, &stylusmode_fingerRaw_All[offset], ROWS/4, COLS);
#endif        
    }
    offset += length;
    if (cts_merge_frame->frame_type == FRAME_TYPE_STYLUS_3)
    {
        memcpy(&stylusmode_fingerRaw_All[offset], cts_merge_frame->rawdata, length*sizeof(uint16_t));
        stylusFingerStatus |= 1 << 3;
#ifdef DUMP_STYLUS_FINGER_DATA
        CTS_THP_LOGI("frame_type:%2x", cts_merge_frame->frame_type);
        cts_print_stylusdata(1, &stylusmode_fingerRaw_All[offset], ROWS/4, COLS);
#endif
        if (stylusFingerStatus != 0x0F){
            CTS_THP_LOGI("stylusFingerStatus:%2x", stylusFingerStatus);
            memset(stylusmode_fingerRaw_All, 0, sizeof(stylusmode_fingerRaw_All));
            stylusFingerStatus = 0;
    	}
    }
}

static int cts_convert_frame(struct timeval *tv,CTS_FRAME_STRUCT *cts_frame,CTS_FRAME_FINGER_STYLUS_STRUCT *cts_merge_frame,THP_AFE_FRAME_DATA_STRUCT *thp_frame,THP_AFE_STYLUS_FRAME_DATA_STRUCT *stylus_frame )
{

    memset(thp_frame, 0, sizeof(*thp_frame));
    memset(stylus_frame, 0, sizeof(*stylus_frame));


    // finger data
    if ( cts_frame->frame_type == FRAME_TYPE_FINGER_0 || cts_frame->frame_type == FRAME_TYPE_FINGER_1 )
    {
        thp_frame->time_stamp.tv_sec = tv->tv_sec;
        thp_frame->time_stamp.tv_usec = tv->tv_usec;

#if  0
        //cts_transposition_grid_data(cts_frame->rawdata, grid_data, ROWS, COLS);
cts_convert_grid_data(grid_data,grid_data,ROWS, COLS);

#elif  1
		if (((cts_frame->afe_status & THP_AFE_STATUS_CALIBRATION_DONE) == THP_AFE_STATUS_CALIBRATION_DONE)
			&& !first_cali_done) {
			first_cali_done = true;
			cts_remap_grid_data(cts_frame->rawdata, baserawdata, ROWS, COLS);
			// memcpy(baserawdata, cts_frame->rawdata, ROWS * COLS * 2);
	        CTS_THP_LOGI("calibration done, base update.");
		}
		cts_remap_grid_data(cts_frame->rawdata, grid_data, ROWS, COLS);
	    cts_Freq_base_process(cts_frame);
		cts_convert_grid_data(cts_frame);
#else
		uint16_t i, j;
		for (i = 0; i < (ROWS*COLS); i++)
			grid_data[ROWS*COLS-1-i] = cts_frame->rawdata[i];

		uint16_t tmpdata[ROWS*COLS];
		MEMCPY(tmpdata, grid_data, sizeof(tmpdata));
		for (i = 0; i < COLS; i++) {
			for (j = 0; j < ROWS; j++)
				grid_data[j + i * ROWS] = tmpdata[i + j * COLS];
		}

		cts_convert_grid_data(grid_data, grid_data, ROWS, COLS);
#endif

        thp_frame->frame_index = cts_frame->frame_index;
		
        thp_frame->grid_data = grid_data;
        thp_frame->line_data = NULL;
        thp_frame->button_data = NULL;
        thp_frame->noise_data = NULL;//cts_frame->finger_noise;
        thp_frame->scan_freq =  cts_frame->finger_scan_freq;
        thp_frame->scan_rate = cts_frame->finger_scan_rate;
        thp_frame->status = cts_frame->afe_status;

        //CTS_THP_LOGD("frame_index=%d,thp_frame->status =%x,scan_freq=%d,frame_type=%x,scan_rate=%d",  cts_frame->frame_index,thp_frame->status, thp_frame->scan_freq , cts_frame->frame_type, thp_frame->scan_rate);

        if ((cts_frame->afe_status & THP_AFE_STATUS_SOS) == THP_AFE_STATUS_SOS)
        {
            cts_print_rawdata(cts_frame->rawdata);
            //g_esd_flag = true;
            CTS_THP_LOGI("sos");
        }

        if ( (cts_frame->afe_status & THP_AFE_STATUS_RECAL_REQUEST) == THP_AFE_STATUS_RECAL_REQUEST )
        {
            CTS_THP_LOGI("recalibration request");
        }


        if ( last_afe_status != (cts_frame->afe_status & (THP_AFE_STATUS_IDLE_MODE | THP_AFE_STATUS_ACTIVE_MODE)))
        {
            if ( last_afe_status == THP_AFE_STATUS_IDLE_MODE )
            {
                CTS_THP_LOGI("idle exit[status=0x%x]", cts_frame->afe_status );
                //CTS_THP_LOGD("Set active timeout %d ms after real active", DAEMON_GET_DATA_TIME_OUT_ACTIVE);
                thp_ioctl_set_timeout(DAEMON_GET_DATA_TIME_OUT_ACTIVE);
            }
            else
            {
                CTS_THP_LOGI("idle in[status=0x%x]", cts_frame->afe_status);
                //thp_ioctl_set_timeout(DAEMON_GET_DATA_TIME_OUT_IDLE);
            }
        }

#if 1
        if (abs(last_Frame_index - cts_frame->frame_index ) > 1 && 
            abs(last_Frame_index - cts_frame->frame_index ) < 100 && 
            last_Frame_index !=0)
        {
            CTS_THP_LOGI("LastIndex:%d, CurrentIndex:%d", last_Frame_index,cts_frame->frame_index);
        }
        else
        {
             //CTS_THP_LOGI("CurrentIndex:%d", cts_frame->frame_index);
        }
#endif

        if (last_finger_freq != thp_frame->scan_freq)
        {
            CTS_THP_LOGI("curr_freq=%d,last_freq=%d", thp_frame->scan_freq,last_finger_freq);
        }

        //CTS_THP_LOGI("curr_freq=%d,last_freq=%d", thp_frame->scan_freq,last_finger_freq);

        thp_frame->gesture = cts_frame->gesture_status;
        thp_frame->side_data = NULL;
        thp_frame->force_data = NULL;
        thp_frame->scan_state = THP_AFE_SCAN_STATE_WHOLE;


        thp_frame->stylus = stylus_frame;
        stylus_frame->tx1_line_data = tx1_line_data;
        stylus_frame->tx2_line_data = tx2_line_data;

        // stylus_frame->status = cts_frame->stylus_status|THP_AFE_STATUS_HPP3_0_PROTOCOL|THP_AFE_STATUS_STYLUS_DETECT_MODE;
        stylus_frame->status = THP_AFE_STATUS_HPP3_0_PROTOCOL|THP_AFE_STATUS_STYLUS_DETECT_MODE;
        stylus_frame->pressure = 1;
        stylus_frame->button = 0;
        stylus_frame->stylus_noise = NULL;  //cts_frame->stylus_noise;

        stylus_frame->tx1_scan_freq = cts_frame->stylus_tx1_curr_scan_freq;
        stylus_frame->tx2_scan_freq = cts_frame->stylus_tx2_curr_scan_freq;
        stylus_frame->tx1_new_scan_freq = cts_frame->stylus_tx1_next_scan_freq;
        stylus_frame->tx2_new_scan_freq = cts_frame->stylus_tx2_next_scan_freq;


        if (last_stylus_status)
        {
            CTS_THP_LOGI("stylus out");
        }

        last_afe_status = thp_frame->status & ( THP_AFE_STATUS_IDLE_MODE | THP_AFE_STATUS_ACTIVE_MODE);
        last_stylus_status =0;
        last_finger_freq = thp_frame->scan_freq;
        last_Frame_index = thp_frame->frame_index;

        return 0;
    }// finger data

    if (cts_frame->frame_type == FRAME_TYPE_STYLUS_0 || cts_frame->frame_type == FRAME_TYPE_STYLUS_1 || 
        cts_frame->frame_type == FRAME_TYPE_STYLUS_2 || cts_frame->frame_type == FRAME_TYPE_STYLUS_3)
    {
        memset(stylus_frame, 0, sizeof(*stylus_frame));

        thp_frame->time_stamp.tv_sec = tv->tv_sec;
        thp_frame->time_stamp.tv_usec = tv->tv_usec;
        thp_frame->frame_index = cts_frame->frame_index;

        cts_remap_tx_line_data(cts_merge_frame->stylusdata);
        cts_convert_stylusmode_grid_data(cts_merge_frame);

        // CTS_THP_LOGD("frame_index=%d,thp_frame->status=%x,frame_type=%x,scan_freq=%d,scan_rate=%d", cts_frame->frame_index, thp_frame->status,cts_frame->frame_type,  thp_frame->scan_freq , thp_frame->scan_rate);
        if (cts_frame->frame_type == FRAME_TYPE_STYLUS_3 && stylusFingerStatus == 0x0F) {
			cts_remap_grid_data(stylusmode_fingerRaw_All, grid_data, ROWS, COLS);
			cts_convert_grid_data(cts_frame);
            thp_frame->grid_data = grid_data;
            stylusFingerStatus = 0;
        } else {
	        thp_frame->grid_data = NULL;
        }

        thp_frame->line_data = NULL;
        thp_frame->button_data = NULL;
        thp_frame->noise_data = NULL;//cts_frame->finger_noise;
        thp_frame->scan_freq =  cts_frame->finger_scan_freq;
        thp_frame->scan_rate = cts_frame->finger_scan_rate;
        thp_frame->status = cts_frame->afe_status;
        thp_frame->status = cts_frame->afe_status & (THP_AFE_STATUS_ACTIVE_MODE|THP_AFE_STATUS_IDLE_MODE);
        thp_frame->gesture = cts_frame->gesture_status;
        thp_frame->side_data = NULL;
        thp_frame->force_data = NULL;
        thp_frame->scan_state = THP_AFE_SCAN_STATE_WHOLE;

        thp_frame->stylus = stylus_frame;
        stylus_frame->tx1_line_data = tx1_line_data;

        stylus_frame->tx2_line_data = tx2_line_data;
        //stylus_frame->tx2_line_data = tx2_line_data
        //stylus_frame->status = cts_frame->stylus_status;
        stylus_frame->status = THP_AFE_STATUS_HPP3_0_PROTOCOL|THP_AFE_STATUS_STYLUS_ACTIVE_MODE;
        stylus_frame->pressure = 1;
        stylus_frame->button = 0;
        stylus_frame->stylus_noise = NULL;  //cts_frame->stylus_noise;
        stylus_frame->tx1_scan_freq = cts_frame->stylus_tx1_curr_scan_freq;
        stylus_frame->tx2_scan_freq = cts_frame->stylus_tx2_curr_scan_freq;
        stylus_frame->tx1_new_scan_freq = cts_frame->stylus_tx1_next_scan_freq;
        stylus_frame->tx2_new_scan_freq = cts_frame->stylus_tx2_next_scan_freq;

        if (last_stylus_status != stylus_frame->status)
        {
            CTS_THP_LOGI("stylus in");
        }
        last_afe_status = THP_AFE_STATUS_ACTIVE_MODE ;
        last_stylus_status=stylus_frame->status;
        last_Frame_index= cts_frame->frame_index;

        return 0;
    }

    CTS_THP_LOGE("ERROR!! Should not be here!!");
    return 0;
}

/* thp */
int cts_open(void)
{
    return cts_open_project(PROJECT_ID);
}

int cts_open_project(const char *proj_id)
{
    return strcmp(PROJECT_ID, proj_id);
}

int cts_set_calib_data_callback_func(
    THP_AFE_ERR_ENUM(*calibDataWriteCallback)(void* dataPtr, uint32_t dataLen),
    THP_AFE_ERR_ENUM(*calibDataReadCallback)(void* dataPtr, uint32_t dataLen))
{
    //yjl
    CTS_THP_LOGD("----------cts_set_calib_data_callback_func---");
    return 0;
}

int cts_start(void)
{
    int ret = -1;
    ret = thp_dev_open();
    if (ret < 0)
    {
        ret = thp_dev_open();
        if (ret < 0)
        {
            CTS_THP_LOGE("Open thp device failed");
            return -1;
        }
    }

    ret = cts_prework();
    if (ret < 0)
    {
        CTS_THP_LOGE("Do prework failed");
        return -1;
    }

#ifdef DEBUG_SOCKET_TOOL
    cts_tool_start_thread();
#endif

    ret = thp_dev_set_block(1);
    if (ret < 0)
    {
        ret = thp_dev_set_block(1);
        if (ret < 0)
        {
            CTS_THP_LOGE("Set block 1 failed");
            return -1;
        }
    }

    thp_ioctl_clear_frame_buffer(1);
    ret = thp_ioctl_hal_set_afe_status(2, 0, 0);
    if (ret < 0)
    {
        ret = thp_ioctl_hal_set_afe_status(2, 0, 0);
        if (ret < 0)
        {
            CTS_THP_LOGW("Set afe status 2,0,0 failed");
            return -1;
        }
    }
    thp_ioctl_set_irq(1);
    ret = thp_ioctl_set_timeout(DAEMON_GET_DATA_TIME_OUT_IDLE);
    if (ret)
    {
        ret = thp_ioctl_set_timeout(DAEMON_GET_DATA_TIME_OUT_IDLE);
        if (ret)
            CTS_THP_LOGE("Set timeout failed failed: rc=%d", ret);
    }
    cts_normal_mode_init();

    //cts_tcs_enable_mnt();
    return 0;
}

int cts_stop(void)
{
    int ret;
    ret = cts_postwork();
    if (ret < 0)
    {
        CTS_THP_LOGE("Do postwork failed");
    }

    ret = thp_dev_close();
    if (ret < 0)
    {
        ret = thp_dev_close();
        if (ret < 0)
            CTS_THP_LOGE("Close thp device failed");
    }
    thp_ioctl_clear_frame_buffer(1);
    return 0;
}

void cts_print_fw_status(CTS_FRAME_STRUCT *frame)
{
    // CTS_THP_LOGI("cur short mode=%d",frame->points[100]);
    // CTS_THP_LOGI("index=%d,type=%x,size=%d,afe_status=%x",frame->index,frame->frame_type,frame->curr_frame_size,frame->afe_status);
    CTS_THP_LOGI("finger1=%d,finger2=%d, finger3=%d",frame->finger_noise[0],frame->finger_noise[1],frame->finger_noise[2]);
//     CTS_THP_LOGI("gesture_status=%x,stylus_status=%x,data_type=%x,data_len=%d",frame->gesture_status,frame->stylus_status,frame->data_type,frame->data_len);
// #ifdef CTS_FW_DUMP_INFO
//     if ((frame->frame_index % FRAME_NUM_TO_PRINT == (FRAME_NUM_TO_PRINT - 1)))
//     {
//         CTS_THP_LOGI("frame_index=%d",frame->frame_index);
//         CTS_ID_INFO_STRUCT *id = (CTS_ID_INFO_STRUCT *)frame;
//         for (int i = 0; i < CTS_ID_NUM; i++)
//         {
//             CTS_THP_LOGI("ID=%d,dbg_cnt=%d,job_id=%d,ddi_line_num=%d,ddi_vsync_cnt=%d,ddi_tps_cnt=%d",\
//                      i,(id+i)->dbg_cnt,(id+i)->job_id,(id+i)->ddi_line_num,(id+i)->ddi_vsync_cnt,(id+i)->ddi_tps_cnt);
//         }
//         CTS_FW_DUMP_INFO_STRUCT *dump_info = (CTS_FW_DUMP_INFO_STRUCT *)frame;
//         CTS_THP_LOGI("mstr_scan_go_err0_sts=0x%08x",dump_info->mstr_scan_go_err0_sts);
//         CTS_THP_LOGI("mstr_scan_go_err1_sts=0x%08x",dump_info->mstr_scan_go_err1_sts);
//         CTS_THP_LOGI("slave_scan_go_err0_sts=0x%08x",dump_info->slave_scan_go_err0_sts);
//         CTS_THP_LOGI("slave_scan_go_err1_sts=0x%08x",dump_info->slave_scan_go_err1_sts);
//         CTS_THP_LOGI("mstr_dmct_go_err0=0x0x%08x",dump_info->mstr_dmct_go_err0);
//         CTS_THP_LOGI("mstr_dmct_go_err1=0x%08x",dump_info->mstr_dmct_go_err1);
//         CTS_THP_LOGI("slave_dmct_go_err0=0x%08x",dump_info->slave_dmct_go_err0);
//         CTS_THP_LOGI("slave_dmct_go_err1=0x%08x",dump_info->slave_dmct_go_err1);
//         CTS_THP_LOGI("ddi_r_0A=0x%02x",dump_info->ddi_r_0A);
//         CTS_THP_LOGI("ddi_fsm_state=0x%02x",dump_info->ddi_fsm_state);
//     }
// #endif
}

static bool cts_enter_spec_mode(void)
{
    if (nonblock == SCREEN_OFF_FLAG)
    {
        CTS_THP_LOGI("Get frame with nonblock or tui mode");
        return true;
    }
    return false;
}

/*
struct timeval
{
__time_t  tv_sec;        // Seconds.
__suseconds_t  tv_usec;  // Microseconds.
};

*/

THP_AFE_FRAME_DATA_STRUCT *cts_get_frame(void)
{
    CTS_FRAME_STRUCT *cts_frame;
	TIME_T start_tv;
    long elapsed_ms;
    int ret = -1;
    uint32_t count = 0;

    gettimeofday(&start_tv, NULL);

    //CTS_THP_LOGE("get_frame + ");

    ret = thp_ioctl_get_frame_count(&count);
    if (ret)
    {
        CTS_THP_LOGE("Get frame count failed");
    }
    else if (count > 0)
    {
        CTS_THP_LOGI("driver busy. get_frame_count=%d", count);
    }

    ret = cts_ioctl_get_frame(&g_ioctl_frame);
    if (ret)
    {
        CTS_THP_LOGE("Get frame from kernel failed");
        goto end_get_frame;
    }

    // CTS_THP_LOGE("check_frame + ");
    ret = cts_check_ioctl_frame(&g_ioctl_frame);
    if (ret)
    {
        CTS_THP_LOGE("Invalid frame check, ret:%d", ret);
        goto end_get_frame;
    }

    cts_frame = (CTS_FRAME_STRUCT *)&g_ioctl_frame.frame;
    current_afe_data_type = cts_frame->frame_type;

    if ( cts_frame->frame_type == FRAME_TYPE_FINGER_0 || cts_frame->frame_type == FRAME_TYPE_FINGER_1 )
    {
        tcs_cmd_delay_start();
    }

#ifdef DEBUG_SOCKET_TOOL
    cts_frame->magic_number = cts_frame->magic_number & 0xFFFF0000;
    cts_frame->magic_number |= cts_frame->frame_index;
    cts_tool_send_data_to_client(cts_frame);
    cts_tool_save_frame_data(cts_frame);
#endif

    //cts_print_rawdata(cts_frame->rawdata);

    if(0)
    cts_print_fw_status(cts_frame);
    

    // ret = cts_convert_frame(&start_tv,cts_frame,(CTS_FRAME_FINGER_STYLUS_STRUCT *)g_ioctl_frame.frame,&g_thp_frame,&g_stylus_frame);
    ret = cts_convert_frame(&g_ioctl_frame.tv,cts_frame,(CTS_FRAME_FINGER_STYLUS_STRUCT *)g_ioctl_frame.frame,&g_thp_frame,&g_stylus_frame);
    if (ret)
    {
        CTS_THP_LOGE("Convert frames failed");
        goto end_get_frame;
    }

end_get_frame:
    elapsed_ms = ELAPSED_MS(start_tv);
    if (ret == 0)
    {
        //CTS_THP_LOGE("Get frame OK,cost %lldms", elapsed_ms);
        return &g_thp_frame;
    }else{        
        if ( cts_enter_spec_mode() )
            return NULL;

        cts_print_fw_status(cts_frame);
        if (elapsed_ms < GET_FRAME_TIMEOUT_MS)
        {
            CTS_THP_LOGE("Get frame error,cost %lldms", elapsed_ms);
        }else{
            CTS_THP_LOGE("Get frame failed timeout, time: %dms", elapsed_ms);
        }
    }

    return NULL;
}

int cts_clear_status(THP_AFE_STATUS_ENUM status)
{
    CTS_THP_LOGD("Clear status=0x%4x", status);
    //yjl
    cts_tcs_clear_status(status);
	
    return 0;
}

void cts_screen_on_off_setflag(int flag)
{
    nonblock = flag;
}

int cts_screen_off(void)
{
    int ret;
    cts_screen_on_off_setflag(SCREEN_OFF_FLAG );
    cts_normal_mode_init();
    g_esd_flag = false;

    // cts_tool_start_gesture_data_thread();
    thp_ioctl_clear_frame_buffer(1);

    ret = thp_dev_set_block(0);
    if (ret < 0)
    {
        CTS_THP_LOGE("Set block 0 failed");
        return -1;
    }
    return 0;
}

int cts_screen_on(void)
{
    int ret;
    bBaseDone = false;
    u16BaseSave = 0;
    bBaseRetry = false;
    bBaseGet =false;
    cts_screen_on_off_setflag(SCREEN_ON_FLAG );
    // cts_tool_stop_gesture_data_thread();
    if (cts_NeedUpgradeCheck())
    {
        ret = cts_DoUpgrade();
        if (ret < 0)
        {
            CTS_THP_LOGE("Update firmware failed");
            return -1;
        }
    }

    ret = thp_ioctl_clear_frame_buffer(1);
    if (ret < 0)
    {
        CTS_THP_LOGI("Clear frame buffer failed");
    }

    ret = thp_dev_set_block(1);
    if (ret < 0)
    {
        ret = thp_dev_set_block(1);
        if (ret < 0)
        {
            CTS_THP_LOGE("Set block 0 failed");
            return -1;
        }
    }

    ret = thp_ioctl_hal_set_afe_status(2, 0, 0);
    if (ret < 0)
    {
        CTS_THP_LOGW("Set afe status 2,0,0 failed");
    }

    thp_ioctl_set_irq(1);
    ret = thp_ioctl_set_timeout(DAEMON_GET_DATA_TIME_OUT_IDLE);
    if (ret)
    {
        ret = thp_ioctl_set_timeout(DAEMON_GET_DATA_TIME_OUT_IDLE);
        if (ret)
            CTS_THP_LOGE("Set timeout failed failed: rc=%d", ret);
    }

    cts_normal_mode_init();
    //cts_tcs_enable_mnt();

    return 0;
}


int cts_set_idle_touch_threshold(uint16_t threshold)
{

return 0;

#ifdef  MNT_EXIT_THD_DEFINED_BY_FW
    return 0;

#elif  (defined DECREASE_MNT_CMD)
    // Decrease cmd for DP416
    CTS_THP_LOGE("default--invalid");
    return 0;
#else
    MntOptions options;
    int rc;

    rc = cts_tcs_get_mnt_options(&options);
    if (rc)
    {
        CTS_THP_LOGE("Get monitor options failed: rc=%d", rc);
        return -1;
    }

    /*
        CTS_THP_LOGD("baseTraceMntEn: %d", options.baseTraceMntEn);
        CTS_THP_LOGD("reportRateDownRatio: %d", options.reportRateDownRatio);
        CTS_THP_LOGD("CfbAdjMnt: %d", options.CfbAdjMnt);
        CTS_THP_LOGD("CycleNumMnt: %d", options.CycleNumMnt);
        CTS_THP_LOGD("MntTpTh: %d", options.MntTpTh);
        CTS_THP_LOGD("EnterMntCnt: %d", options.EnterMntCnt);
        CTS_THP_LOGD("Vstim0LevelMnt: %d", options.Vstim0LevelMnt);
        CTS_THP_LOGD("ShiftNumMnt: %d", options.ShiftNumMnt);
        CTS_THP_LOGD("MntToNormalCnt: %d", options.MntToNormalCnt);
    */

    options.MntTpTh = threshold;
    CTS_THP_LOGD("Set idle threshold: %d", options.MntTpTh);
    rc = cts_tcs_set_mnt_options(&options);
    if (rc)
    {
        CTS_THP_LOGE("Set monitor options failed: rc=%d", rc);
        return -1;
    }
    return 0;
#endif
}


int cts_set_baseline_update_interval(uint16_t interval)
{

return 0;

#ifdef  MNT_EXIT_THD_DEFINED_BY_FW
    return 0;
#elif  (defined DECREASE_MNT_CMD)
    // Decrease cmd for DP416
    CTS_THP_LOGE("default--invalid");
    return 0;
#else

    MntOptions options;
    int rc;
    rc = cts_tcs_get_mnt_options(&options);
    if (rc)
    {
        CTS_THP_LOGE("Get monitor options failed: rc=%d", rc);
        return -1;
    }

    /*
        CTS_THP_LOGD("baseTraceMntEn: %d", options.baseTraceMntEn);
        CTS_THP_LOGD("reportRateDownRatio: %d", options.reportRateDownRatio);
        CTS_THP_LOGD("CfbAdjMnt: %d", options.CfbAdjMnt);
        CTS_THP_LOGD("CycleNumMnt: %d", options.CycleNumMnt);
        CTS_THP_LOGD("MntTpTh: %d", options.MntTpTh);
        CTS_THP_LOGD("EnterMntCnt: %d", options.EnterMntCnt);
        CTS_THP_LOGD("Vstim0LevelMnt: %d", options.Vstim0LevelMnt);
        CTS_THP_LOGD("ShiftNumMnt: %d", options.ShiftNumMnt);
        CTS_THP_LOGD("MntToNormalCnt: %d", options.MntToNormalCnt);
    */

    options.MntToNormalCnt = (uint16_t)(60 * interval / 1000);
    CTS_THP_LOGD("Set intverval %d to %d", interval, options.MntToNormalCnt);

    rc = cts_tcs_set_mnt_options(&options);
    if (rc)
    {
        CTS_THP_LOGE("Set monitor options failed: rc=%d", rc);
        return -1;
    }

    return 0;
#endif

}

int cts_enter_idle(void)
{

 //return 0;

#ifdef DISABLE_IDLE
    CTS_THP_LOGI("Enter idle invalid");
    return 0;
#else
    int rc;

    CTS_THP_LOGI("Enter idle+");

    //CTS_THP_LOGD("Set idle timeout  %d ms before real idle",DAEMON_GET_DATA_TIME_OUT_IDLE);
    rc = thp_ioctl_set_timeout(DAEMON_GET_DATA_TIME_OUT_IDLE);
    if (rc)
    {
        CTS_THP_LOGE("Set timeout failed failed: rc=%d", rc);
        return -1;
    }

    rc = cts_tcs_force_enter_mnt();
    if (rc)
    {
        CTS_THP_LOGE("Enter monitor mode failed: rc=%d", rc);
        return -1;
    }
    //CTS_THP_LOGD("Enter idle-");
    return 0;
#endif
}

int cts_exit_idle(void)
{
    int rc =0;

    //CTS_THP_LOGD("Exit idle");
    rc = cts_tcs_force_exit_mnt();
    if (rc)
    {
        CTS_THP_LOGE("Exit monitor mode failed: rc=%d", rc);
        return -1;
    }
    //CTS_THP_LOGD("Set active timeout value after real active");
    return 0;
}


int cts_force_to_freq_point(uint8_t index)
{
    if (index >= 0 && index < MAX_NUM_SCAN_FREQ)
    {
        //yjl update
        return cts_tcs_set_scan_freq(index);
    }
    return -1;
}

//yjl
int cts_freq_shift_switch(uint8_t enable)
{
    return cts_tcs_freq_shift_switch(enable);
}

bool cts_afe_is_esd_triggered(void)
{
    if (g_esd_flag)
    {
        CTS_THP_LOGE("esd happened, report one time!!!");
        return false;
    }
    g_esd_flag = (g_thp_frame.status & 0x40) == 0x40;
    return g_esd_flag;
}
